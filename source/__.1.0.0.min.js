"undefined"==typeof __&&(__={});__.Async=function(a){var b="Async"+ ++__.Async.ix;a=a||{};a.__guid_async__=b;return __.Async.store[b]=new __.Async.Promise(a)};__.Async.ix=0;__.Async.store={};__.Async.fnerr=function(a,b){console.log("[error]",a,b)};__.Async.fnstat=function(){};__.Async.promise=function(a){if("object"==typeof a&&a.__guid_async__)var b=__.Async.store[a.__guid_async__];else b=new __.Async,a&&a.cb&&(b.__cb__=a.cb);b.bLateArrivals=!0;return b};
__.Async.Promise=function(a){this.__guid_async__=a.__guid_async__;this._sStatus="idle";this._args=a;this._loTasks=[];this._bDebug=!1;this.ctx=a&&a.ctx?a.ctx:window;this.sLabel=a&&a.sLabel?a.sLabel:this.__guid_async__;this.sFile=a&&a.sFile?a.sFile:"na";this.fnerr=a&&a.fnerr?a.fnerr:__.Async.fnerr;this.fnstat=a&&a.fnstat?a.fnstat:__.Async.fnstat;return this};
__.Async.Promise.prototype={c:0,ix:0,bLateArrivals:!1,debug:function(){this._bDebug=!0;return this},clear:function(){var a=this;this._add({ctx:this.ctx,sfn:function(){a._args={__guid_async__:a.__guid_async__};a.resolve()},args:{}});return this},pause:function(a,b){var c=this;this._add({ctx:this.ctx,sfn:function(){setTimeout(function(){c.resolve()},a)},args:{},sMsg:b||"pause"});return this},wait:function(a,b,c){var d=this,e="number"==typeof b?b:25;this._add({ctx:this.ctx,sfn:function(){var b=function(){a()?
d.resolve():setTimeout(b,e)};b()},args:{},sMsg:"string"==typeof b?b:c?c:"wait"});return this},then:function(a,b,c,d){this._add({ctx:"object"==typeof a?a:this.ctx,sfn:"object"==typeof a?b:a,args:"string"==typeof b?"object"==typeof c?c:{}:b?b:{},sMsg:"object"==typeof c?d:"string"==typeof c?c:"string"==typeof b?b:""});return this},_add:function(a){this.c++;a.__guid_async__=this.__guid_async__;if(this.bLateArrivals){a.bLateArrival=!0;var b=this._loTasks.length;if(b){for(var c=0;c<b;c++){var d=!1;if(!this._loTasks[c].bLateArrival){d=
!0;this._loTasks.splice(c,0,a);break}}d||this._loTasks.push(a)}else this._loTasks.push(a)}else this._loTasks.push(a)},_stats:function(a){var b=this.fnstat;this._bDebug&&(b=function(a){console.log(a.__guid_async__+" ("+a.ix+"/"+a.c+") -> "+a.sMsg)});b&&b({__guid_async__:this.__guid_async__,sMsg:a||"",c:this.c,ix:this.ix,pct:100*this.ix/this.c})},_next:function(){var a=this._loTasks.shift();this.scurMsg=a.sMsg;this.ix++;this._stats(a.sMsg);for(var b in a.args){var c=a.args[b];if("object"==typeof c&&
c&&c.arg){var d=c.arg.split(".");c=this._args;d.forEach(function(a){c=c[a]})}this._args[b]=c}if("string"==typeof a.sfn)a.ctx[a.sfn](this._args);else a.sfn.call(a.ctx,this._args)},start:function(){this._sStatus="pending";this._next();return this},resolve:function(a){this.bLateArrivals=!1;this._loTasks.forEach(function(a){a.bLateArrival=!1});for(var b in a)this._args[b]=a[b];0<this._loTasks.length?this._next():(this._sStatus="idle",this._cleanUp(),this.__cb__&&this.__cb__(a))},stop:function(){this._cleanUp()},
reject:function(a){var b=function(a){try{return a?JSON.stringify(a):"na"}catch(f){return"could not stringify"}};this._sStatus="error";var c="string"==typeof a?a:"object"==typeof a?a.sError?a.sError:"A task was rejected":"A task was rejected",d="label:["+this.sLabel+"] ";d+="file:["+this.sFile+"] ";d+="task:["+this.scurMsg+"] ";d+="args:("+b(this._args)+") ";d+="xError:("+b(a)+")";a={ix:this.ix,sError:c,sLabel:this.sLabel,sFile:this.sFile,sErrorTask:this.scurMsg,args:this._args,xError:a,sStack:d};
this.fnerr&&this.fnerr(a)},_cleanUp:function(){this._bDebug||delete __.Async.store[this.__guid_async__]}};
"undefined"==typeof __&&(__={});__.dn_=function(a,b,d){var c="object"==typeof b?b:document;b="function"==typeof b?b:d;d="querySelectorAll";if(/^.[a-zA-Z0-9_-]*$/.test(a)){var e=a.substr(0,1);"#"==e?(d="getElementById",a=a.substr(1)):"."==e?(d="getElementsByClassName",a=a.substr(1)):/[a-zA-Z]/.test(e)&&(d="getElementsByTagName")}a=c[d](a);if(a=HTMLCollection.prototype.isPrototypeOf(a)?[].slice.call(a):a)if(b&&this.dn.each(a,b),c=a.length,!isNaN(c)){if(1==c)return a[0];if(0==c)return null}return a};
__._dn=function(a,b,d){a=b.closest(a);d&&this.dn.each(a,d);return a};
__.dn={each:function(a,b){if(a){a=isNaN(a.length)?[a]:a;for(var d=a.length,c=0;c<d;c++)b(a[c],c)}},del:function(a){a.parentNode.removeChild(a)},append:function(a,b,d){return __.dn._add_(a,b,d,"move")},prepend:function(a,b){b.firstChild?this.before(a,b.firstChild):this.append(a,b)},before:function(a,b,d){return __.dn._add_(a,b,d,"_move")},after:function(a,b,d){return __.dn._add_(a,b,d,"move_")},show:function(a){var b=a.hasAttribute("__.display")?a.getAttribute("__.display"):"block";a.style.display=
b},hide:function(a){if("none"!=a.style.display){var b=getComputedStyle(a).display;a.setAttribute("__.display",b);a.style.display="none"}},ix:function(a){for(var b=0;null!=(a=a.previousElementSibling);)b++;return b},x:function(a,b){if(b)/absolute|fixed/.test(self.getComputedStyle(a).position)||(a.style.position="absolute"),a.style.left=parseInt(b)+"px";else return a.getBoundingClientRect().left},y:function(a,b){if(b)/absolute|fixed/.test(self.getComputedStyle(a).position)||(a.style.position="absolute"),
a.style.top=parseInt(b)+"px";else return a.getBoundingClientRect().top},dx:function(a,b){if(b)a.style.width=parseInt(b)+"px";else return a.getBoundingClientRect().width},dy:function(a,b){if(b)a.style.height=parseInt(b)+"px";else return a.getBoundingClientRect().height},fade_:function(a,b,d){var c="function"==typeof b?b:d,e=25/("number"==typeof b?b:250);a.style.opacity=a.style.opacity||1;(function g(){0>(a.style.opacity-=e)?(__.dn.hide(a),c&&c()):setTimeout(g,25)})()},_fade:function(a,b,d){var c="function"==
typeof b?b:d,e=25/("number"==typeof b?b:250);a.style.opacity=a.style.opacity||0;__.dn.show(a);(function g(){var b=Number(a.style.opacity)+e;a.style.opacity=b;1<b?(a.style.opacity=1,c&&c()):setTimeout(g,25)})()},css:function(a,b,d){if(!d)return self.getComputedStyle(a)[b];a.style[b]=d},h:function(a,b){b=b.toString()||"";var d=document.createElement("div");d.appendChild(document.createTextNode(b));a.innerHTML=d.innerHTML},_move:function(a,b){a instanceof Array?this.each(a,function(a){b.parentNode.insertBefore(a,
b)}):b.parentNode.insertBefore(a,b)},move:function(a,b){a instanceof Array?this.each(a,function(a){b.appendChild(a)}):b.appendChild(a)},move_:function(a,b){a instanceof Array?this.each(a,function(a){b.parentNode.insertBefore(a,b.nextSibling);b=a}):b.parentNode.insertBefore(a,b.nextSibling)},_add_:function(a,b,d,c){var e="object"==typeof b?b:document.body;b="function"==typeof b?b:d;var f=document.createElement("div");"string"==typeof a?f.innerHTML=a:a.length?this.each(a,function(a){f.appendChild(a)}):
f.appendChild(a);a=[].slice.call(f.children);a=a instanceof Array&&1==a.length?a[0]:a;b&&this.each(a,b);__.dn[c](a,e);return a}};__.dn.scroll={};__.dn.scroll.to=function(a,b,d){var c="string"==typeof a?document.body:a;d="number"==typeof b?b:d;switch("string"==typeof a?a:b){case "x":c.scrollLeft=d;break;case "y":c.scrollTop=d;break;case "bottom":c.scrollTop=c.scrollHeight;break;case "top":c.scrollTop=0;break;case "left":c.scrollLeft=0;break;case "right":c.scrollLeft=c.scrollWidth}};
__.dn.scroll.on=function(a,b,d){var c="function"==typeof a?document:a,e="function"==typeof a?a:b,f="number"==typeof b?b:d?d:300;c.__cbScroll=function(){c=c==document?document.body:c;c.__hd&&clearInterval(c.__hd);c.__hd=setTimeout(function(){var a=c.scrollHeight,b=c.scrollTop,d=c.clientHeight,f=c.scrollWidth,h=c.scrollLeft,k=c.clientWidth;e({x:a,y:f,dy:k,dx:d,bTop:0==b,bBottom:a==b+d,bLeft:0==h,bRight:f==h+k})},f)};c.addEventListener("scroll",c.__cbScroll)};
__.dn.scroll.off=function(a){a=a||document;a.removeEventListener("scroll",a.__cbScroll)};
// ==ClosureCompiler==
// @compilation_level ADVANCED_OPTIMIZATIONS
// @output_file_name __.class.min.js
// @jscomp_off es5Strict
// @js_externs var __; __.Class; __.Class.instantiate; __.Class.extend; __.Class.mixin; __.Class._super;
// ==/ClosureCompiler==

/**
 * @namespace __
 */
if( typeof __ == "undefined" ) {
	__ = {};
}

/**
 * @namespace __.Class
 * @memberof __
 */
__.Class = function() {};
__.Class.prototype.construct = function() {};

/**
 * Creates a new class by extending from the base class (__.Class) or
 * inheriting from an existing class.<br>
 * If the class has a method called "init" it will invoke it on creation of an instace.<br>
 * In case of inheritance you can call a parent's method by using the "_super" method.<br>
 * Static attributes and methods are created by appending to the class constructor function.
 * @memberof __.Class
 * @method extend
 * @example // a base class
 * var Person = __.Class.extend( {
 *      sName : null
 *    , init : function( args ) {
 *         this.sName = args.sName;
 *         Person.cPerson++;
 *    }
 *    , say : function() {
 *       return "My name is " + this.sName;
 *    }
 * } );
 * // static attribute
 * Person.cPerson = 0
 * // static function
 * Person.report = function() {
 *     return Person.cPerson + " person(s) created";
 * }
 * var tom = __.Class.instantiate( Person, { sName : "Tom" } );
 * tom.say(); // "My name is Tom"
 * Person.report(); // "1 person(s) created"
 * @example // an extended class
 * var Soldier = Person.extend( {
 *    salute : function() {
 *       return this.say() + ", Sir";
 *    }
 * } );
 * var tom = __.Class.instantiate( Soldier, { sName : "Major Tom" } );
 * tom.salute(); // "My name is Major Tom, Sir"
 * Person.report(); // "2 person(s) created"
 * @returns {Object} class object to chain loading of mixins
 */
__.Class.extend = function( o ) {
	var that = this;
	var oNew = function() {
		if (arguments[ 0 ] !== __.Class) {
			// call constructor if not base 
			this.construct.apply( this, arguments ); 
		}
	};
	// get prototype and hook to parent
	var oPrototype = new this( __.Class );
	// save link to parent's prototype
	var oParent = this.prototype;
	for (var sMember in o) {
		var oMember = o[sMember];
		if (oMember instanceof Function) {
			oMember.oParent = oParent;
			// in case we override add method
			// _super() to call parent's function
			/**
			 * Provides a hook into the parent's object to call the overridden (super) method.<br />
			 * NB: Since we use callee/caller this will not work in xtrict mode.
			 * @memberof __.Class
			 * @method _super
			 * @instance
			 * @param {String} [sMethod] Name of the parent method
			 * @example
			 * var Person = __.Class.extend( {
			 *    say : function() {
			 *       return "Hi";
			 *    }
			 * } );
			 * var Player = Person.extend( {
			 *    say : function() {
			 *       return this._super( "say" ) + ", Teammate";
			 *    }
			 * } );
			 * var player = __.Class.instantiate( Player );
			 * player.say(); // "Hi, Teammate"
			 */
			oPrototype.oParent = oParent;
			oPrototype._super= function( sMethod ) {
				var oCaller = arguments.callee.caller;
				// method context == this
				var ctx = this;
				// methods arguments == arguments
				var args = oCaller.arguments;
				return args.callee.oParent[ sMethod ].apply( ctx, args )
			};
		}
		// augment with members
		oPrototype[ sMember ] = oMember;
	}
	// set the prototype
	oNew.prototype = oPrototype;
	// set method for mixins
	/**
	 * Mixes in additional behaviour to the class. It expects plain objects in the
	 * arguments (Other class objects cannot be mixed in).
	 * Mixin object members will not overwrite class members in case of same
	 * method or attribute names.
	 * @memberof __.Class
	 * @method mixin
	 * @param {Object} objects Any number of objects to be mixed in.
	 * @example
	 * var Minecraft = {
         *       say : function() {
	 *         return "Mojang";
	 *     }
	 *     , craft : function() {
	 *         return "wooden sword";
	 *     }
	 * };
	 * var Ingress = {
         *       say : function() {
	 *         return "Ingress";
	 *     }
	 *     , capture : function() {
	 *         return "portal green";
	 *     }
	 * };
	 * var Player = __.Class.extend( {
	 *     say : function() {
	 *        return "Hi";
	 *     }
	 * }).mixin( Minecraft, Ingress );
	 * var player = __.Class.instantiate( Player );
	 * player.say(); // Hi
	 * player.craft(); // wooden sword
	 * player.capture(); // portal green
	 */
	oNew.mixin = function() {
		var loMixins = [].slice.call( arguments );
		loMixins.forEach( function( oMixin ) {
			for( var sMember in oMixin ) {
				if( ! oPrototype[ sMember ] ) {
					oPrototype[ sMember ] = oMixin[ sMember ];
				} 
			}	
		} );	
		return this;
	}
	// make it extendable
	oNew.extend = this.extend;
	// and return it
	return oNew;
};

/**
 * Creates a new instance of a class.
 * @memberof __.Class
 * @method instantiate
 * @example Person = __.Class.extend( {
 *      sName : null
 *    , init : function( args ) {
 *       this.sName = args.sName;
 * }
 *    , say : function() {
 *       return "Hi, I am " + this.sName;
 *    }
 * } );
 * tim = __.Class.instantiate( Person, { sName : "Tim" } );
 * tim.say(); // Hi, I am Tim
 * @returns {Object} instance of a class object
 */
__.Class.instantiate = function() {
	// create new instance
	var oClass = arguments[0];
	var args = arguments[1];
	var oInstance = new oClass( args );
	// call init function if exists
	if( oInstance.init ) {
		oInstance.init( args );
	}
	return oInstance;
};

"undefined"==typeof __&&(__={});
__.Event={oListeners:{},sEvent:function(a){var c=[];a.split(" ").forEach(function(a,b){a&&c.push(a.substr(0,1).toUpperCase()+a.substr(1))});return"on"+c.join("")},listen:function(){var a=this,c=Array.prototype.slice.call(arguments),d=c.shift();c.forEach(function(b){b=a.sEvent(b);a.oListeners[b]||(a.oListeners[b]=[]);a.oListeners[b].push(d)})},trigger:function(a,c){a=this.sEvent(a);var d=this.oListeners[a];d&&d.forEach(function(b){if("function"==typeof b[a])b[a](c);else console.warn("listener has no trigger receiver: "+
a)})}};
"undefined"==typeof __&&(__={});
__.s={o:function(a){try{return JSON.parse(a)}catch(b){return null}},empty:function(a){a="string"==typeof a?a.trim():null;return""===a},camelCase:function(a){var b=[];a.split(" ").forEach(function(a,c){a&&b.push(a.substr(0,1).toUpperCase()+a.substr(1))});return b.join(" ")},unCamelCase:function(a){a=a.replace(/([A-Z])([a-z])/g," $1$2");a=a.replace(/([a-z])([A-Z])/g,"$1 $2");return a.trim()},tokenize:function(a,b){return b&&"simple"!=b?a:(a=a.replace(/\s/g,""),a=a.replace(/'/g,""),a=a.replace(/"/g,
""),a.toLowerCase())},sanitize:function(a){return a.replace(/<(?:.|\n)*?>/gm,"")}};__.n={within:function(a,b){a=a<b[0]?b[0]:a;return a=a>b[1]?b[1]:a}};__.l={del:function(a,b){var d=a.indexOf(b);-1<d&&(a.splice(d,1),__.l.del(a,b))},contains:function(a,b){return-1<a.indexOf(b)},equal:function(a,b){return a.join("-")===b.join("-")},empty:function(a){return"[]"===__.o.s(a)},kSort:function(a,b){return a.sort(function(a,c){return a.hasOwnProperty(b)?c.hasOwnProperty(b)?a[b]-c[b]:0:1})}};
__.o={s:function(a){try{return JSON.stringify(a)}catch(b){return null}},k:function(a){for(var b in a)return b;return null},kk:function(a){if(Object&&Object.keys)return Object.keys(a);var b=[],d;for(d in a)b.push(d);return b},add:function(a,b){if(a&&b)for(var d in b)a[d]=b[d]},kRename:function(a,b,d){try{Object.defineProperty(a,d,Object.getOwnPropertyDescriptor(a,b)),delete a[b]}catch(c){console.warn("kRename: o is no object")}},c:function(a){var b=0,d;for(d in a)a.hasOwnProperty(d)&&++b;return b},
copy:function(a){try{return JSON.parse(JSON.stringify(a))}catch(b){return null}},struc:function(a){function b(a,c){for(var g in a)if(a[g]&&a[g].sort&&a[g].sort(d).sort(),a.hasOwnProperty(g)){var e=c?".":"";f.push(c+e+g);"object"==typeof a[g]&&b(a[g],c+e+g)}}var d=function(a,b){a=a&&a.sort?a.sort():a;b=b&&b.sort?b.sort():b;return a>b},c=__.o.s(a);a=c.length;(c=__.s.o(c))&&c.sort&&c.sort(d).sort();var f=[];b(c,"");return{o:c,nLength:a,lsStruc:f.sort()}},equal:function(a,b){return __.o._compare_(a,b).b},
diff:function(a,b){var d=__.o._compare_(a,b);if(d.b)return null;a=__.o._compare_(b,a);return{o1:d.ldiff,o2:a.ldiff}},_compare_:function(a,b){var d=!0,c=[],f=__.o.struc(a),k=__.o.struc(b);f.nLength!==k.nLength&&(c.push(["length",,f.nLength,k.nLength]),d=!1);f.lsStruc.forEach(function(a){for(var b=f.o,e=k.o,l=a.split("."),h=0;h<l.length;h++)if(b=b?b[l[h]]:b,e=e?e[l[h]]:e,typeof b!==typeof e){c.push(["type",a,b,e]);d=!1;break}else if("undefined"===typeof e){c.push(["miss",a,b,e]);d=!1;break}else b instanceof
Date||b instanceof Function?(b=b.toString().replace(/\s/g,""),e=e.toString().replace(/\s/g,"")):"object"!==typeof b&&b!==e&&(d=!1,c.push(["diff",a,b,e]))});return{b:d,ldiff:c}},empty:function(a){for(var b in a)return!1;return!0}};__.e={stop:function(a){a.stopPropagation();a.preventDefault()}};__.css=function(a){var b=document.createElement("style");document.body.appendChild(b);b.innerHTML=a};__.b={mail:function(a){return/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+[\.]{1}[a-zA-Z]{2,4}$/.test(a)},url:function(a){return/^https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/.test(v)}};
__.cookie={get:function(a){return(a=document.cookie.match("(^|;) ?"+a+"=([^;]*)(;|$)"))?a[2]:null},set:function(a,b,d){var c=new Date;c.setTime(c.getTime()+864E5*d);document.cookie=a+"="+b+";path=/;expires="+c.toGMTString()},del:function(a){__.cookie.set(a,"",-1)}};__.url={oParams:function(a){var b={};(a?a:window.location.href).replace(/[?&]+([^=&]+)=([^&]*)/gi,function(a,c,f){b[c]=f});return b}};
__.dt={date:function(a){var b=a?new Date(a.replace(/\D/g,"-").split("-")):new Date;a=b.getDate();var d="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" ")[b.getDay()];b=b.getMonth();var c="January February March April May June July August September October November December".split(" ")[b];return{nDay:a,sDay:d,sDayShort:d.substring(0,3),nMonth:b,sMonth:c,sMonthShort:c.substring(0,3)}}};
__.misc={isIE:function(){return"Microsoft Internet Explorer"==navigator.appName?!0:"Netscape"==navigator.appName?-1<navigator.appVersion.indexOf("Edge"):!1}};this.Element&&function(a){a.matches=a.matches||a.matchesSelector||a.webkitMatchesSelector||a.msMatchesSelector||function(a){a=(this.parentNode||this.document).querySelectorAll(a);for(var b=-1;a[++b]&&a[b]!=this;);return a[b]?!0:!1}}(Element.prototype);
this.Element&&function(a){a.closest=a.closest||function(a){for(var b=this;b.matches&&!b.matches(a);)b=b.parentNode;return b.matches?b:null}}(Element.prototype);(function(){})();__.win={dx:function(){return window.innerWidth},dy:function(){return window.innerHeight}};
if( typeof( __ ) == "undefined" ) {
	__ = {};
}

__.css( '.-ac-content{background : #fff;z-index : 999;cursor : pointer;border-left : 1px solid #c0c0c0;border-right : 1px solid #c0c0c0;border-bottom : 1px solid #c0c0c0;} .-ac-content .-ac-highlight,.-ac-content .-ac-row:hover{background : #efefef;color : #a0a0a0;} .-ac-content .line{padding : 0.4em;border-bottom : 1px dotted #efefef;} .-ac-content .left img{height : 37px;width : 27px;float : left;} .-ac-content .right{margin-left : 33px;} .-ac-content .right .title{font-weight : bold;font-size : 1.1em;} .-ac-inactive {color : #a0a0a0 !important;cursor : default;} .-ac-loading{background-image: url("data:image/gif;base64,R0lGODlhHwAfAPUgAOjo6NLS0ry8vK6urqKiotzc3Li4uJqamuTk5NjY2KqqqqCgoLCwsMzMzPb29qioqNTU1Obm5jY2NiYmJlBQUMTExHBwcJKSklZWVvr6+mhoaEZGRsbGxvj4+EhISDIyMv///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAgACwAAAAAHwAfAAAG/0CQcEgEBAQDAkhCsRwaxKh0WDAcrlfQZLvVMDpTKUKALWu5XAsnPEwoymY02qNggxbwuJz7CScWIHlYZ3sTdwlRCG8HgVgMDQgOIAAVFxhojQoIRGSDBw8QYRkEG4ZlAlR5IJt2a3kFQlZlDxF2QxEPcAaTeaG2QxB5RnAMv1EMcEdwUMZDDXBIcKzNq3BJcJLUIA5wStrNBNjf3GUEA9LfCNadWMzUz6cBxN/IZQEAvdTBcAAgsli0jOHSJaSAqmlhNr0awo7RJ19TIORqdAXVEEVZyjyKtA1Bg3oZD2iK8oeiKkFZFiCaggelSTiA2LhxiVLBSjZjBL2siNBOFQ84Lw3A+mYEiRJzAu7ZCQIAIfkECQoAIAAsAAAAAB8AHwAABv9AkHBIBAQEAwKIMBAEAMSodFgwHK5XEPZqKEynCMEWqx0fBIjvMKEwZ90HRUINWsAPZffim9jf82YgHwpRCG14WwwNCA4gDggNDFsgExMeHERiZAcPEGoQD3iVlRYdQgWBaXRpo6MMQlZbDxF0QxwbrRMaIABmnrVDBLkTDQFjr8BDGRi5Z2MNyUQXuRYDY6rRIBW5FARjjdm8uRLh2d5b4NkOY0zX5QhjTc/lDWNOx+WSW0++2RBmUGJhmZUsQqgtBk6lqpXGjBchmt50+hQKkAAiht5gUcTIESR9GhVgE9IH0BiTkxbMmWIHDkose9SwcQlHDsOIk9ygiVbl5JgMLuV4HUmypMkTOkEAACH5BAkKACAALAAAAAAfAB8AAAb/QJBwSAQEBAMCiDAQBADEqHRYMByuVxD2aihMpwjBFqsdHwSI7zChMGfdB0VCDVrAD2X34pvY3/NmdXNECG14WwwNCA4gDggNDFtlCmlDYmQHDxBqEA+HWAJUgZVqaWZeIFZbDxF0QxGeWwYgAGabrkMQZkZjDLhRkVtHYw2/RA1jSGOkxghjSWOMxkIOY0rT0wTR2LQT3t4SA8vcFd/eFJdYxdgX5hMWAb3YGRjuB7Vjt78E7hPFqlhY/eKwwZ0GIQVGuUrTz5eQdIc0cfIEwpyFDkMKvcGSaFGjR8GyePPAIUofQGNQSvqg4IsdOCqx7FHDBiYcOQshYjKDxliVDpRjunCjdSTJkiZP6AQBACH5BAkKACAALAAAAAAfAB8AAAb/QJBwSAQEBAMCiDAQBADEqHRYMByuVxD2aihMpwjBFqsdHwSI7zChMGfdB0VCDVrAD2X34pvY3/NmdXNECG14WwwNCA4gDggNDFtlCmlDYmQHDxBqEA+HWAJUgZVqaWZeIFZbDxF0QxGeWwYgAGabrkMQZkZjDLhRkVtHYw2/RA1jSGOkxghjSWOMxkIOY0rT0wTR2I3WA8vczltNxNzIW0693MFYT7bTumNQqlisv7BjsyAFo64cgFdQgbj0RtOXDAQ2TAAUakihN1gSLaJV4QKGCRgXXqEUpQ9ASRlDYhT0xQ4cECJDfqDD5mRKjB4UuArjBmVKC/9+VRljM6MGDwYduBlBokQCBQsHiqkJAgAh+QQJCgAgACwAAAAAHwAfAAAG/0CQcEgEBAQDAogwEAQAxKh0WDAcrlcQ9mooTKcIwRarHR8EiO8woTBn3QdFQg1awA9l9+Kb2N/zZnVzRAhteFsMDQgOIA4IDQxbZQppQ2JkBw8QahAPh1gCVIGVamlmXiBWWw8RdEMRnlsGIABmm65DEGZGYwy4UZFbR2MNv0QNY0hjpMYIY0ljjMZCDmNK09ME0diN1gPL3M5bTcTcyFtOvdzBWE+207pjUKpYrL+wY7MgBYEcrqZjUIG4lGXCBgIZvnT6dCXUkEIFJ0jEcKECFEeQJF2hFKUPCIkgQwIaI+jLh5AoR27Zo0aBB5QgVW4cpIaDBZgTZKL51YGBhg+U+QROQ2aBgoQlTZ7QCQIAIfkECQoAIAAsAAAAAB8AHwAABv9AkHBIBAQEAwKIMBAEAMSodFgwHK5XEPZqKEynCMEWqx0fBIjvMKEwZ90HRUINWsAPZffim9jf82Z1c0QIbXhbDA0IDiAOCA0MW2UKaUNiZAcPEGoQD4dYAlSBlWppZl4gVlsPEXRDEZ5bBiAAZpuuQxBmRmMMuFGRW0djDb9EDWNIY6TGCGNJY4zGQg5jStPTEhPb21DY1VsEFNzbFdggzlsDFuQTF+fIW2LtGBnYwVgBDe0T17+6Y6BoaLeBwy9YY2aBYMAPnStTY1B1YMdNiyZOngCFGsLBwzZAiRY1eoTvE6UoCj4AGrNS0oJBUuzAaYlljxo2M+HIeXiJpRsRNMaq+JSFCpsRJEqYOPH2JQgAIfkECQoAIAAsAAAAAB8AHwAABv9AkHBIBAQEAwKIMBAEAMSodFgwHK5XEPZqKEynCMEWqx0fBIjvMKEwZ90HRUINWsAPZffiq/jkzX9jdXNEHB4TE38MDQgOIA4IDQxbZQppQh0WiIhaDxBqEA94WwJDDJubIJdqaWZeIBqoExscdEMRolsGIA2yE0q2QxBmAAeyGBnBRJNbAZqoF8pEDWMCFLIV0kMIYwMSslDaj2PA4soEY47iDuQDY6vS3FtNYw3m1KQBYwzmzFhPZj5JGzYGipUtDyIowzVmF4gCgOCBCXTgFQgxZA54AiXqT6ltbUZhWdToUSR/Ii1FSbDnDkUyCwhJsQPn5ZU9atjUhCPHVhgTNy/RSKsiqKFFbUaQKGHiJNyXIAAh+QQFCgAgACwAAAAAHwAfAAAG/0CQcEhsHCwUCYgwEAQAxKhU2GFoJlgs6MDlGgrTKceSLW+7XQEiPFR4ymY0WpFggz7wuLy7CCf6eVlnewcgC3VECApcIGUYFxVQDggNDGhnCmtDApcTGwQZYRAPhWgCQwV7IBx2IGt7YCAGcg8RrUIRpGgGIAB7ELdDEHsAAXIMwUSWaAGcaA3JQ0amA3Ka0QhyAwRyDtFCDnIE39HcaN7f4WhM1uTZaE1y0N/TacZoyN/LXU+/0cNyoMxCUytYLjm8QKSS46rVKzmxQDhjdOABMFGkBh04NUQRxS4MGiDwNqnSJS6ZovzRyJAQo0NhFrgs5bIPmwSLCLHsQsfhxBWTe9QkKzCwC8sv5Ho127akyRM7QQAAOw==");background-position-x : 100% !important;background-position-y : 0% !important;background-size : auto 100% !important;background-repeat : no-repeat !important;} ');

__.autocomplete = {
	/* {
		dn : DOM node of input field
		sField : field to use to update input field on select
		hTemplate : Mustache template
		fnFetch : function to fetch data will be called with sTerm and cbfn parameters
		cb : callback on selection
	} */
	  init : function( a ) {
		if( a.dn.tagName !== "INPUT" ) {
			console.warn( "autocomplete missing input field" );
			return;
		}
		if( ! a.hTemplate ) {
		//	console.warn( "autocomplete missing template" );
		//	return;
		}
		if( ! a.fnFetch ) {
			console.warn( "autocomplete missing function to fetch data" );
			return;
		}
		if( a.dn.ix ) {
			// we already attached autocomplete
			return;
		}
		if( ! a.hTemplate ) {
// test this.. class names are not -ac do we need class here at all?
			var h = '<div class="line">';
			h += '<div class="title">{{' + a.sField + '}}</div>';
			h += '</div>';
			a.hTemplate = h;
		}
		a.lsInactive = a.lsInactive || [];
		// first we flag the input field with a classname used to get
		// all active autocompletes e.g. for when the browser resizes
		a.dn.classList.add( "-ac" );
		// add "autocomplete" off for certain field names are
		// automatically added autocomplete (e.g. chrome + "author")
		a.dn.autocomplete = "off";
		// create and assign HTML fragment to DOM node
		a.dnList = __.dn.after( this.hCreate(), a.dn );
		//xxx a.dnList = __.dn.frag( this.hCreate() );
		//xxx __.dn.insertAfter( a.dnList, a.dn );
		// apply events
		this.events( a );
	}
	, msDelay : 500
	, style : function( a ) {
	}
	, fetch : function( a, sTerm ) {
		var that = this;
		if( a.dnList.hdDelay ) {
			clearTimeout( a.dnList.hdDelay );
		}
		a.dnList.hdDelay = setTimeout( function() {
			a.dn.classList.add( "-ac-loading" );
			//xxx __.dn.addClass( a.dn, "-ac-loading" );
			a.fnFetch( sTerm, function( oResult ) {
				if( a.dn.classList.contains( "-ac-active" ) ) {
					that.render( a, oResult );
				}
			} );
		}, that.msDelay );
	}
	, events : function( a ) {
		var that = this;
		a.dn.ix = 0;
		a.dnList.addEventListener( "click", function( e ) {
			__.e.stop( e );
			var dn = e.target;
			if( ! dn.classList.contains( "-ac-row" ) ) {
				//dn = __.dn.up( dn, "className", "-ac-row" );
				dn = __._dn( ".-ac-row", dn );
			}
			var ixRow = __.dn.ix( dn ) + 1;
			that.highlight( a, ixRow );
			that.select( a );
		} );
		a.dn.addEventListener( "keydown", function( e ) {
			if( e.keyCode == "13" ) {
				__.e.stop( e );
				that.select( a );
			}
		} );
		a.dn.addEventListener( "keyup", function( e ) {
			var dn = e.target;
			if( e.keyCode == "38" ) {
				that.highlight( a, Number( a.dn.ix ) - 1 );
			}
			else if( e.keyCode == "40" ) {
				that.highlight( a, Number( a.dn.ix ) + 1 );
			}
			else if( e.keyCode == "27" ) {
				that.close( a, false );
			}
			else {
				// fetch terms from service
				var sTerm = dn.value;
				that.fetch( a, sTerm );
			}
		} );
		a.dn.addEventListener( "blur", function( e ) {
			__.e.stop( e );
			// close if input field loses focus
			// we need to delay this action after a possible
			// click event had been processed
			setTimeout( function() {
				that.close( a, false );
			}, 250 );
		} );
		a.dn.addEventListener( "focus", function( e ) {
			var dn = e.target;
			// we have focus on the node, i.e we can activate
			// the autocomplete
			a.dn.classList.add( "-ac-active" );
			// if the input field gets focus check if we 
			// should perform a query without typing first
			if( a.bInitLoad ) {
				// fetch term, avoiding hint text being used
				var sTerm = ( dn.classList.contains( '-fh-hinted' ) )
					? "" : dn.value;	
				// fetch terms from service
				that.fetch( a, sTerm );
			}
		} );
	}
	, highlight : function( a, ix ) {
console.log( ix );
		a.dn.ix = __.n.within( ix, [ 0, a.c ] );
		var ldnLines = __.dn_( ".-ac-highlight", a.dnList );
		__.each( ldnLines, function( dn ) {
			dn.classList.remove( "-ac-highlight" );
		} );
		if( ldnLines && a.dn.ix > 0 ) {
			var scur = ".-ac-row:nth-child(" + a.dn.ix + ")"; 
			var dncurLine = __.dn_( scur, a.dnList );
			dncurLine.classList.add( "-ac-highlight" );
		}
	}
	, select : function( a ) {
		// default value is blank
		var v = "";
		// if a field name is set...
		if( a.sField ) {
			// first get the index
		    	var ix = a.dn.ix - 1;
			// let check if we have a data object
			if( a.dn.oResult &&
			    a.dn.oResult.length && 
			    a.dn.oResult[ ix ] ) {
				// get selected data object
				var rec = a.dn.oResult[ ix ];
				// ... we update the input field value with it
				v = ( rec ) ? rec[ a.sField ] : "";
			}
		}
		// set value in input field
		if( ! a.bClearOnSelect ) {
			// if not clear on select
			a.dn.value = v;
		}
		else {
			// otherwise blank
			a.dn.value = "";
		}
		// if a callback is set...
		if( typeof a.cb == "function" ) {
			// we invoke it with the entire record object
			a.cb( rec );
		}
		// finally we hide the list
		this.close( a, true );
	}
	, close : function( a, bSelected ) {
//return;
		// remove active class, which also prevents ajax responses
		// still hanging to open it again
		a.dn.classList.remove( "-ac-active" );
		// hide loader
		a.dn.classList.remove( "-ac-loading" );
		// first check if list is already empty
		if( a.dnList.innerHTML == "" ) {
			// in which case it had already been closed
			// we simply return
			return;
		}
		// hide the list
		__.dn.hide( a.dnList );
		// empty it
		a.dnList.innerHTML = "";
		// and reset the highlight index
		a.dn.ix = 0;
		if( ! bSelected ) {
			// blank input field if not just selected
			a.dn.value = "";
		}
		// re-activate hint if set
		if( a.dn.hasAttribute( "ls-hint" ) ) {
			__.formhint.blur( a.dn );
			a.dn.blur();
		}
	}
	, render : function( a, oResult ) {
		// first remove the loading animation
		a.dn.classList.remove( "-ac-loading" );
		// we got some results
		if( oResult && oResult.length ) {
			// set number of results needed for navigation
			a.c = oResult.length;
			// attach the result object to input field for
			// later extraction of selected field
			a.dn.oResult = oResult;
		}
		var h = "{{#lrecs}}" + a.hTemplate + "{{/lrecs}}";
		var aData = {
			  lrecs : oResult
		};
		// construct content with mustache within a wrapper node
		// that is absolute positioned for flyout effect
		var hContent = "<div style='position:absolute' class='-ac-content'>";
		hContent +=  Mustache.to_html( h, aData ) + "</div>";
		// write it into the list node
		a.dnList.innerHTML = hContent;
		// get this content DOM node
		var dnContent = a.dnList.firstChild;
		// and resize to the width of input field
		__.dn.dx( dnContent, __.dn.dx( a.dn ) );
		// next we iterate through all row generated by mustache
		__.each( dnContent.children, function( dn ) {
			// and add a class indicating its a row created
			// by this library, it is used later on
			dn.classList.add( "-ac-row" );
			// next we check if the content is found in the
			// list of inactive terms
			var sText = dn.textContent;
			if( a.lsInactive.indexOf( sText ) > -1 ) {
				// in which case we add according class
				dn.classList.add( "-ac-inactive" );
			}
		} );
		// in case we want to mess with the output before it is
		// shown to the users (e.g. deactivate already selected
		// tags) we can indicate on a callback which is invoked
		// now along with the output DOM node as parameter.
		if( a.render_ ) {
			a.render_( a.dnList );
		}
		// and show it
		__.dn.show( a.dnList );
	}
	, hCreate : function() {
		return '<div style="display:none;position:relative;" class="-ac-list"></div>';
	}
};


// REF: remove __.dn from here were possible, e.g. __.dn.css
// REF: include loading gif that only shows after 500 ms
if( typeof( __ ) == "undefined" ) {
	__ = {};
}

__.lock = {
	  up : function( dn, kv ) {
		// set timeout for we want to ensure this is run
		// after any other rendering is done and we get
		// proper CSS values
		setTimeout( function() {
			var dnBag = dn.lastElementChild;
			// DOM node is empty. In case of a model get call,
			// this means its the first call to the server
			if( ! dnBag ) {
				dnBag = document.createElement( "div" );
				__.dn.css( dnBag, "height", __.dn.css( dn, "minHeight" ) );
				dn.appendChild( dnBag );
			}
			// locking blend (bag) does not exist...
			if( ! dnBag.classList.contains( "-lck-bag" ) ) {
				var hBag = " \
				<div class='-lck-bag'> \
					<div class='-lck-bag-front'></div> \
					<div class='-lck-bag-back'></div> \
				</div> \
				";
				// ...we append and position bag to top by height
				// because if we prepend and have Hx tags then
				// because of top padding entire stone gets shifted down
				
				dnBag = __.dn.append( hBag, dn );
			}
			// adjust height of blend and show
			// dy needs to be the outer height with padding
			var dy = dn.scrollHeight;
			var dnFront = dnBag.firstElementChild;
			dnFront.innerHTML = "";
			if( kv && kv.hText ) {
				setTimeout( function() {
					__.dn.h( dnFront, kv.hText );
					__.dn.y( dnFront, -dy );
					__.dn.dy( dnFront, dy );
				}, 500 );
			}
			var dnBack = dnBag.lastElementChild;
			__.dn.y( dnBack, -dy );
			__.dn.dy( dnBack, dy );
			__.dn.dy( dnFront, dy );
			__.dn.show( dnBag );
		}, 0 );
	}
	, un : function( dn ) {
		// set timeout as a consequence of us using it for locking as well
		setTimeout( function() {
			__.dn_( ".-lck-bag", dn, function( dnBag ) {
				__.dn.del( dnBag );
			} );
		}, 0 );
	}
};

// ==ClosureCompiler==
// @compilation_level ADVANCED_OPTIMIZATIONS
// @output_file_name __.sp.1.0.0.min.js
// @js_externs var __; __.SP; __.SP.ctx
// ==/ClosureCompiler==

/**
 * @version 1.0.0
 * @namespace __
 */
if( typeof __ == "undefined" ) {
	__ = {};
}

/**
 * @namespace __.SP
 * @memberof __
 */


__.SP = {
	/**
	 * Gets a SharePoint context of the current site or a site you
	 * indicate via absolute Url
	 * @memberof __.SP
	 * @method ctx
	 * @example var ctx = __.SP.ctx();
	 * @example var ctx = __.SP.ctx( "https://jarvis.osce.org/sites/sec_ict" );
	 * @param {String} [sSite] Absolute Url of the SharePoint site
	 * @returns {Object} SharePoint site context
	 */
	  ctx : function( sSite ) {
		return ( sSite )
			? new SP.ClientContext( sSite )
			: new SP.ClientContext.get_current();
	}
	/**
	 * Executes an asynchronous call against the server.
	 * <br />
	 * It expects a SharePoint object to be loaded. Optionally you can indicate
	 * a callback function that will be invoked by the returned object or 
	 * an error message and stack in case of failure.
	 * @memberof __.SP
	 * @method exec
	 * @example __.SP.exec( ctx, oItem, function( oItem ) {
	 * 	if( oItem.sError ) {
	 * 		// error case
	 *		// oItem.sError holds the error message
	 * 		// oItem.sInfo holds the error stack
	 *	}
	 * 	else {
	 * 		// success case
	 * 	}
	 * } );
	 * @param {Object} ctx SharePoint site context
	 * @param {Object} oLoad Loaded object to be sent to server
	 * @param {Function} cb Callback function that handles success and error
	 */
	, exec : function( ctx, oLoad, cb ) {
		var cbok = function() {
			if( cb ) {
				cb( oLoad );
			}
		}
		var cberr = function( sender, args ) {
			if( cb ) {
				cb( {
					  sError : args.get_message()
					, sInfo: args.get_stackTrace()
				} );
			}
		}
		ctx.executeQueryAsync(
			  Function.createDelegate( this, cbok )
			, Function.createDelegate( this, cberr )
		);
	}
	/**
	 * Checks if a value is of form of a GUID
	 * @memberof __.SP
	 * @method bGuid 
	 * @example __.SP.bGuid( "12345678-asdf-zxcv-qwwe-1234567890ab" ) // true
	 * @example __.SP.bGuid( "567890ab" ) // false
	 * @example __.SP.bGuid( 321 ) // false
	 * @param {String} guid value of a guid
	 * @returns {Boolean} true or false
	 */
	, bGuid : function( x ) {
		return /^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/.test( x );
	}
};

/**
 * @namespace __.SP.folder
 * @memberof __.SP
 */
__.SP.folder = {
	/**
	 * Creates a folder in a document library
	 * @memberof __.SP.folder
	 * @method create
	 * @example __.SP.folder.create( {
	 * 	  sList : "Shared Documents"
	 * 	, sFolder "test folder"
	 * } );
	 * @param {Object} args a parameter object holding the following values
	 * @param {String} args.sList name of the list
	 * @param {String} args.sFolder name of the folder
	 * @returns {Object} Resolved promise holding the following values 
	 * <pre>
	 * oFolder  | (Object) | context of the newly created folder
	 * idFolder | (Number) | item ID of the newly created folder
	 * </pre>
	 */
	  create : function( args ) { // sList, sFolder
		var async = __.Async.promise( args );
		var ctx = __.SP.ctx();
		var path = "";
		var sFolder = args.sFolder;
		if( /\//.test( args.sFolder ) ) {
			var ls = args.sFolder.split( "/" );
			sFolder = ls.pop();
			path = _spPageContextInfo.webServerRelativeUrl;
			path += "/" + args.sList + "/" + ls.join( "/" );
		}
		var oList = __.SP.list.get( ctx, args.sList );
		var oItem = new SP.ListItemCreationInformation();
		oItem.set_underlyingObjectType( SP.FileSystemObjectType.folder );
		oItem.set_leafName( sFolder );
		oItem.set_folderUrl( path );
		var oItem = oList.addItem( oItem );
		// also add title for we might use folder in lookup
		oItem.set_item( "Title", sFolder );
		oItem.update();
		ctx.load( oItem );
		__.SP.exec( ctx, oItem, function( oFolder ) {
			if( oFolder.sError ) {
				async.reject( oFolder.sError );
			}
			else {
				var id = oFolder.get_id();
				async.resolve( { oFolder : oFolder, idFolder : id });
			}
		} );
	}
	/**
	 * Reads information of a folder
	 * @memberof __.SP.folder
	 * @method read
	 * @example // stand alone
	 * __.SP.folder.read( {
	 * 	  path : "/Lists/Shared Documents/test folder"
	 * } );
	 * @example // as promise
	 * .then( __.SP.folder, "read", {
	 * 	  path : "/Lists/Shared Documents/test folder"
	 * } );
	 * @param {Object} args a parameter object holding the following values
	 * @param {String} path path of the folder
	 * @param {Array} lsFields array of internal field names to return
	 * @returns {Object} Resolved promise holding the following values 
	 * <pre class='return-object'>
	 * oFolder | (Object) | context of the newly created folder
	 * aResult  | (Object) | associate array holding properties of the folder
	 * </pre>
	 */
	, read : function( args ) {
		var async = __.Async.promise( args );
		var ctx = __.SP.ctx();
		var oFolder = ctx.get_web().getFolderByServerRelativeUrl( args.path );
		ctx.load( oFolder, "ListItemAllFields" );
		__.SP.exec( ctx, oFolder, function( oFolder ) {
			if( oFolder.sError ) {
				async.reject( oFolder.sError );
			}
			else {
				oFolder = oFolder.get_listItemAllFields();
				var aResult = {};
				args.lsFields.forEach( function( sField ) {
					var oField = oFolder.get_item( sField );
					if( oField ) {
						if( oField.get_lookupId ) {
							aResult[ sField ] = oField.get_lookupValue();
							aResult[ "id" + sField ] = oField.get_lookupId();
						}
						else {
							aResult[ sField ] = oField;
						}
					}
				} );
				async.resolve( { oFolder : oFolder, aResult : aResult } );
			}
		} );
	}
};


/* *** SITE COLUMN *** */

// var xml = '<Field Type="Choice" Name="FrontOffice" DisplayName="Front Office" ';
//	xml += ' Format="Dropdown" Group="Custom Columns">';
//	xml += '<CHOICES><CHOICE>OSG</CHOICE><CHOICE>OCEEA</CHOICE></CHOICES></Field>';
// __.SP.site.addColumn( { xml : xml );
__.SP.site = {};
__.SP.site.addColumn = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oFields = ctx.get_web().get_fields();
	oFields.addFieldAsXml( args.xml );
	ctx.load( oFields );
	__.SP.exec( ctx, oFields, function( oFields ) {
		if( oFields.sError ) {
			async.reject( oFields );
		}
		else {
			async.resolve();
		}
	} );
};
// __.SP.site.readColumn({sColumn:"FrontOffice"})
__.SP.site.readColumn = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oFields = ctx.get_web().get_fields();
	var oWeb = ctx.get_site().get_rootWeb();
	var oColumn = oWeb.get_availableFields().getByInternalNameOrTitle( args.sColumn );
	ctx.load( oColumn );
	__.SP.exec( ctx, oColumn, function( oColumn ) {
		if( oColumn.sError ) {
			async.reject( oColumn );
		}
		else {
			var ls = [];
			var xml = oColumn.get_schemaXml();
			xml.match( /<CHOICE>(.*?)<\/CHOICE>/g ).forEach( function( s ) {
				ls.push( s.match( /<CHOICE>(.*?)<\/CHOICE>/ )[ 1 ] ) ;
			} );
			async.resolve( {
				lsValues : ls
			} );
		}
	} );
};

__.SP.site.addCSS = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var ctx = SP.ClientContext.get_current()
	var oWeb = ctx.get_web();
	oWeb.set_alternateCssUrl( args.url );
	oWeb.update();
	__.SP.exec( ctx, oWeb, function( oWeb ) {
		if( oWeb.sError ) {
			async.reject( oWeb.sError );
		}
		else {
			async.resolve();
		}
	} );
};

__.SP.deploy = {
	  list : function( args ) {
		var sList = args.oDeploy.sList;
		var sType = args.oDeploy.sType;
		var aSettings = args.oDeploy.aSettings || {};
		var loFields = args.oDeploy.loFields;
		var lsFields = [];
		loFields.forEach( function( oField ) {
			lsFields.push( oField.sName );
		} );
		var async = __.Async.promise( args )
		async
		.debug()
		.then( __.SP.list, "exists", { sList : sList } )
		.then( function( args ) {
			var async = __.Async.promise( args );
			var bCreate = true;
			if( args.bExists ) {
				if( args.bPurge ) {
					async.then( __.SP.list, "del" );
				}
				else {
					bCreate = false;
				}
			}
			if( bCreate ) {
				async.then( __.SP.list, "create", { sType : sType }, "create list " + sList )
				async.then( __.SP.list, "setColumns", { sList : sList, loFields : loFields}, "set columns in list " + sList )
				async.then( __.SP.list, "addFields", { sList : sList, loFields : loFields }, "add fields to list " + sList )
				async.then( __.SP.list, "setLookups", {}, "setup lookups in list " + sList )
			}
			async.resolve();
		} )
		.then( __.SP.list, "settings", { kvFeatures : aSettings }, "apply settings to list " + sList )
		.then( function( args ) {
			var async = __.Async.promise( args );
			for( var sFile in args.oDeploy.jsLinks ) {
				var jsLink = args.oDeploy.jsLinks[ sFile ];
				if( ! /\.aspx/.test( sFile ) ) {
					async.then( __.SP.list.field, "setJsLink", {
						  sList : sList
						, sField : "jsLink"
						, urlJsLink : jsLink
					}, "set jslink on field" )
				}
			}
			async.resolve();
		}, "set js links on views" )
		.then( function( args ) {
			var async = __.Async.promise( args );
			for( var sView in args.oDeploy.aViews ) {
				var aView = args.oDeploy.aViews[ sView ];
				var bDefaultView = ( args.oDeploy.sDefaultView && sView == args.oDeploy.sDefaultView ) ? true : null;
				async.then( __.SP.view, "add", {
					  sList : sList
					, bDefaultView : bDefaultView
					, bPublic : true
					, sView : sView
					, lsFields : aView.lsFields
					, xmlQuery : aView.xmlQuery
				}, "create " + sView )
			}
			async.resolve();
		}, sList + " - create views" )
		.then( function( args ) {
			var async = __.Async.promise( args );
			for( var sFile in args.oDeploy.jsLinks ) {
				var jsLink = args.oDeploy.jsLinks[ sFile ];
				if( /\.aspx/.test( sFile ) ) {
					var path = ( sType == "documentLibrary" )
						? sList + "/Forms/" + sFile
						: "/Lists/" + sList + "/" + sFile;
					async.then( __.SP.webpart, "settings", {
						  path : path
						, kv : {
							JSLink : jsLink
						}
					}, "set jslink on view: " + sFile )
				}
			}
			async.resolve();
		}, sList + " - set js links in webpart" )
		async.then( __.SP.list.field, "reorder", { sList : sList, lsFields : lsFields }, sList + " - reorder fields" )
		.then( __.SP.list.field, "displays", { loFields : loFields }, sList + " - set field displays" )
		.then( function( args ) {
			__.Async.promise( args ).resolve();
		}, "finished deploying: " + sList )
		.resolve();
	}
}

__.SP.sprvPage = null;
__.SP.scurPage = null;

if( self == top ) {
	__.SP.scurPage = null;
	window.addEventListener( "hashchange", function() {
		var url = unescape( unescape( self.location.href ) );
		__.SP.sprvPage = __.SP.scurPage || "";
		__.SP.scurPage = url;
		// check if a list is loaded
		var ls = url.match( /\/Lists\/(.*?)\// );
		var sList = "";
		if( ls && ls.length ) {
			sList = ls[ 1 ];
		}
		var ls = url.match(  /#.*\/(.*?)\.aspx/ );
		// get the current page
		var sPage = "";
		if( ls && ls.length ) {
			sPage = ls[ 1 ];
		}
		__.Event.trigger( "hashchange", {
			  sList : sList
			, sPage : sPage
			, sprvPage : __.SP.sprvPage
			, scurPage : __.SP.scurPage
		} );

		// empty #Dossier on hashchange since MDS-SP unloads external CSS at this
		// event rendering the form (content of #Dossier) unreadable so we set
		// inline styles on #Dossier and empty content on hashchange
		/*
		var dn = __.dn_( "#dossier-title" );
		if( dn ) {
			__.dn.del( dn );
		}
		var dn = __.dn_( "#Dossier" );
		if( dn ) {
			dn.innerHTML = "";
		}
		*/
	} );
}


O$C3.Urls = {
	aaurl : {
		  prod : {
			rso : 'https://rso.osce.org/',
			docin : 'https://docin.osce.org/',
			sharepoint : 'https://sharepoint.osce.org/',
			mySite : 'https://sp-selfservice.osce.org/',
			midtier : 'https://ws-sharepoint.osce.org/WebService.asmx/'
		}
		, test : {
			rso : 'https://test-rso.osce.org/',
			docin : 'https://test-docin.osce.org/',
			sharepoint : 'https://test-jarvis.osce.org/',
			mySite : 'https://test-sp-selfservice.osce.org/',
			midtier : 'https://test-ws-sharepoint.osce.org/WebService.asmx/'
		}
		, dev : {
			rso : 'https://dev-rso.osce.org/',
			docin : 'https://dev-docin.osce.org/',
			sharepoint : 'https://dev-sharepoint.osce.org/',
			mySite : 'https://dev-sp-selfservice.osce.org/',
			midtier : 'https://dev-ws-sharepoint.osce.org/WebService.asmx/'
		}
	}
	, get : function( sDomain ) {
		var sEnv = "prod";
			if( /^https:\/\/test/.test( self.location.href ) ) {
			sEnv = "test";
		}
		else if( /^https:\/\/dev/.test( self.location.href ) ) {
			sEnv = "dev";
		}
		var url = this.aaurl[ sEnv ][ sDomain ];
		return url;
	}
};

/* tyepf def of caml field, expected format: 
 * {
 *   Country : { sType : "Lookup", v: [ [2, 6] ] } // 2dim array for ORing multiple. NB: inner array holds term id plus children
 * , Published : { sType : "Boolean", v: 1 }
 * , FrontOffice : { sType : "Text", v: "OSG" }
 * }
 */
/**
 * @namespace __.SP.caml
 * @memberof __.SP
 */
__.SP.caml = {};

/**
 * <pre>
 * Analyzes the URL and extracts the current query applied to a list.
 * </pre>
 * @memberof __.SP.caml
 * @method analyzeUrl
 * @todo typedef caml object
 * @example
 * __.SP.caml.analyzeUrl();
 * @returns {Object} aCAMLFields JSON describing the current query
 */
__.SP.caml.analyzeUrl = function() {
	var url = unescape( unescape( ( self.location.href ) ) );
	var sQuery;
	if( /ServerFilter=/.test( url ) ) {
		sQuery = "?" + url.split( "ServerFilter=" )[ 1 ];
		sQuery = sQuery.replace( /-/g, "&" );
	}
	else if( /FilterField1/.test( url ) ) {
		sQuery = url;
	}
	else {
		return null;
	}
	var oParams = __.url.oParams( sQuery );
	var aCAMLFields = {};
	for( var kParam in oParams ) {
		var ls = kParam.match( /FilterField(.*)$/ );
		if( ls ) {
			var k = oParams[ kParam ];
			var ix = ls[ 1 ];
			var v =  oParams[ "FilterValue" + ix ]
			aCAMLFields[ k ] = {
				v : v, sType: "Text"
			};
			if( oParams[ "FilterLookupId" + ix ] ) {
				aCAMLFields[ k ].sType = "Lookup";
				aCAMLFields[ k ].v = v.split( "," );
			}
			else if( ! isNaN( v ) ) {
				v = Number( v );
				if( v == 1 || v == 0 ) {
					aCAMLFields[ k ].v = v;
					aCAMLFields[ k ].sType = "Boolean";
				}
			}
		}
	};
	return aCAMLFields;
}

/**
 * <pre>
 * Creates fields of a CAML query reading from an array of {oField} objects
 * </pre>
 * @memberof __.SP.caml
 * @method createFields
 * @todo typedef caml object
 * @example
 * __.SP.caml.createFields( { loFields : loFields } );
 * @param {oField} loFields an array of list field objects "oField"
 * @returns {String} lxml array of xml string representing CAML query fields
 */
__.SP.caml.createFields = function( loFields ) {
	var lxml = [];
	loFields.forEach( function( aField ) {
		var sField = aField.sName;
		switch( aField.sType ) {
			case "ListOfIDs" :
				var xml = "<In>";
				xml += '<FieldRef Name="'+ sField + '" />';
				xml += "<Values>";
				aField.v.forEach( function( n ) {
					xml += '<Value Type="Number">' + n + '</Value>';
				} );
				xml += "</Values>";
				xml += "</In>";
				console.log( xml );
			break;
			case "taxonomy" :
				var xml = "";
				var lxmlIn = [];
				aField.v.forEach( function( laTaxFields ) {
					var xmlIn = "<In>";
					xmlIn += '<FieldRef LookupId="True" Name="'+ sField + '" />';
					xmlIn += "<Values>";
					laTaxFields.forEach( function( aTaxField ) {
						var id = aTaxField.id;
						var sName = escape( aTaxField.sName );
						// in case we have an ID == -1 this means the term had not yet been
						// assigned to any item however we need to put an ID (that won't return
						// results) for otherwise it'll impose no restrictions.
						var sTermNotAssignedYet = ( id == -1 )
							? ' sTermNotAssignedYet="' + sName + '"' : '';
						xmlIn += '<Value ' + sTermNotAssignedYet + ' Type="Integer">' + id + '</Value>';
					} );
					xmlIn += "</Values>";
					xmlIn += "</In>";
					lxmlIn.push( xmlIn );
				} );
				xml += __.SP.caml.wrap( lxmlIn, "Or" );
			break;
			case "boolean" :
				var xml = "<Eq>";
				xml += '<FieldRef Name="' + sField + '" />';
				xml += '<Value Type="Integer">' + aField.v + '</Value>';
				xml += "</Eq>";
			break;
			case "text" :
			case "choice" :
				var xml = "<" + aField.sOperator + ">";
				xml += '<FieldRef Name="' + sField + '" />';
				xml += '<Value Type="Text">' + aField.v + '</Value>';
				xml += "</" + aField.sOperator + ">";
			break;
			case "lookup" :
				var xml = "<" + aField.sOperator + ">";
				xml += '<FieldRef Name="' + sField + '" />';
				xml += '<Value Type="Lookup">' + aField.v + '</Value>';
				xml += "</" + aField.sOperator + ">";
			break;
			// REF: date, people missing
		}
		lxml.push( xml );
	} );
	return lxml;
};

/**
 * <pre>
 * Reads array of xml string representing CAML query fields and wraps them in 
 * logical operator tags nesting them properly.
 * </pre>
 * @memberof __.SP.caml
 * @method wrap 
 * @example
 * __.SP.caml.wrap( {
 *       lxml : [
 *          "<Eq><FieldRef Name='ID' /><Value Type='Integer'>1</Value></Eq>" 
 *        , "<Eq><FieldRef Name='ID' /><Value Type='Integer'>9</Value></Eq>"
 *     , sOpr : "And"
 * } );
 * @param {Array} lxml array of xml string representing CAML query fields
 * @param {String} sOpr logical operator
 * @returns {String} xml xml string representing CAML fields queries wrapped in logical operators
 */
__.SP.caml.wrap = function( lxml, sOpr ) {
	var nl = "\n";
	var sOpr = sOpr || "And";
	var wrap = function( sContent ) {
		return "<" + sOpr + ">" + nl + sContent + "</" + sOpr + ">" + nl;
	}
	var xml = "";
	// safety clause for while
	var x = 100;
	if( lxml.length == 1 ) {
		xml = lxml[ 0 ];
	}
	else if( lxml.length > 1 ) {
		xml += lxml.pop() + nl;
		xml += lxml.pop() + nl;
		xml = wrap( xml );
		while( lxml.length && (--x>0) ) {
			if( lxml.length > 0 ) {
				xml = wrap( lxml.pop() + nl + xml );
			}
		}
	}
	return xml;

};

/**
 * <pre>
 * Takes string representing CAML fields queries and a logical operators
 * and wraps it in <where> clause returning it as CAML query
 * </pre>
 * @memberof __.SP.caml
 * @method whereClause
 * @example
 * __.SP.caml.whereClaue( {
 *       lxml : [
 *          "<Eq><FieldRef Name='ID' /><Value Type='Integer'>1</Value></Eq>" 
 *        , "<Eq><FieldRef Name='ID' /><Value Type='Integer'>9</Value></Eq>"
 *     , sOpr : "And"
 * } );
 * @param {Array} lxml array of xml string representing CAML query fields
 * @param {String} [sOpr] logical operator defaults to "And"
 * @returns {String} xml xml string representing a CAML query
 */
__.SP.caml.whereClause = function( lxml, sOpr ) {
	var sOpr = sOpr || "And";
	return '<Where>' + this.wrap( lxml, sOpr ) + '</Where>';
}

/**
 * <pre>
 * Analyzes the URL and extracts the current query applied to a list and returns
 * it as xml string representing a CAML query.
 * </pre>
 * @memberof __.SP.caml
 * @method convertFromUrl
 * @example __.SP.caml.convertFromUrl();
 * @returns {String} xml xml string representing a CAML query
 */
__.SP.caml.convertFromUrl = function() {
	var oFields = __.SP.caml.analyzeUrl();
	if( oFields ) {
		var lxml = __.SP.caml.createFields( oFields );
		var sWhere = __.SP.caml.whereClause( lxml );
		var sSort = '<OrderBy><FieldRef Name="Title" /><FieldRef Name="FirstName" /></OrderBy>';
		return sSort + sWhere;
	}
	return null;
}
__.Async.fnerr = function( oError ) {
	top.__.SP.Error.show( oError );
};

top.__.SP.Error = __.Class.extend( {
	  dnWindow : null
	, oError : {}
	, createErrorData : function( args ) {
		var sError = "An incident happened";
		var sDescription = "";
		if( args.sLabel ) {
			sError = "Could not " + args.sLabel + ".\r\n";
			if( args.sError ) {
				sDescription = args.sError;
			}
		}
		else if( args.sError ) {
			sError = args.sError;
			sDescription = "";
		}
		else if( typeof args == "string" ) {
			sError = args;
			sDescription = "";
		}
		var now = new Date();
		var dt = new Date( now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(),  now.getUTCHours(), now.getUTCMinutes(), now.getUTCSeconds() );
		this.oError = {
			  sTitle : args.sTitle || "System Message"
			, sError : sError
			, sDescription : sDescription
			, sUser : top.__.SP.user.aInfo.sLogin
			, dt : dt
			, sInfo : args.sInfo || null
			, sStack : args.sStack || null
			, sLevel : args.sLevel || "ERROR"
			, idError : "sp" + Math.floor( (1 + Math.random() ) * 0x10000 ).toString( 16 )
			, sSite : _spPageContextInfo.siteServerRelativeUrl
			, url : self.location.href
		};
	}
	, log : function() {
		var sException = __.o.s( this.oError );
		if( ! sException ) {
			sException = "[fallback]" + this.oError.sError + this.oError.sStack + this.oError.url;
		}
		var oPayload = {
			  level : this.oError.sLevel
			, message : "[" + this.oError.idError + "][" + O$C3.sApp + "] " + this.oError.sError
			, exception : escape( sException )
		}
		console.warn( ">>>>>>ACTIVATE LOG>>>>>>>" );
		console.warn( oPayload );
		console.warn( "<<<<<<ACTIVATE LOG<<<<<<<" );
		return;
		top.__.SP.webservice.call( {
			  sService : "midtier"
			, sEndpoint : "Log4NetExternal"
			, oPayload : oPayload
			, bIgnoreFailure : true
		} );
	
	}
	, hMessage : function() {
		var hTemplate = " \
			<div class='osce-error'> \
				<p> \
					An unexpected error has occurred. The details have been logged. \
				</p> \
				<p> \
					Please close this dialog and try to repeat the operation. If the error continues, \
					contact IT Service Desk and include the details below in your report. \
				</p> \
				<div class='line'>&nbsp;</div> \
				<table class='osce-error'> \
					<tr> \
						<td class='title'>Timestamp (UTC):</td> \
						<td>{{dt}}</td> \
					</tr> \
					<tr> \
						<td class='title'>Username:</td> \
						<td>{{sUser}}</td> \
					</tr> \
					<tr> \
						<td class='title'>Error ID:</td> \
						<td>{{idError}}</td> \
					</tr> \
					<tr> \
						<td class='title'>Error message(s):</td> \
						<td class='message'> \
						<textarea disabled>{{sError}}{{sDescription}}</textarea> \
						<span class='osce-erno hide'><br>[multiple errors occurred: <span>1</span>]</span> \
						</td> \
					</tr> \
				</table> \
			</div> \
		";
		try {
			return Mustache.to_html( hTemplate, this.oError );
		}
		catch( e ) {
			console.warn( "mustach error", e );
			return null;
		}
	}
	, init : function( args ) { 
		console.warn( "-------------ERROR-------------" );
		console.warn( args );
		console.warn( "-------------ERROR-------------" );
		var that = this;
		this.createErrorData( args );
		var hMessage = this.hMessage( this.oError );
		if( hMessage ) {
			this.dnWindow = top.__.SP.modal.open( {
				  sTitle : that.oError.sTitle
				, hContent : hMessage
				, sOk : "Report"
				, fnClose : function() {
					that.dnWindow.close();
					//that.closeAll();
				}
				, fnact : function() {
					var sBody = "Dear Service Desk,\r\n\r\n";
					sBody += "The application \"" + O$C3.sApp + "\" showed ";
					sBody += "the following error message:\r\n\r\n";
					sBody += "\t(" + that.oError.idError + ") " + that.oError.sError + "\r\n\r\n";
					sBody += " Best regards,";
					var url = "mailto:ICTServicedesk@osce.org";
					var url = "mailto:jriemer@osce.org";
					url += "?subject=" + O$C3.sApp + ": " + that.oError.sError;
					url += "&body=" + encodeURIComponent( sBody );
					window.location.href = url;
					that.dnWindow.close();
				}
			} );
		}
		this.log();
	}
} );

top.__.SP.Error.show = function( args ) {
	return __.Class.instantiate( top.__.SP.Error, args );
};

__.SP.filter = {};
__.SP.Filter = __.Class.extend( {
	  dnRoot : null
	, dnForm : null
	, guidFilter : null
	, sList : null
	, cbCreate : null
	, cbDataEntered : null
	, cbClear : null
	, lsFilterFields : null
	, sFilterFieldStore : ""
	, sFilter : null
	, sFilterName : "Current Filter"
	, init : function( aConf ) {
		var that = this;
		this.sList = aConf.sList;
		this.loFields = this.extractFilterFields( aConf.loFields );
		this.cbCreate = aConf.cbCreate || null;
		this.cbClear = aConf.cbClear || null;
		this.defaultView = aConf.defaultView || "All Items";
		// SP's OOTB default views differ in internal and display name
		this.sdftView = aConf.defaultView || "AllItems";
		this.sFilter = "_filter_" + __.s.tokenize( this.sList ) + "_";
		this.sFilterFieldStore = this.sFilter + "_fields_";
		// check if filter has already been created
		( new __.Async( {
			  sLabel : "Create a filter for search or saving"
			, sFile : "__.SP.filter.js"
		} ) )
		/*
		.wait( function() {
			return __.dn_( "#sideNavBox" );
		}, 25, "wait for side nav box" )
		*/
		.then( function( args ) {
			var h = "<div id='"+ that.sFilter +"' style='display:none' class='osce-filter'></div>";
			that.dnRoot = __.dn.append( h, __.dn_( "#sideNavBox" ) );
			that.createButtons();
			that.dnForm = __.SP.filter.form.create( {
				  dnRoot : that.dnRoot
				, idFilter : that.sFilter
				, loFields : that.getFields()
				// , cbChange : function() { that.toggleButtons() }
			} );
			if( that.cbCreate ) {
				that.cbCreate( that.dnRoot );
			}
			__.Async.promise( args ).resolve();
		}, "create filter" )
		.then( function( args ) {
			that.getFilterFields();
			that.show();
			__.Event.listen( that, "hashchange" );
			__.Async.promise( args ).resolve();
		}, "show and subscribe to broadcaster" )
		.start();
	}
	, extractFilterFields : function( loFields ) {
		var loFilterFields = [];
		loFields.forEach( function( oField ) {
			if( oField.nFilter ) {
				loFilterFields.push( oField );
			}
		} );
		return loFilterFields;
	}
	, lsFormFields : null
	, getFormFields : function() {
		var that = this;
		if( ! this.lsFormFields ) {
			this.lsFormFields = [];
			this.loFields.forEach( function( aField ) {
				if( ! aField.bHiddenInForm ) {
					that.lsFormFields.push( aField.sName );
				}
			} );
		}
		return this.lsFormFields;
	}
	, lsListFields : null
	, getListFields : function() {
		var that = this;
		if( ! this.lsListFields ) {
			this.lsListFields = [];
			this.loFields.forEach( function( aField ) {
				if( ! aField.bHiddenInList ) {
					that.lsListFields.push( aField.sName );
				}
			} );
		}
		return this.lsListFields;
	}
	, lsExportFields : null
	, getExportFields : function() {
		var that = this;
		if( ! this.lsExportFields ) {
			this.lsExportFields = [];
			this.loFields.forEach( function( aField ) {
				if( aField.bExport ) {
					that.lsExportFields.push( aField.sName );
				}
			} );
		}
		return this.lsExportFields;
	}
	, onHashchange : function( oMessage ) {
		if( oMessage.sList !== this.sList ) {
			this.hide();
		}
	}
	, unlock : function() {
		__.SP.grid.unlock();
		this.dnRoot.style.background = "#fff";
	}
	, lock : function() {
		__.SP.grid.lock();
		this.dnRoot.style.background = "#efefef";
	}
	, hide : function() {
		this.dnRoot.style.display = "none";
	}
	, show : function() {
		this.dnRoot.style.display = "block";
		this.update();
	}
	, read : function() {
		var kv = __.SP.filter.form.read( this.getForm() );
		for( var k in kv ) {
			if( ! kv[ k ] ) {
				delete kv[ k ];
			}
		}
		return ( __.o.empty( kv ) ) ? null : kv;
	}
	, bFilterView : function() {
		if( ! this.guidFilter ) {
			return false;
		}
		var rx = new RegExp( this.guidFilter );
		return rx.test( self.location.href );
	}
	, bDataEntered : function() {
		var oData = this.read();
		if( this.cbDataEntered ) {
			oData = this.cbDataEntered( oData );
		}
		return !! ( oData );
	}
	, createPersonalViewUrl : function( guid ) {
		var url = _spPageContextInfo.webServerRelativeUrl;
		url += "/_layouts/15/start.aspx#/Lists/" + this.sList + "/";
		url += "PersonalViews.aspx?PageView=Personal&ShowWebPart=";
		url += "{" + guid + "}";
		return url;
	}
	, loadDefaultView : function() {
		var url = _spPageContextInfo.webServerRelativeUrl;
		url += "/_layouts/15/start.aspx#/Lists/" + ctx.ListTitle +"/";
		url += O$C3.User.sUnit + " Contacts.aspx?r=" + Math.random();
//		url += this.sdftView +".aspx?r=" + Math.random();
		self.location.href = url;
	}
	, loadPersonalView : function( guid ) {
		self.location.href = this.createPersonalViewUrl( guid );
		__.SP.grid.reload( 500 );
	}
	, form2hash : function() {
		var kv = this.read();
		var sHash = ( kv ) ? "&query=__" + __.o.s( kv ) + "__" : "";
		return sHash;
	}
	, getForm : function() {
		return this.dnForm;
		var id = "_filter_" + __.s.tokenize( ctx.ListTitle ) + "_";
		var dnForm = __.dn_( "#" + id );
		if( dnForm ) {
			return dnForm;
		}
		return null;
	}
	, update : function() {
		__.SP.filter.form.reset( this.dnForm );
		this.unlock();
		this.caml2form();
		this.toggleFilterFields();
	}
	, caml2form : function() {
		var dnForm = this.getForm();
		var that = this;
		if( ! dnForm ) { return }
		var sView = ctx.viewTitle;
		var sList = ctx.ListTitle;
		( new __.Async( {
			  sLabel : "Update form with query"
			, sFile : "__.SP.filter.js"
		} ) )
		.then( __.SP.view, "read", {
			  sList : ctx.ListTitle
			, sView : sView
		}, "read current view" )
		// REF: extract xml query reading in method for we need parts again further down the code
		.then( function( args ) {
			var async = __.Async.promise( args )
			var xmlQuery = args.kv.xmlQuery;
			lsxml = xmlQuery.match( /<Where>.*?<\/Where>/ );
			if( lsxml && lsxml[ 0 ] ) {
				xmlQuery = lsxml[ 0 ];
				var dn = __.dn.append( xmlQuery );
				__.dn_( "FieldRef", dn, function( dn ) {
					// get necessary attributes from field node
					var sName = dn.getAttribute( "name" );
					var sOperator = dn.parentNode.tagName;
					// create sid of field
					var sid = __.s.tokenize( that.sFilter + sOperator + sName );
					// get the corresponding field in our filter
					var dnField = __.dn_( "[sid='" + sid + "']", dnForm );
					// skip unknown fields (e.g. for custom queries such as cherry picks)
					if( ! dnField ) {
						return;
					}
					var sFormType = dnField.getAttribute( "sFormType" );
					if( sFormType == "taxonomy" ) {
						async.then( __.SP.taxonomy, "load", {
							  sTermSet : O$C3.Tax.guidTermSet[ sName ]
						}, "load " + sName )
					}
				} );
			}
			async.resolve();
		}, "load taxonomies" )
		.then( __.SP.taxonomy, "getTermIds", {}, "get taxonomy term ids" )
		.then( function( args ) {
			var bTaxTerms = false;
			// REF be more defensiv here
			var xmlQuery = args.kv.xmlQuery;
			lsxml = xmlQuery.match( /<Where>.*?<\/Where>/ );
			if( lsxml && lsxml[ 0 ] ) {
				xmlQuery = lsxml[ 0 ];
				var dn = __.dn.append( xmlQuery );
				__.dn_( "FieldRef", dn, function( dn ) {
					// get necessary attributes from field node
					var sName = dn.getAttribute( "name" );
					var sOperator = dn.parentNode.tagName;
					// create sid of field
					var sid = __.s.tokenize( that.sFilter + sOperator + sName );
					// get the corresponding field in our filter
					var dnField = __.dn_( "[sid='" + sid + "']", dnForm );
					// skip unknown fields (e.g. for custom queries such as cherry picks)
					if( ! dnField ) {
						return;
					}
					var sFormType = dnField.getAttribute( "sFormType" );
					// and we check its type of field (e.g. choice, taxonomy, etc. )
					// all supported types are found in __.SP.filter.form.js
					var dnMultiValues = __.dn_( "values", dn );
					if( dnMultiValues ) {
						dn = dnMultiValues;
					}
					// get the last entry for we only have multiple values in case of
					// taxonomies and there we put the parent term at the end.
					if( dn && dn.lastChild && dn.lastChild.textContent ) {
						var v = dn.lastChild.textContent;
						// get the name of the term if it had not been assigned yet, hence
						// its ID was set to -1 see other comment in __.SP.caml.js
						var sTermNotAssignedYet = dn.lastChild.getAttribute( "stermnotassignedyet" );
						if( sFormType == "taxonomy" ) {
							bTaxTerms = true;
							// check if we deal with the name of the tag
							// this happens if we ddidn't had the term id when querying
							if( sTermNotAssignedYet ) {
								sTermNotAssignedYet = unescape( sTermNotAssignedYet );
								var oTax = __.SP.taxonomy.aTerms[ O$C3.Tax.guidTermSet[ sName ] ];
								var aTermsLookup = oTax.aTerms;
								var guidTerm = aTermsLookup[ sTermNotAssignedYet ].guid;
								v = {
									  guid : guidTerm
									, sName : sTermNotAssignedYet
								}
							}
							else {
								v = __.SP.taxonomy.termInfo( parseInt( v ) );
							}
						}
						if( sFormType == "checkbox" ) {
							if( v !== "" ) {
								v = ( v == 1 ) ? "Yes" : "No";
							}
						}
						if( v ) {
							__.SP.filter.form.field[ sFormType ].set( dnField, v );
						}
					}
				} );
				// in case we deal with tax terms we need to check if
				// the query changed in the meanwhile.
				if( bTaxTerms ) {
					that.compareQueries();
				}
				__.dn.del( dn );
			}
			__.Async.promise( args ).resolve();
		}, "Analyse query" )
		.start();
	}
	, form2caml : function() {
		var oFields = this.read();
		var lvCAML = [];
		if( oFields ) {
			var idFilter = this.getForm().id;
			for( var sid in oFields ) {
				var oField = oFields[ sid ];
				var v = oField.v;
				if( v ) {
					switch( oField.sCAMLType ) { // boolean, taxonomy, text, lookup, choice
						case "text" :
						case "date" : // REF check date on own property
						case "choice" :
						case "lookup" :
							lvCAML.push( {
								  sName : oField.sName
								, sType : oField.sCAMLType
								, sOperator : oField.sOperator
								, v : v
							} );
						break;
						case "boolean" :
							v = ( v == "Yes" ) ? 1 : 0;
							lvCAML.push( {
								  sName : oField.sName
								, sType : oField.sCAMLType
								, sOperator : oField.sOperator
								, v : v
							} );
						break;
						case "taxonomy" :
							laTaxFields = [];
							var idTermSet = O$C3.Tax.guidTermSet[ oField.sName ];
							for( var sName in v ) {
								// first get guids of children terms
								var guid = v[ sName ];
								var lguid = __.SP.taxonomy.children( {
									  idParent : guid
									, idTermSet : idTermSet
								} );
								// then lookup those term's IDs
								var lid = [];
								lguid.forEach( function( guid ) {
									var aTermInfo = __.SP.taxonomy.termInfo( guid );
									if( aTermInfo ) {
										lid.push( {
											  id : aTermInfo.id
											, sName : aTermInfo.sName
										} );
									}
								} );
								// also search add the parent term, if it does not
								// exist we set to -1 otherwise the id list might be
								// completely empty resulting in no restrictions
								var aTermInfo = __.SP.taxonomy.termInfo( guid );
								var idParent = ( aTermInfo ) ? aTermInfo.id : -1;
								lid.push( {
									  id : idParent
									, sName : sName
								} );
								if( ! __.l.empty( lid ) ) {
									laTaxFields.push( lid );
								}
							}
							if( ! __.l.empty( laTaxFields ) ) {
								lvCAML.push( {
									  sType : "taxonomy"
									, sName : oField.sName
									, v : laTaxFields
								} );
							}
						break;
					}
				}
			}
			var lxml = __.SP.caml.createFields( lvCAML );
			var xmlQuery = __.SP.caml.whereClause( lxml );
			return xmlQuery;
		}
	}
	, bCompared : null
	, compareQueries : function() {
		var that = this;
		if( this.bCompared ) {
			this.bCompared = null;
			return;
		}
		var sView = ctx.viewTitle;
		// no comparing in current filter
		if( sView == this.sFilterName ) {
			return;
		}
		// no comparing for default views
		if( ! /PersonalViews\.aspx/.test( self.location.hash ) ) {
			return;
		}
		( new __.Async( {
			  sLabel : "compare loaded queries"
			, sFile : "__.SP.filter.js"
		} ) )
		.then( __.SP.taxonomy, "getTermIds", "get taxonomy term ids" )
		.clear()
		.then( __.SP.view, "read", {
			  sList : that.sList
			, sView : sView
		}, "read current view query" )
		.then( function( args ) {
			var async = __.Async.promise( args );
			var oFields = that.read();
			for( var sField in oFields ) {
				var oField = oFields[ sField ];
				if( oField.v && oField.sCAMLType == "taxonomy" ) {
					async.then( __.SP.taxonomy, "load", {
						  sTermSet : O$C3.Tax.guidTermSet[ oField.sName ]
					}, "load " + oField.sName )
				}
			}
			async.resolve();
		}, "load taxonomies" )
		.then( function( args ) {
			var token = function( s ) {
				s = __.s.tokenize( s );
				var sValues = s.replace( /<(?:.|\n)*?>/gm, "|" );
				if( sValues ) {
					var lsValues = sValues.split( "|" );
					if( lsValues && lsValues.length > 0 ) {
						lsValues.sort();
						return lsValues.join( "|" );
					}
				}
				return null;
			};
			var async = __.Async.promise( args );
			var newQuery = that.form2caml();
			var ls = args.kv.xmlQuery.match( /<Where>.*<\/Where>/ )
			var oldQuery = ls[ 0 ];
			if( token( newQuery ) != token( oldQuery ) ) {
				async.then( __.SP.view, "update", {
					  sList : that.sList
					, sView : sView
					, xmlQuery : newQuery
				}, "update view" )
				.then( function( args ) {
					that.bCompared = true;
					__.SP.grid.reload();
				}, "reload view" )
			}
			else {
				// query up to date
			}
			async.resolve();
		}, "compare queries" )
		.then( function( args ) {
			__.Async.promise( args ).resolve();
		}, "done" )
		.start();
	}
	, createButtons : function() {
		var that = this;
		var h = "";
		h += "<div id='osce-filter-buttons'>";
		h += '<span class="menu icon-gear" action="gear" title="Manage filter fields"></span>';
		h += '<span class="menu icon-search" action="search" title="Search with this filter"></span>';
		h += '<span class="menu icon-save" action="save" title="Save this search"></span>';
		h += '<b><span class="menu icon-clear" action="clear" title="Clear the filter"></span></b>';
		h += "</div>";
		__.dn.append( h, this.dnRoot )
			.addEventListener( "click", function( e ) {
				e.preventDefault();
				e.stopPropagation();
				switch( e.target.getAttribute( "action" ) ) {
					case "gear" :
						that.openFilterFieldWindow();
					break;
					case "search" :
						that.filter();
					break;
					case "clear" :
						__.SP.filter.form.reset( that.dnForm );
						if( that.cbClear ) {
							that.cbClear();
						}
						that.loadDefaultView();
					break;
					case "save" :
						that.openSaveWindow();
					break;
				}
			} );
	}
	, getFields : function() {
		this.loFields.forEach( function( oField ) {
			if( ! oField.sOperator ) {
				oField.sOperator = ( oField.sCAMLType == "taxonomy" ) ? "In" : "Eq";
			}
		} );
		this.loFields = __.l.kSort( this.loFields, "nFilter" );
		return this.loFields;
	}
	, createView : function( sName, cbfn ) {
		var that = this;
		var xmlQuery = '<OrderBy><FieldRef Name="Title" /></OrderBy>';
		( new __.Async( {
			  sLabel : "create a view"
			, sFile : "__.SP.filter.js"
		} ) )
		.then( __.SP.taxonomy, "getTermIds", "get taxonomy term ids" )
		.then( function( args ) {
			var async = __.Async.promise( args );
			var oFields = that.read();
			for( var sField in oFields ) {
				var oField = oFields[ sField ];
				if( oField.v && oField.sCAMLType == "taxonomy" ) {
					async.then( __.SP.taxonomy, "load", {
						  sTermSet : O$C3.Tax.guidTermSet[ oField.sName ]
					}, "load " + oField.sName )
				}
			}
			async.resolve();
		}, "load taxonomies" )
		.then( function( args ) {
			xmlQuery += that.form2caml();
			__.Async.promise( args ).resolve();
		}, "construct query" )
		.clear()
		.then( __.SP.view, "list", {
			  sList : that.sList
		}, "get list of views" )
		.then( function( args ) {
			var async = __.Async.promise( args );
			var sMode = ( __.l.contains( args.lsViews, sName ) ) ? "update" : "add";
			async.resolve( { sMode : sMode } );
		}, "decide wether to create or update" )
		.then( __.SP.view, "read", {
			  sList : that.sList
			, sView : ctx.viewTitle
		}, "read current view" )
		.then( function( args ) {
			var xml = args.kv.xmlQuery;
			var xmlGroup = "";
			var xmlSort = "";
			var lsParts = xml.match( /(<GroupBy.*?<\/GroupBy>)/ );
			if( lsParts && lsParts.length ) {
				xmlGroup = lsParts[ 1 ];
			}
			var lsParts = xml.match( /(<SortBy.*?<\/SortBy>)/ );
			if( lsParts && lsParts.length ) {
				xmlSort = lsParts[ 1 ];
			}
			xmlQuery = xmlQuery + xmlGroup + xmlSort;
			__.Async.promise( args ).resolve();
		}, "extract grouping and sorting" )
		.then( function( args ) {
			var async = __.Async.promise( args );
			switch( args.sMode ) {
				case "add" :
					async.then( __.SP.view, "add", {
						  sList : that.sList
						, sView : sName
						, xmlQuery : xmlQuery
						, nRows : args.kv.nRows
						, bPaging : args.kv.bPaging
						, sTotal : args.kv.sTotal
						, lsFields : args.kv.lsFields
						, bPublic : false
					}, "add personal view" )
				break;
				case "update" :
					async.then( __.SP.view, "update", {
						  sList : that.sList
						, sView : sName
						, xmlQuery : xmlQuery
						, nRows : args.kv.nRows
						, bPaging : args.kv.bPaging
						, sTotal : args.kv.sTotal
						, lsFields : args.kv.lsFields
						, bPublic : false
					}, "update personal view" )
				break;
			}
			async.resolve();
		}, "add or update view" )
		.then( __.SP.view, "read", "read view for guid" )
		.then( function( args ) {
			cbfn( args.kv.guid );
			__.Async.promise( args ).resolve();
		}, "invoke callback" )
		.start();
	}
	, filter : function() {
		var that = this;
		var sView = that.sFilterName;
		this.lock();
		this.createView( sView, function( guid ) {
			console.log( guid );
			that.guidFilter = guid;
			that.loadPersonalView( guid );
		} );
	}
	// CALLBACK for sidebar?
	, save : function( sView ) {
		var that = this;
		this.createView( sView, function( guid ) {
			var url = that.createPersonalViewUrl( guid );
			self.location.href = url;
			/*
			( new __.Async( {
				  sLabel : "Save a filter search"
				, sFile : "__.SP.filter.js"
				, fnstat: function( a ){
					if( a.sMsg && that.oModal ) {
						that.oModal.progress( a.sMsg );
					}
				}
			} ) )
			.then( function( args ) {
				that.oModal.close();
				__.SP.grid.reload();
				__.Async.promise( args ).resolve();
			}, "Filter successfully saved" )
			.start();
			*/
			/*
			.then( __.SP.list, "read", {
				  sList : "SideBar"
				, lsFields : [ "ID", "Title" ]
				, xmlQuery : "<Query><Where><Eq><FieldRef Name='sAction' /><Value Type='Text'>#saved_filters</Value></Eq></Where></Query>"
			}, "read filter box id from sidebar" )
			.then( function( args ) {
				if( args.lkv && args.lkv[ 0 ] ) {
					var idParent = args.lkv[ 0 ].ID;
					var sParent = args.lkv[ 0 ].Title;
					delete args.lkv;
					var xmlcur = "<Query><Where><And>";
					xmlcur += "<Eq><FieldRef Name='Title' /><Value Type='Text'>" + sView + "</Value></Eq>";
					xmlcur += "<Eq><FieldRef Name='sParent' /><Value Type='Text'>" + sParent + "</Value></Eq>";
					xmlcur += "</And></Where></Query>"
					__.Async.promise( args ).resolve( {
						  idParent : idParent
						, sParent : sParent
						, xmlQuery : xmlcur
					} );
				}
				else {
					__.Async.promise( args ).reject( { sError: "no box for links" } );
				}
			}, "construct query to search for duplicate"  )
			.then( __.SP.list, "read", {
				  sList : "SideBar"
				, lsFields : [ "ID" ]
			}, "query sidebar for duplicates" )
			.then( function( args ) {
				var async = __.Async.promise( args );
				if( __.l.empty( args.lkv ) ) {
					async.then( __.SP.item, "create", {
						  sList : "SideBar"
						, kv : {
							  Title : sView
							, sParent : args.idParent
							, sAction : url
							, bShown : 1
							, nOrder : 1
						}
					}, "create new entry" )
					.then( function( args ) {
						var async = __.Async.promise( args );
						async.then( __.SP.item, "restrictToUser", {
							  sList : "SideBar"
							, id : args.idItem
							, xUser: _spPageContextInfo.userId
							, sRole: "Edit"
						}, "set permissions" ).resolve();
					} )
					.then( function() {
						var h = '';
						h += '<li>';
						h += '<a href="' + url + '">' + sView + '</a>';
						h += '</li>';
						// get proper box
						__.dn_( "#osce-sidebar h2", function( dn ) {
							if( dn.textContent == "Saved Filters" ) {
								var dnBox = dn.nextElementSibling;
								__.dn.append( h, dnBox );
							}
						} );
						__.Async.promise( args ).resolve();
					}, "manually add to sidebar" );
				}
				else {
					var id = args.lkv[ 0 ].ID;
					async.then( __.SP.item, "update", {
						  sList : "SideBar"
						, id : id
						, kv : {
							  Title : sView
							, sAction : url
						}
					}, "update existing sidebar entry" )
				}
				async.resolve();
			}, "create or update sidebar" )
			*/
		} );
	}
	, bDuplicateFilterName : function( sName ) {
		// iterate sidebar titles for "Saved Filters"
		var b = false;
		__.dn_( "h2", __.dn_( "#osce-sidebar" ), function( dnTitle ) {
			if( dnTitle.textContent == "Saved Filters" ) {
				// iterate all saved links
				var dnBox = __._dn( "div.osce-left-bar", dnTitle )
				__.dn_( "a", dnBox, function( dnLink ) {
					if( dnLink.textContent.trim() == sName ) {
						b = true;
					}
				} );
			}
		} );
		return b;
	}
	, openSaveWindow : function() {
		var that = this;
		var h = "<p>";
		h += "You can save the current search as list view. This enables you export the entire search";
		h += " result to Excel.</p>";
		h += "<p>Please enter a name for this new view:</p>";
		h += "<p>";
		h += "<input maxlength='50' type='text' name='sName' style='width:300px;font-size:1.3em;'/>";
		h += "<br><em class='maxlength' style='float:left'>(max. 50 characters)</em>";
		h += "<br></p>";
		this.oModal = __.SP.modal.open( {
			  sTitle : "Save Search as View"
			, hContent : h
			, fnok : function() {
				alert( "OK" );
			}
			, fnerr : function() {
				alert( "err" );
			}
			, fnact : function() {
				that.oModal.message( "" );
				var dnValue = __.dn_( "[name='sName']", that.oModal.dn );
				var sName = __.s.sanitize( dnValue.value );
				if( sName  ) {
					( new __.Async( { sLabel : "check duplicate filter" } ) )
					.then( __.SP.view, "list", {
						  sList : O$C3.OSCEContacts.sList
					}, "get list of views" )
					.then( function( args ) {
						var async = __.Async.promise( args );
						if( __.l.contains( args.lsViews, sName ) ) {
							var d = __.SP.modal.confirm( {
								  sTitle : "Confirm this action"
								, sQuestion : O$C3.Lang.saved_filter_name_exists_overwrite
								, fnAnswer : function( b ) {
									that.oModal.close();
									if( b ) {
										that.save( sName );
									}
								}
							} );
						}
						else {
							that.oModal.close();
							that.save( sName );
						}
						async.resolve();
					}, "check if view already exists" )
					.start();
				}
				else {
					// REF: do we overwrite the loading gif here? i.e. after entering name no loading gif?
					that.oModal.message( "Please enter a name" );
				}
			}
		} );
	}
	, openFilterFieldWindow : function() {
		var that = this;
		// first get all filter fields
		var sChecked = " checked ";
		var h = "<p>";
		h += O$C3.Lang.filter_field_selection_title;
		h += "</p>";
		h += "<table>";
		this.loFields.forEach( function( aField ) {
			if( aField.nFilter ) {
				var sDisabled = ( aField.sName == "FrontOffice" )
					? " disabled "
					: "";
				var sChecked = ( __.l.contains( that.lsFilterFields, aField.sName ) )
					? " checked "
					: "";
				h += "<tr>";
				h += "<td><input name='" + aField.sName + "'type='checkbox' ";
				h += sChecked + sDisabled + "'></input></td>";
				h += "<td title='" + aField.sDescription + "'>";
				h += aField.sDisplayName + " (" + aField.sFO + ")</td>";
				h += "</tr>";
			}
		} );
		h += "</table>";
		var dnModal = __.SP.modal.open( {
			  sTitle : "Manage filter fields"
			, hContent : h
			, fnact : function( oModal ) {
				that.updateFilterFields( oModal );
				dnModal.close();
				that.update();
			}
		} );
	}
	, toggleFilterFields : function() {
		var that = this;
		__.dn_( ".osce-form-field", this.dnRoot, function( dn ) {
			var sid = dn.getAttribute( "sName" );
			if( __.l.contains( that.lsFilterFields, sid ) ) {
				dn.classList.remove( "hide" );
			}
			else {
				dn.classList.add( "hide" );
			}
		} );
	}
	, getFilterFields : function() {
		var that = this;
		var slsFilterFields = localStorage.getItem( this.sFilterFieldStore );
		if( ! slsFilterFields ) {
			// load default values
			this.lsFilterFields = [];
			this.loFields.forEach( function( oField ) {
				that.lsFilterFields.push( oField.sName );
			} );
			localStorage.setItem( this.sFilterFieldStore, __.o.s( this.lsFilterFields ) );
		}
		else {
			// otherwise use local storage
			this.lsFilterFields = __.s.o( slsFilterFields );
		}
	}
	, updateFilterFields : function( oModal ) {
		var that = this;
		this.lsFilterFields = [];
		__.dn_( "[name]", oModal.dn, function( dn ) {
			if( dn.checked ) {
				that.lsFilterFields.push( dn.getAttribute( "name" ) );
			}
		} );
		localStorage.setItem( this.sFilterFieldStore, __.o.s( this.lsFilterFields ) );
	}
} );




__.SP.filter.form = {};
__.SP.filter.form.create = function( args ) {
	var h = "<form class='osce-form'></form>";
	var dn = __.dn.append( h, args.dnRoot );
	args.loFields.forEach( function( oField ) {
		oField.dnRoot = dn;
		oField.idFilter = args.idFilter;
		__.SP.filter.form.field[ oField.sFormType ].create( oField );
	} );
	dn.addEventListener( "change", function() {
		if( args.cbChange ) {
			args.cbChange();
		}
	} );
	var fnModal = function() {
		var dn = __.dn_( ".ms-dlgContent" );
		if( ! dn ) {
			if( args.cbChange ) {
				args.cbChange();
			}
		}
		else {
			setTimeout( fnModal, 500 );
		}
	}
	dn.addEventListener( "click", function( e ) {
		// monitor closing of taxonomy modal
		if( e.target.classList.contains( "ms-taxonomy-browser-button" ) ) {
			setTimeout( fnModal, 500 );
		}
		// prevent manual manipulation of the taxonomy picker DIV
		if( e.target.classList.contains( "ms-inputBox" ) ) {
			var dnRoot = __._dn( ".osce-form-field", e.target );
			var dnImg = __.dn_( "img.ms-taxonomy-browser-button", dnRoot );
			dnImg.click();
		}
	} );
	return dn;
};

__.SP.filter.form.reset = function( dn ) {
	// clear all taxonomy fields
	__.dn_( '[role="textbox"]', dn, function( dn ) {
		dn.innerHTML = "";
	} );
	__.dn_( '.osce-v', dn, function( dn ) {
		dn.value = "";
	} );
	// and reset the form
	dn.reset();
};

__.SP.filter.form.read = function( dn ) {
	var kv = {};
	__.dn_( ".osce-form-field", dn, function( dn ) {
		var sid = dn.getAttribute( "sid" );
		var sFormType = dn.getAttribute( "sFormType" );
		kv[ sid ] = {
			  v : __.SP.filter.form.field[ sFormType ].get( dn )
			, sName : dn.getAttribute( "sName" )
			, sCAMLType : dn.getAttribute( "sCAMLType" )
			, sOperator : dn.getAttribute( "sOperator" ) || null
		}
	} )
	return kv;
};

__.SP.filter.form.field = {};


__.SP.filter.form.field.sid = function( x ) {
	// we need unique ids, sName might be used mulitple times,
	// e.g. from/to date fields
	var sid = "";
	if( x instanceof Element ) {
		sid += __._dn( ".osce-filter", x ).id;
		sid += __.s.tokenize( x.getAttribute( "sOperator" ) + x.getAttribute( "sName" ) );
	}
	else if( x.idFilter && x.sDisplayName ) {
		sid += x.idFilter;
		sid += __.s.tokenize( x.sOperator + x.sName );
	}
	else {
		console.warn( "parameter is no filter form argument", x );
		return null;
	}
	return sid;
};

__.SP.filter.form.field.hHeader = function( args ) {
	var cssHalfSize = ( args.bHalfSize ) ? " half-size" : "";
	var h = "<div class='osce-form-field" + cssHalfSize + "' ";
	h += ( args.sOperator ) ? " sOperator='" + args.sOperator + "' " : "";
	h += " sFormType='" + args.sFormType + "'";
	h += " sCAMLType='" + args.sCAMLType + "'";
	h += " sName='" + args.sName + "'";
	h += " sid='" + __.SP.filter.form.field.sid( args ) + "'>";
	h += "<label>" + args.sDisplayName + "</label><br />";
	return h;
};

__.SP.filter.form.field.text = {
	  create : function( args ) { //  dnRoot, sid, sDisplayName ) {
		var h = __.SP.filter.form.field.hHeader( args );
		h += "<input class='osce-v'></input>";
		h += "</div>";
		__.dn.append( h, args.dnRoot );
	}
	, get : function( dn ) {
		var v = __.dn_( ".osce-v", dn ).value;
		return ( v ) ? v : null;
	}
	, set : function( dn, v ) {
		var v = __.dn_( ".osce-v", dn ).value = v;
	}
};

__.SP.filter.form.field.lookupdate = {
	  create : function( args ) { //  dnRoot, sid, sDisplayName ) {
		var sid = __.SP.filter.form.field.sid( args );
		var h = __.SP.filter.form.field.hHeader( args );
		h += "<input id='" + sid + "' class='osce-v date' maxlength='45'></input>";
		h += '<a href="#" role="button" onclick="clickDatePicker( ';
		h += "'" + sid + "'";
		h += ", '" + _spPageContextInfo.siteServerRelativeUrl;
		h += "/_layouts/15/iframe.aspx?cal=1&amp;lcid=2057&amp;langid=1033&amp;tz=00:59:59.9990041&amp;ww=0111110&amp;fdow=1&amp;fwoy=0&amp;hj=0&amp;swn=false&amp;minjday=109207&amp;maxjday=2666269&amp;date='";
		h += ', \'\', event); return false;">';
		h += '<img id="' + sid + 'DatePickerImage" src="/_layouts/15/images/calendar_25.gif?rev=23"';
		h += ' border="0" class="osce-sp-calendar" alt="Select a date from the calendar.">';
		h += '</a>';
		h += '<iframe id="' + sid + 'DatePickerFrame" src="/_layouts/15/images/blank.gif?rev=23" ';
		h += ' frameborder="0" scrolling="no" style="display:none; position:absolute; width:200px; z-index:101;" ';
		h += ' title="Select a date from the calendar."></iframe>';
		h += "</div>";
		__.dn.append( h, args.dnRoot );
	}
	, get : function( dn ) {
		var v = __.dn_( ".osce-v", dn ).value;
		if( v ) {
			var nDate = v.split( "/" ).reverse().join( "" );;
			return nDate;
		}
		return null;
	}
	, set : function( dn, v ) {
		if( v ) {
			var lsMatch = v.match( /(....)(..)(..)/ );
			var sDate = lsMatch[ 3 ] + "/" + lsMatch[ 2 ] + "/" + lsMatch[ 1 ];
			__.dn_( ".osce-v", dn ).value = sDate;
		}
	}
};


__.SP.filter.form.field.autocomplete = {
	  create : function( args ) { //  dnRoot, sid, sDisplayName ) {
		var h = __.SP.filter.form.field.hHeader( args );
		h += "<input class='osce-v'></input>";
		h += "</div>";
		var fnFetch = function( sTerm, cbfn ) {
			var xmlQuery = "<Query><Where><Contains>"
			xmlQuery += "<FieldRef Name='" + args.sLookupField + "' />";
			xmlQuery += "<Value Type='Text'>" + sTerm +"</Value>";
			xmlQuery += "</Contains></Where></Query>";
			xmlQuery += "<RowLimit>" + ( args.nLimit || 10 ) + "</RowLimit>";
			( new __.Async( { sLabel : "filter_form_lookup" } ) )
			.then( __.SP.list, "read", {
				  sList : args.sLookupList
				, lsFields : [ args.sLookupField ]
				, xmlQuery : xmlQuery
			}, "read lookup list for form filter" )
			.then( function( args ) {
				if( cbfn ) {
					cbfn( args.lkv );
				}
				__.Async.promise( args ).resolve();
			} )
			.start();
		};
		var dnLookup = __.dn.append( h, args.dnRoot );
		__.autocomplete.init( {
			  dn : __.dn_( "input", dnLookup )
			, sField : args.sLookupField
			, fnFetch : fnFetch
			, cb : function( rec ) {
				//
			}
		} );
	}
	, get : function( dn ) {
		var v = __.dn_( ".osce-v", dn ).value;
		return ( v ) ? v : null;
	}
	, set : function( dn, v ) {
		var v = __.dn_( ".osce-v", dn ).value = v;
	}
};

// __.SP.filter.form.field.checkbox.create( { dnRoot : __.dn_( "#sideNavBox" ), sid: "qwer", sDisplayName : "a checkbox field" } )
// __.SP.filter.form.field.checkbox.value( "qwer" );
__.SP.filter.form.field.checkbox = {
	  create : function( args ) { // dnRoot, sid, sDisplayName ) {
		var h = __.SP.filter.form.field.hHeader( args );
		h += "<select class='osce-v'>";
			h += "<option value=''></option>";
			h += "<option value='Yes'>Yes</option>";
			h += "<option value='No'>No</option>";
		h += "</select>";
		h += "</div>";
		__.dn.append( h, args.dnRoot );
	}
	, get : function( dn ) {
		var v = __.dn_( ".osce-v", dn ).value;
		return ( v ) ? v : null;
	}
	, set : function( dn, v ) {
		var v = __.dn_( ".osce-v", dn ).value = v;
	}
};

// __.SP.filter.form.field.choice.create( { dnRoot : __.dn_( "#sideNavBox" ), sid: "test", sDisplayName : "a choice field", lsChoices : [ "asdf", "qwer" ] } )
// __.SP.filter.form.field.taxonomy.value( "test" );
__.SP.filter.form.field.choice = {
	  create : function( args ) { //  dnRoot, sid, sDisplayName, lsChoices ) {
		var h = __.SP.filter.form.field.hHeader( args );
		h += "<select class='osce-v'>";
		h += "<option value=''></option>";
		args.lsChoices.forEach( function( s ) {
			h += "<option value='" + s + "'>" + s + "</option>";
		} );
		h += "</select>";
		h += "</div>";
		__.dn.append( h, args.dnRoot );
	}
	, get : function( dn ) {
		var v = __.dn_( ".osce-v", dn ).value;
		return ( v ) ? v : null;
	}
	, set : function( dn, v ) {
		var v = __.dn_( ".osce-v", dn ).value = v;
	}
};

// need to load the following in masterpage: sp.Taxonomy.js, scriptforwebtaggingui.js
// __.SP.filter.form.field.taxonomy.create( { dnRoot : __.dn_( "#sideNavBox" ), sid : "MainCat", sDisplayName : "Main Contact Type", idTermSet : O$C3.Tax.guidTermSet.MainContactType} );
// __.SP.filter.form.field.taxonomy.value( "MainCat" );
__.SP.filter.form.field.taxonomy = {
	  create : function( args ) { // dnRoot, sid, sDisplayName, idTermSet ) {
		var sid = __.SP.filter.form.field.sid( args );
		var sidPicker = sid + "_picker";
		var sidInput = sid + "_input";
		var h = __.SP.filter.form.field.hHeader( args );
		h += '<input class="osce-v" name="' + sidInput + '" type="hidden" ';
		h += ' id="' + sidInput + '"></input>';
		h += '<div id="' + sidPicker + '" class="ms-taxonomy">';
		h += '</div>';
		h += "</div>";
		var dn = __.dn.append( h, args.dnRoot );
		var sspId = O$C3.Tax.guidTermStore;
		var url = _spPageContextInfo.webServerRelativeUrl;
		url += '\u002f_vti_bin\u002fTaxonomyInternalService.json';
		var dnPicker = __.dn_( "#" + sidPicker );
		dnPicker.InputFieldId = sidInput;
		dnPicker.SspId = sspId;
		  // REF: put Tax object into __.SP.taxonomy!!!
		dnPicker.TermSetId = O$C3.Tax.guidTermSet[ args.sName ];
		dnPicker.AnchorId = '00000000-0000-0000-0000-000000000000';
		dnPicker.IsMulti = true;
		dnPicker.AllowFillIn = false;
		dnPicker.IsSpanTermSets = false;
		dnPicker.IsSpanTermStores = false;
		dnPicker.IsIgnoreFormatting = false;
		dnPicker.IsIncludeDeprecated = false;
		dnPicker.IsIncludeUnavailable = false;
		dnPicker.IsIncludeTermSetName = false;
		dnPicker.IsAddTerms = false;
		dnPicker.IsIncludePathData = false;
		dnPicker.IsUseCommaAsDelimiter = false;
		dnPicker.Disable = false;
		dnPicker.ExcludeKeyword = false;
		dnPicker.JavascriptOnValidation = "";
		dnPicker.DisplayPickerButton = true;
		dnPicker.Lcid = 1033;
		dnPicker.FieldName = '';
		dnPicker.FieldId = '00000000-0000-0000-0000-000000000000';
		dnPicker.WebServiceUrl = url;
		Microsoft.SharePoint.Taxonomy.ScriptForWebTaggingUI.resetEventsRegistered();
		Microsoft.SharePoint.Taxonomy.ScriptForWebTaggingUI.onLoad( sidPicker );
	}
	, get : function( dn ) {
		var lv = __.dn_( '.osce-v', dn ).value.trim().split( ";" );
		var kv = {};
		lv.forEach( function( s ) {
			if( s ) {
				var ls = s.split( "|" );
				kv[ ls[ 0 ] ] = ls[ 1 ];
			}
		} );
		return ( __.o.empty( kv ) ) ? null : kv;
	}
	, set : function( dn, aTermInfos ) {
		var sName = aTermInfos.sName
		var guid = aTermInfos.guid;
		if( sName && guid ) {
			var dnDisplay = __.dn_( "[role='textbox']", dn );
			dnDisplay.innerHTML += "<span class='valid-text' title='" + sName + "'>" + sName + "</span>;&nbsp;";
			var dnHidden = __.dn_( "input", dn );
			var vnew = sName + "|" + guid;
			var lsvHidden = [];
			if( dnHidden.value ) {
				lsvHidden = dnHidden.value.split( ";" );
			}
			lsvHidden.push( vnew );
			dnHidden.value = lsvHidden.join( ";" );
		}
		else {
			console.warn( "warn: invalid term info", sTerm );
		}
	}
}; 





__.SP.form = {
	getField : function( x ) { // x: either internal name or DOM node inside field row
		var dnForm = __.dn_( "#WebPartWPQ2" );
		var url = self.location.href;
		if( /DispForm\.aspx/.test( url ) ) {
			if( typeof x == "string" ) {
				var dnTitle = __.dn_( 'a[name="SPBookmark_' + x + '"]', dnForm );
				var dnRow = __._dn( "tr", dnTitle );
				var dnValue = __.dn_( "td.ms-formbody", dnRow );
				var v = ( dnValue.textContent )
					? __.s.tokenize( dnValue.textContent )
					: null;
				return {
					  dnTitle : dnTitle
					, dnRow : dnRow
					, dnValue : dnValue
					, v : v
				}
			}
		}
		else if( /NewForm\.aspx|EditForm\.aspx/.test( url ) ) {
			if( x instanceof Element ) {
				var dnRow = __._dn( "tr", x );
				var sField = __.dn_( "h3", dnRow ).id;
				var dnValue = ( x.value ) ? x : __.dn_( "input,textarea", dnRow );
				var v = dnValue.value;
				return {
					  sField : sField
					, dnRow : dnRow
					, dnValue : dnValue
					, v : v
				}
			}
		}
	}
};
/**
 * Collection of methods dealing with functionality around list views of SharePoint lists.
 * @namespace __.SP.grid
 * @memberof __.SP
 */

__.SP.grid = {
	/**
	 * Returns item data of the current list view.
	 * Includes only data displayed in the view.
	 * @memberof __.SP.grid
	 * @method oData
	 * @todo rename to aListData or aData
	 * @todo test return example
	 * @example __.SP.grid.oData();
	 * @returns {Object} object of item data arranged by item IDs
	 * Example:
	 * <pre>
	 * {
	 *     11 : { ID : 11, Title : "title 1", Email : "test1@abc.com" }
	 *   , 13 : { ID : 13, Title : "title 2", Email : "test2@abc.com" }
	 * }
	 * </pre>
	 */
	  oData : function() {
		var o = {};
		ctx.ListData.Row.forEach( function( oData ) {
			o[ oData.ID ] = oData;
		} );
		return o;
	}
	/**
	 * Returns DOM node of the list webpart
	 * @memberof __.SP.grid
	 * @method dnWebpart
	 * @example var dnWebpart = __.SP.grid.dnWebpart();
	 * @returns {Node} DOM node of the list webpart
	 */
	, dnWebpart : function() {
		return __.dn_( "#scriptWPQ2" );
	}
	/**
	 * Returns DOM node of the list webpart's main table
	 * @memberof __.SP.grid
	 * @method dnGrid
	 * @example var dnGrid = __.SP.grid.dnGrid();
	 * @returns {Node} DOM node of the main table
	 */
	, dnGrid : function() {
		return __.dn_( "table[summary]" );
	}
	/**
	 * Returns item data of the currently selected items.<br>
	 * Includes only data displayed in the view.
	 * @memberof __.SP.grid
	 * @method selection
	 * @todo test return example
	 * @example __.SP.grid.selection();
	 * @returns {Object} object of item data arranged by item IDs
	 * Example:
	 * <pre>
	 * {
	 *     11 : { ID : 11, Title : "title 1", Email : "test1@abc.com" }
	 * }
	 */
	, selection : function() {
		var oData = __.SP.grid.oData();
		var loItems = SP.ListOperation.Selection.getSelectedItems();
		loItems.forEach( function( oItem ) {
			__.o.add( oItem, oData[ oItem.id ] );
		} );
		return loItems;
	}

	/**
	 * Clears current selection of items in list.
	 * @memberof __.SP.grid
	 * @method clearSelection 
	 * @example __.SP.grid.clearSelection();
	 */
	, clearSelection : function() {
		__.dn_( ".s4-itm-selected", function( dn, ix ) {
			setTimeout( function() {
				__.dn_( ".ms-selectitem-span", dn ).click();
			}, ix );
		} );
	}

	/**
	 * Locks the list webpart by greying it out and preventing any
	 * user interactions with the list.
	 * @memberof __.SP.grid
	 * @method lock
	 * @example __.SP.grid.lock();
	 */
	, lock : function() {
		var dnWebpart = this.dnWebpart();
		if( dnWebpart ) {
			__.lock.up( dnWebpart );
		}
	}

	/**
	 * Unlocks the webpart enabling user interactions again.
	 * @memberof __.SP.grid
	 * @method unlock
	 * @example __.SP.grid.unlock();
	 */
	, unlock : function() {
		var dnWebpart = this.dnWebpart();
		if( dnWebpart ) {
			__.lock.un( dnWebpart );
		}
	}

	/**
	 * Refreshes the list view without reloading the entire page. 
	 * @memberof __.SP.grid
	 * @method reload
	 * @todo test replacing return false in catch with page reload?
	 * @example __.SP.grid.reload();
	 */
	, reload : function( ms ) {
		ms = ms || 0;
		console.log( ">>>>>>>>>>>" + ms );
		setTimeout( function() {
			var dn = __.dn_( "#ManualRefresh" );
			if( dn ) {
				dn.click();
			}
			else {
				try {
					var idList = SP.ListOperation.Selection.getSelectedList();
					idList = idList.toLowerCase().replace( "-", "_" ).replace( "{", "" ).replace( "}", "" );
					__doPostBack( "ctl00$m$g_" + idList + "$ctl02", "cancel" );
				} catch( e ) {
					return false;
				}
			}
			return true;
		}, ms );
	}
};

__.SP.icon = {
	mp : {
		  "default" : "/_layouts/15/images/Osce/danger.png"
		, dirty : "/_layouts/15/images/Osce/danger.png"
		, closed : "/_layouts/15/images/lockoverlay.png"
		, record : "/_layouts/15/images/lockoverlay.png"
		, unmarked : "/_layouts/15/images/Osce/lockoverlay-green.png"
		, yearlyFolder : "/_layouts/15/images/Osce/YF.png"
		, obsolete : "/_layouts/15/images/Osce/overlay-SO.png"
		, smallDanger : "/_layouts/15/images/Osce/danger-small.png"
		, bigDanger : "/_layouts/15/images/warning70by70.gif"
		, loading : "/_layouts/15/images/Osce/fancytree-loading.gif"
	}
};
// ==ClosureCompiler==
// @compilation_level ADVANCED_OPTIMIZATIONS
// @js_externs var __; __.SP; __.SP.item; 
// ==/ClosureCompiler==


/**
 * @namespace __.SP.item
 * @memberof __.SP
 */

__.SP.item = {
	/**
	 * Creates an item in a list
	 * @memberof __.SP.item
	 * @method create
	 * @example
	 * __.SP.item.create( {
	 * 	  sList : "Shared Documents"
	 *	, lsFields : [ "Title", "ID" ]
	 *	, xmlQuery : "<Query><Where><FieldRef Name='ID' /><Lt><Value Type='Number'>5</Value></Lt></Where></Query>"
	 * } );
	 * @param {Object} args a parameter object holding the following values
	 * @param {String} args.sList name or guid of a list
	 * @param {Array} args.lsFields array of field names to be returned
	 * @param {String} [args.sSite] Url of a site (defaults to current)
	 * @param {String} [args.pathSearch] folder path to start search from
	 * @param {String} [args.xmlQuery] optional CAML query otherwise entire list is returned
	 * @returns {Object} Resolved promise holding the following values 
	 * <pre class='return-object'>
	 * lkv | (Object) | array of key value pairs
	 * </pre>
	 */
	/** 
	 * Create an item.
	 */
	  create : function( args ) { // sList, kv
		var async = __.Async.promise( args );
		// get context
		var ctx = __.SP.ctx();
		// get list
		var oList = __.SP.list.get( ctx, args.sList );
		var oInfo = new SP.ListItemCreationInformation();
		var oItem = oList.addItem( oInfo );
		// iterate through key/value pair
		for( var k in args.kv ) {
			var v = args.kv[ k ];
			if( typeof v == "object" ) {
				if( v.id ) {
					var o = new SP.FieldLookupValue();
					o.set_lookupId( v.id );
					oItem.set_item( k, o );
				}
			}
			else {
				oItem.set_item( k, v );
			}
		}
		// update the item
		oItem.update();
		// and invoke "load" on context
		ctx.load( oItem );
		// call the helper function handle the request
		__.SP.exec( ctx, oItem, function( oItem ) {
			if( oItem.sError ) {
				async.reject( oItem.sError );
			}
			else {
				async.resolve( {
					  oItem : oItem
					, idItem : oItem.get_id()
				} );
			}
		} );
	}
	/** 
	 * Update fields of an item.
	 */
	, update : function( args ) { // sList, id, kv
		var async = __.Async.promise( args );
		// get context
		var ctx = __.SP.ctx();
		// get list
		var oList = __.SP.list.get( ctx, args.sList );
		// get the item by ID
		var oItem = oList.getItemById( args.id );
		// iterate through key/value pair
		for( var k in args.kv ) {
			var v = args.kv[ k ];
			if( typeof v == "object" ) {
				if( v.lookup ) {
					var lo = [];
					v.lookup.forEach( function( id ) {
						var oLookup = new SP.FieldLookupValue();
						oLookup.set_lookupId( id );
						lo.push( oLookup );
					
					} );
					oItem.set_item( k, lo );
				}
				if( v.choice ) {
					oItem.set_item( k, v.choice.join( "," ) );
				}
			}
			else {
				oItem.set_item( k, v );
			}
		}
		// update the item
		oItem.update();
		// and invoke "load" on context
		ctx.load( oItem );
		// call the helper function handle the request
		__.SP.exec( ctx, oItem, function( oItem ) {
			if( oItem.sError ) {
				async.reject( oItem.sError );
			}
			else {
				async.resolve( { oItem : oItem } );
			}
		} );
	}
	/** 
	 * Read fields from an item.
	 */
	, read : function( args ) { // sList, id, lsFields
		var async = __.Async.promise( args );
		// get context
		var ctx = __.SP.ctx();
		// get list
		var oList = __.SP.list.get( ctx, args.sList );
		// get item by ID
		var oItem = oList.getItemById( args.id );
		// in case we pass on additional parameters such as custom
		// field names to be fetched we do this in an array and...
		var lsFields = args.lsFields;
		var _args = __.o.copy( args.lsFields );
		if( lsFields ) {
			// construct the arguments list for the 'load' call
			// by preceding the arguments with the item [oItem]
			_args.unshift( oItem );
		}
		else {
			// and we prepare the arguments list with the item only
			_args = [ oItem ];
		}
		// invoke the "load" call in context of context with lsFields list
		ctx.load.apply( ctx, _args );
		// call the helper function handle the request
		__.SP.exec( ctx, oItem, function( oItem ) {
			var convert = function( sField, oField ) {
				var kv = {};
				if( oField.get_termGuid ) {
					kv[ sField ] = oField.get_label();
					kv[ "guid" + sField ] = oField.get_termGuid();
				}
				else if( oField && oField.get_lookupId ) {
					console.log( sField );
					console.log( oField.get_lookupValue() );
					console.log( oField.get_lookupId() );
					kv[ sField ] = oField.get_lookupValue();
					kv[ "id" + sField ] = oField.get_lookupId();
				}
				else {
					kv[ sField ] = oField;
				}
				return kv;
			}
			if( oItem.sError ) {
				async.reject( oItem.sError );
			}
			else {
				var kv = {};
				lsFields.forEach( function( sField ) {
					var oField = oItem.get_item( sField );
					var _kv = {};
					if( typeof oField != "undefined" && oField ) {
						if ( oField instanceof Array ) {
							_kv[ sField ] = [];
							oField.forEach( function( o ) {
								_kv[ sField ].push( convert( sField, o ) );
							} );
						}
						else {
							_kv = convert( sField, oField );
						}
					}
					__.o.add( kv, _kv );
				} );
				async.resolve( { oItem : oItem, kv : kv } );
			}
		} );
	}
//	__.SP.item.breakInheritance( { sList : "DossierInfos", id: 6 } ) 
	, breakInheritance : function( args ) { // sList, id
		var async = __.Async.promise( args );
		var ctx = __.SP.ctx();
		var oList = __.SP.list.get( ctx, args.sList );
		var oItem = oList.getItemById( args.id );
		oItem.breakRoleInheritance( false );
		ctx.load( oItem );
		__.SP.exec( ctx, oItem, function( oItem ) {
			if( oItem.sError ) {
				async.reject( oItem.sError );
			}
			else {
				async.resolve();
			}
		} );
	}
//	__.SP.item.resetInheritance( { sList : "DossierInfos", id: 12 } ) 
	, resetInheritance : function( args ) { // sList, id
		var async = __.Async.promise( args );
		var ctx = __.SP.ctx();
		var oList = __.SP.list.get( ctx, args.sList );
		var oItem = oList.getItemById( args.id );
		oItem.resetRoleInheritance();
		ctx.load( oItem );
		__.SP.exec( ctx, oItem, function( oItem ) {
			if( oItem.sError ) {
				async.reject( oItem.sError );
			}
			else {
				async.resolve();
			}
		} );
	}
//	__.SP.item.addGroup( { sList : "DossierInfos", id: 7, sGroup: O$C3.FOUser.oSettings.sFrontOffice, sRole: "Read"  } ) 
	, addGroup : function( args ) { // sList, id, sGroup, sPermission
		/* sRole: Contribute,Custom Levelname,Read,Edit */
		var async = __.Async.promise( args );
		var ctx = __.SP.ctx();
		var oList = __.SP.list.get( ctx, args.sList );
		var oItem = oList.getItemById( args.id );
		ctx.load( oItem );
		var oGroups = ctx.get_web().get_siteGroups();
		var oGroup = oGroups.getByName( args.sGroup );
		var oBinding = SP.RoleDefinitionBindingCollection.newObject( ctx );
		var oRole = ctx.get_web().get_roleDefinitions().getByName( args.sRole );
		oBinding.add( oRole );
		 oItem.get_roleAssignments().add( oGroup, oBinding );
		__.SP.exec( ctx, oItem, function( oItem ) {
			if( oItem.sError ) {
				async.reject( oItem.sError );
			}
			else {
				async.resolve();
			}
		} );
	}
	// __.SP.item.restrictToGroup( { sList : "DossierInfos", id: 7, sGroup: O$C3.FOUser.oSettings.sFrontOffice, sRole: "Read"  } ) 
	, restrictToGroup : function( args ) { // sList, id, sGroup, sRole
		/* sRole: Contribute,Custom Levelname,Read,Edit */
		var async = __.Async.promise( args );
		var ctx = __.SP.ctx();
		var oList = __.SP.list.get( ctx, args.sList );
		var oItem = oList.getItemById( args.id );
		console.log( oItem );
		ctx.load( oItem );
		var oGroups = ctx.get_web().get_siteGroups();
		var oGroup = oGroups.getByName( args.sGroup );
		var oBinding = SP.RoleDefinitionBindingCollection.newObject( ctx );
		var oRole = ctx.get_web().get_roleDefinitions().getByName( args.sRole );
		oBinding.add( oRole );
		oItem.breakRoleInheritance( false );
		oItem.get_roleAssignments().add( oGroup, oBinding );
		__.SP.exec( ctx, oItem, function( oItem ) {
			console.log( oItem );
			if( oItem.sError ) {
				async.reject( oItem.sError );
			}
			else {
				async.resolve();
			}
		} );
	}
	// __.SP.item.restrictToUser( { sList : "SideBar", id: 22, xUser: _spPageContextInfo.userId, sRole: "Edit"  } ) 
	, restrictToUser : function( args ) { // sList, id, xUser, sRole
		/* sRole: Contribute,Custom Levelname,Read,Edit */
		/* xUser: either id or email or login name osce\\jriemer */
		var async = __.Async.promise( args );
		var ctx = __.SP.ctx();
		var oList = __.SP.list.get( ctx, args.sList );
		var oItem = oList.getItemById( args.id );
		ctx.load( oItem );
		var oUsers = ctx.get_web().get_siteUsers();
		var oUser = null;
		if( ! isNaN( args.xUser ) ) {
			oUser = oUsers.getById( args.xUser );
		}
		else if( __.b.email( args.xUser ) ) {
			oUser = oUsers.getByEmail( args.xUser );
		}
		else {
			oUser = oUsers.getByLoginName( args.xUser );
		}
		var oBinding = SP.RoleDefinitionBindingCollection.newObject( ctx );
		var oRole = ctx.get_web().get_roleDefinitions().getByName( args.sRole );
		oBinding.add( oRole );
		oItem.breakRoleInheritance( false );
		oItem.get_roleAssignments().add( oUser, oBinding );
		__.SP.exec( ctx, oItem, function( oItem ) {
			if( oItem.sError ) {
				async.reject( oItem.sError );
			}
			else {
				async.resolve();
			}
		} );
	}
};


// ==ClosureCompiler==
// @compilation_level ADVANCED_OPTIMIZATIONS
// @output_file_name __.sp.list.min.js
// @js_externs var __; __.SP; __.SP.ctx
// ==/ClosureCompiler==


/**
 * @namespace __.SP.list
 * @memberof __.SP
 */

__.SP.list = {
	/**
	 * Gets a list context by name or guid
	 * @memberof __.SP.list
	 * @method get
	 * @todo use arguments object
	 * @todo improve error capturing
	 * @example __.SP.folder.get( ctx, "Shared Documents" );
	 * @param {Object} ctx SharePoint site context
	 * @param {String} x either name of the list or its guid in curly brackets
	 * @returns {Object} context of the list
	 */
	  get : function( ctx, x ) {
		var oList = null;
		var oLists = ctx.get_web().get_lists();
		if( /^{/.test( x ) ) {
			var ls = x.match( /{(.*)}/ );
			if( ls.length == 2 ) {
				oList = oLists.getById( ls[ 1 ] );
			}
		}
		else {
			oList = oLists.getByTitle( x );
		}
		return ( oList ) ? oList : null;
	}
	/**
	 * Reads list items
	 * @memberof __.SP.list
	 * @method read
	 * @example
	 * __.SP.list.read( {
	 * 	  sList : "Shared Documents"
	 *	, lsFields : [ "Title", "ID" ]
	 *	, xmlQuery : "<Query><Where><FieldRef Name='ID' /><Lt><Value Type='Number'>5</Value></Lt></Where></Query>"
	 * } );
	 * @param {Object} args a parameter object holding the following values
	 * @param {String} args.sList name or guid of a list
	 * @param {Array} args.lsFields array of field names to be returned
	 * @param {String} [args.sSite] Url of a site (defaults to current)
	 * @param {String} [args.pathSearch] folder path to start search from
	 * @param {String} [args.xmlQuery] optional CAML query otherwise entire list is returned
	 * @returns {Object} Resolved promise holding the following values 
	 * <pre class='return-object'>
	 * lkv | (Object) | array of key value pairs
	 * </pre>
	 */
	, read : function( args ) { // sList, lsFields, xmlQuery, pathSearch (to limit to subfolder)
		var async = __.Async.promise( args );
		// get context
		var ctx = __.SP.ctx( args.sSite );
		// get list
		var oList = __.SP.list.get( ctx, args.sList );
		if( ! oList ) {
			async.reject( "List not found: " + args.sList );
		}
		else {
			var oQuery;
			if( args.xmlQuery ) {
				oQuery = new SP.CamlQuery();
				oQuery.set_viewXml( "<View>" + args.xmlQuery + "</View>" );
			}
			else {
				oQuery = SP.CamlQuery.createAllItemsQuery();
			}
			if( args.pathSearch ) {
				// not tested
				oQuery.set_folderServerRelativeUrl( args.pathSearch );
			}
			var oItems = oList.getItems( oQuery );
			ctx.load( oItems );
			__.SP.exec( ctx, oItems, function( oItems ) {
				if( oItems.sError ) {
					async.reject( oItems.sError );
				}
				else {
					var lkv = [];
					var laItems = oItems.getEnumerator();
					while( laItems.moveNext() ) {
						var kv = {};
						var kvItem = laItems.get_current().get_fieldValues();
						if( args.lsFields.length > 0 ) {
							args.lsFields.forEach( function( sField ) {
								var oField = kvItem[ sField ];
								if( oField ) {
									if( oField.get_termGuid ) {
										kv[ sField ] = oField.get_label();
										kv[ "guid" + sField ] = oField.get_termGuid();
									}
									else if( oField.get_lookupValue ) {
										kv[ sField ] = oField.get_lookupValue();
										kv[ "id" + sField ] = oField.get_lookupId();
									}
									else {
										kv[ sField ] = oField;
									}
								}
							} );
							lkv.push( kv );
						}
						else {
							lkv.push( kvItem );
						}
					}
				}
				async.resolve( { lkv : lkv } );
			} );
		}
	}
	/**
	 * OBSOLTE Reads fields from list view
	 */
	// REF: remove 
	// __.SP.list.readView ( {sList : "OSCE Contacts", sView : 111, lsFields : [ "Title", "Country" ], cb : function( a ) {	do( a.kv ); } ); } } )
	, readView : function( args ) { // sList, sView, lsFields, cb
		var cb = args.cb;
		var lsFields = args.lsFields;
		( new __.Async() )
		.then( __.SP.view, "read", {
			  sList : args.sList
			, sView : args.sView
		} )
		.then( function( args ) {
			var async = __.Async.promise( args );
			async.then( __.SP.list, "read", {
				  sList : args.sList
				, lsFields : lsFields
				, xmlQuery : "<Query>" + args.kv.xmlQuery + "</Query>"
			} ).resolve();
		} )
		.then( function( args ) {
			cb( args );
			__.Async.promise( args ).resolve();
		} )
		.start();
	}
/**
 * <pre>
 * Check if a list exists
 * </pre>
 * @memberof __.SP.list
 * @method exists
 * @example
 * __.SP.list.exists( {
 * 	  sList : "Shared Documents"
 * } );
 * @param {Object} args a parameter object holding the following values
 * @param {String} args.sList name or guid of a list
 * @returns {Object} Resolved promise holding the following values 
 * <pre class='return-object'>
 * bExists | (Boolean) | true if list exists otherwise false
 * </pre>
 */
	, exists : function( args ) {
		var async = __.Async.promise( args );
		var ctx = __.SP.ctx();
		var oList = __.SP.list.get( ctx, args.sList );
		ctx.load( oList, 'Id' );
		__.SP.exec( ctx, oList, function( oList ) {
			if( oList.sError ) {
				async.resolve( { bExists : false } );
			}
			else {
				async.resolve( { bExists : true } );
			}
		} );
	}
};
/**
 * <pre>
 * Get guid of a list for a given name
 * </pre>
 * @memberof __.SP.list
 * @method id
 * @example
 * __.SP.list.id( {
 * 	  sList : "Shared Documents"
 * } );
 * @param {Object} args a parameter object holding the following values
 * @param {String} args.sList name of a list
 * @returns {Object} Resolved promise holding the following values 
 * <pre class='return-object'>
 * idList | (String) | guid of a list
 * </pre>
 */
__.SP.list.id = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	ctx.load( oList, 'Id' );
	__.SP.exec( ctx, oList, function( oList ) {
		if( oList.sError ) {
			async.reject( oList.sError );
		}
		else {
			async.resolve( { idList : oList.get_id() } );
		}
	} );
}

/**
 * <pre>
 * Updates the settings of a list. Available properties are:
 * - documentTemplateUrl
 * - contentTypesEnabled
 * - enableMinorVersions
 * - enableVersioning
 * - onQuickLaunch
 * - majorVersionLimit
 * - majorWithMinorVersionsLimit
 * </pre>
 * @todo prefix "set_" to avoid inidcation in argument
 * @todo rename kvFeatures to aSettings
 * @memberof __.SP.list
 * @method settings
 * @example
 * __.SP.list.settings( {
 * 	  sList : "Shared Documents"
 *	, kvFeatures : {
 * 		  set_enableVersioning : true
 *		, set_onQuickLaunch : false
 * 	}
 * } );
 * @param {Object} args a parameter object holding the following values
 * @param {String} args.sList name of a list
 * @param {Object} args.kvFeatures key value pair of settings
 */
__.SP.list.settings = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	for( var k in args.kvFeatures ) {
		var v = args.kvFeatures[ k ];
		oList[ k ]( v );
	}
	oList.update();
	ctx.load( oList );
	__.SP.exec( ctx, oList, function( oList ) {
		if( oList.sError ) {
			async.reject( oList.sError );
		}
		else {
			async.resolve();
		}
	} );
};


/**
 * <pre>
 * Creates a list of a give type
 * Available types:
 * - genericList
 * - discussionBoard
 * - documentLibrary
 * - announcements
 * - contacts
 * - events
 * - REF: more?
 * </pre>
 * @memberof __.SP.list
 * @method create
 * @example
 * __.SP.list.create( {
 * 	  sList : "simple list"
 *	, sType : "genericList"
 * 	, sDescription : "This is a simple list"
 * } );
 * @param {Object} args a parameter object holding the following values
 * @param {String} args.sList name of the list
 * @param {String} args.sType type of the list
 * @param {String} [args.sDescription] description of the list
 * @returns {Object} Resolved promise holding the following values 
 * <pre class='return-object'>
 * oList | (Object) | context of the list
 * </pre>
 */
__.SP.list.create = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oWeb = ctx.get_web();
	var oInfo = new SP.ListCreationInformation();
	oInfo.set_title( args.sList );
	oInfo.set_templateType( SP.ListTemplateType[ args.sType ] );
	var oList = oWeb.get_lists().add( oInfo );
	if( args.sDescription ) {
		oList.set_description( args.sDescription );
	}
	ctx.load( oList );
	__.SP.exec( ctx, oList, function( oList ) {
		if( oList.sError ) {
			async.reject( oList.sError );
		}
		else {
			async.resolve( { oList : oList } );
		}
	} );
}

/**
 * <pre>
 * Deletes a list
 * </pre>
 * @memberof __.SP.list
 * @method del
 * @example
 * __.SP.list.del( {
 * 	  sList : "simple list"
 * } );
 * @param {Object} args a parameter object holding the following values
 * @param {String} args.sList name of the list
 */
__.SP.list.del = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	oList.deleteObject();
	ctx.load( oList );
	__.SP.exec( ctx, oList, function( oList ) {
		if( oList.sError ) {
			async.reject( oList.sError );
		}
		else {
			async.resolve();
		}
	} );
};

__.SP.list.xmlFields = function( args ) {
	var mp = {
		  taxonomy : "TaxonomyFieldType"
		, lookup : "Lookup"
		, choice : "Choice"
		, textarea : "Note"
		, input : "Text"
		, checkbox : "Boolean"
		, boolean : "Boolean"
		, date : "DateTime"
	};
	var xml = '<Field Name="' + args.sName + '" DisplayName="' + args.sName + '" ';
	if( args.sAddition ) {
		xml += args.sAddition;
	}
	var sType = mp[ args.sCAMLType ];
	// its a site column...
	if( sType == "DateTime" ) {
		xml += ' Format="DateOnly" ';
	}
	if( args.bMulti ) {
		sType = ( sType == "Choice" )
			? "MultiChoice"
			: sType += "Multi";
		xml += ' Mult="TRUE" ';
	}
	if( args.aCalculation ) {
		xml += ' ReadOnly="TRUE" Type="Calculated">';
		xml += "<Formula>" + args.aCalculation.sFormular + "</Formula>";
		xml += "<FieldRefs>";
		args.aCalculation.lsFields.forEach( function( sField ) {
			xml += "<FieldRef Name=\"" + sField + "\" />";
		} );
		xml += "</FieldRefs>";
	}
	else {
		xml += ' Type="' + sType + '">';
	}
	if( sType == "TaxonomyFieldType" ) {
		// REF: move this to __.SP.taxonomy
		var guidTermStore = O$C3.Tax.guidTermStore;
		var guidTermSet = O$C3.Tax.guidTermSet[ args.sTaxonomy ];
		xml += '<Customization>';
		xml += '<ArrayOfProperty>';
		xml += '<Property><Name>SspId</Name><Value xmlns:q1="http://www.w3.org/2001/XMLSchema" p4:type="q1:string" xmlns:p4="http://www.w3.org/2001/XMLSchema-instance">' + guidTermStore + '</Value></Property>';
		xml += '<Property><Name>TermSetId</Name><Value xmlns:q2="http://www.w3.org/2001/XMLSchema" p4:type="q2:string" xmlns:p4="http://www.w3.org/2001/XMLSchema-instance">' + guidTermSet + '</Value></Property>';
		xml += '</ArrayOfProperty>';
		xml += '</Customization>';
	}
	if( typeof args.vDefault !== "undefined" ) {
		xml += '<Default>' + args.vDefault + '</Default>';
	}
	xml += '</Field>';
	return xml;
};
__.SP.list.oFieldType = function( args ) {
	var mp = {
		  taxonomy : SP.Taxonomy.TaxonomyField
		, lookup : SP.FieldLookup
		, choice : SP.FieldChoice
		, input : SP.FieldText
		, textarea : SP.FieldText
		, checkbox : SP.FieldText
		, boolean : SP.FieldText
		, date : SP.FieldDateTime
	};
	return mp[ args.sCAMLType ];
};

/**
 * @typedef oField
 * @property {String} sName internal name of a field
 * @property {String} sDisplayName display name of a field
 */
/**
 * <pre>
 * Adds fields to a list
 * </pre>
 * @memberof __.SP.list
 * @method addFields
 * @async 
 * @instance
 * @todo move to namespace __.SP.list.fields
 * @todo check need of return value loFields
 * @todo check if single updates prevent calulated fields from erroring out
 * @example
 * __.SP.list.addFields( {
 * 	  sList : "simple list"
 *	, loFields : loFields
 * } );
 * @param {Object} args 
 * @param {String} args.sList name of the list
 * @param {oField} args.loFields an array of list field objects "oField"
 */
__.SP.list.addFields = function( args ) { // sList, loFields
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	if( args.loFields ) {
		var oFields = oList.get_fields();
		args.loFields.forEach( function( a ) {
			console.log( ">>>>>>>" +  a.sName );
			if( a.sCAMLType !== "column" && a.sName !== "Title" ) {
				var oField = ctx.castTo(
					  oFields.addFieldAsXml(
						  __.SP.list.xmlFields( a )
						, true
						, SP.AddFieldOptions.addToDefaultContentType
					)
					, __.SP.list.oFieldType( a )
				);
				if( a.sTitle ) {
					oField.set_title( a.sTitle );
				}
				if( a.sDescription ) {
					oField.set_description( a.sDescription );
				}
				if( a.lsChoices ) {
					oField.set_choices( a.lsChoices );
				}
				if( a.aLookup ) {
					a.aLookup.oField = oField;
				}
				if( a.vDefault ) {
					oField.set_defaultValue( a.vDefault );
				}
				oField.update();
				ctx.load( oField );
			}
		} );
		__.SP.exec( ctx, oFields, function( oFields ) {
			if( oFields.sError ) {
				console.log( oFields.sError );
				if( /Cannot complete this action/.test( oFields.sError ) ) {
					console.log( ">>>>>>>>>>>>>>>>>>>>>>>>>>>>" );
					async.resolve();
				}
				else {
					console.log( "<<<<<<<<<<<<<<<<<<<<<" );
					async.reject( oFields.sError );
				}
			}
			else {
				async.resolve();
			}
		} );
	}
}

/**
 * <pre>
 * Sets up a field as lookup
 * @todo move to field namespace or merge with field.update
 * @todo automatically get guid of list by name
 * </pre>
 * @memberof __.SP.list
 * @method setLookup
 * @example
 * __.SP.list.setLookup( {
 * 	  oField : oField
 *	, idList : "12345678-asdf-zxcv-qwwe-1234567890ab"
 * 	, sField : "Title"
 * } );
 * @param {Object} args a parameter object holding the following values
 * @param {Object} args.oField context of list field
 * @param {idList} args.idList guid of lookup list
 * @param {sField} args.sField name of main lookup list field to display
 */
__.SP.list.setLookup = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oField = args.oField;
	oField.set_lookupList( "{" + args.idList + "}" );
	oField.set_lookupField( args.sField );
	oField.update();
	ctx.load( oField );
	__.SP.exec( ctx, oField, function( o ) {
		if( o.sError ) {
			async.reject( "setLookupErrorType " + o.sError );
		}
		else {
			async.resolve( { oField : oField });
		}
	} );
}

/**
 * <pre>
 * Sets up fields as lookup using a an array of {oFields}
 * @todo move to field namespace or merge with field.update
 * @todo check possibility to merge with {__.SP.field.setLookup}
 * </pre>
 * @memberof __.SP.list
 * @method setLookups
 * @example
 * __.SP.list.setLookups( { loFields : loFields } );
 * @param {Object} args a parameter object holding the following values
 * @param {Array|of|oField} args.loFields array of oField objects
 */
__.SP.list.setLookups = function( args ) {
	var async = __.Async.promise( args );
	args.loFields.forEach( function( o ) {
		if( o.aLookup ) {
			async.then( __.SP.list, "id", {
				sList : o.aLookup.sList
			} );
			async.then( __.SP.list, "setLookup", {
				  oField : o.aLookup.oField
				, sField : o.aLookup.sField
			} );
		}
	} );
	async.resolve();
}

// __.SP.list.setColumn( { sList : "FrontOfficeAssignments", sColumn : "FrontOffice"} )
/**
 * <pre>
 * Adds a site column to a list
 * @todo move to field namespace or merge with field.update
 * @todo check if we can merge with setColumns
 * </pre>
 * @memberof __.SP.list
 * @method setColumn
 * @example
 * __.SP.list.setColumn( {
 * 	  sList : "test list"
 *	, sColumn : "Email"
 * } );
 * @param {Object} args a parameter object holding the following values
 * @param {String} args.sList name or guid of list
 * @param {String} args.sColumn internal name of site column
 */
__.SP.list.setColumn = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oColumn = ctx.get_web().get_fields().getByInternalNameOrTitle( args.sColumn );
	var oList = __.SP.list.get( ctx, args.sList );
	var oField = oList.get_fields().add( oColumn );
	var oView = oList.get_defaultView();
	oView.get_viewFields().add( args.sColumn );
	oView.update();
	oList.update();
	ctx.load( oList );
	__.SP.exec( ctx, oList, function( oList ) {
		if( oList.sError ) {
			async.reject( oList.sError );
		}
		else {
			async.resolve();
		}
	} );
}

/**
 * <pre>
 * Adds columns to a list using a an array of {oFields}
 * @todo move to field namespace or merge with field.update
 * @todo check possibility to merge with {__.SP.field.setColumn}
 * </pre>
 * @memberof __.SP.setColumns
 * @method setColumns
 * @example
 * __.SP.list.setColumns( { loFields : loFields } );
 * @param {Object} args a parameter object holding the following values
 * @param {Array|of|oField} args.loFields array of oField objects
 */
__.SP.list.setColumns = function( args ) { // oList, loFields ) {
	var async = __.Async.promise( args );
	args.loFields.forEach( function( o ) {
		if( o.sColumn ) {
			async.then( __.SP.list, "setColumn", {
				  sColumn : o.sColumn
				, sList : args.sList
			} );
		}
	} );
	async.resolve();
}

/**
 * <pre>
 * Returns the name of a list for a given guid
 * </pre>
 * @memberof __.SP.list
 * @method nameByGuid
 * @example __.SP.list.nameByGuid( {
 *     guid : "b5ffd424-8b37-4bb8-b070-d32e4d638740"
 * } );
 * @param {Object} args a parameter object holding the following values
 * @param {String} args.guid guid of a list
 * @returns {Object} Resolved promise holding the following values 
 * <pre class='return-object'>
 * sName | (String) | name of the list
 * </pre>
 */
__.SP.list.nameByGuid = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = ctx.get_web().get_lists().getById( args.guid );
	ctx.load( oList, "Title" );
	__.SP.exec( ctx, oList, function( oList ) {
		if( oList.sError ) {
			async.reject( oList.sError );
		}
		else {
			async.resolve( {
				  sName : oList.get_title()
			} );
		}
	} );
};

/**
 * <pre>
 * Returns two objects mapping a lists internal field names against their display names and vice versa.
 * </pre>
 * @memberof __.SP.list
 * @method fields
 * @example __.SP.list.fields( { sList : "test list" } );
 * @param {Object} args a parameter object holding the following values
 * @param {String} args.sList name of the list
 * @returns {Object} Resolved promise holding the following values 
 * <pre class='return-object'>
 * mpIntNames | (Object) | maps internal names against display names
 * mpDispNames | (Object) | maps display names against internal names
 * </pre>
 */
__.SP.list.fields = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	var oFields = oList.get_fields();
	ctx.load( oFields, 'Include(Title,InternalName)' );
	__.SP.exec( ctx, oFields, function( oFields ) {
		if( oFields.sError ) {
			async.reject( oFields.sError );
		}
		else {
			var laFields = oFields.getEnumerator();
			var mpIntNames = {};
			var mpDispNames = {};
			while( laFields.moveNext() ) {
				var sIntName = laFields.get_current().get_internalName();
				var sDispName = laFields.get_current().get_title();
				mpIntNames[ sIntName ] = sDispName;
				mpDispNames[ sDispName ] = sIntName;
			}
			async.resolve( {
				  mpIntNames : mpIntNames
				, mpDispNames : mpDispNames
			} );
		}
	} );
};

/**
 * @namespace __.SP.list.field
 * @memberof __.SP.list
 */

__.SP.list.field = {};

/**
 * <pre>
 * Updates a list field with the following information
 * - display name
 * - flag to be required
 * - flag to be hidden
 * - flags in which forms to be shown
 * </pre>
 * @memberof __.SP.list.field
 * @method display
 * @example
 * __.SP.list.field.display( {
 * 	  sList : "test list"
 *	, idList : ""12345678-asdf-zxcv-qwwe-1234567890ab"
 * 	, sField : "Title"
 * } );
 * @param {Object} args a parameter object holding the following values
 * @param {String} args.sList name or guid of the list
 * @param {String} args.sField internal name of the field
 * @param {String} args.sTitle new display name of the field
 * @param {Boolean} args.bRequired flag whether a field is required
 * @param {Boolean} args.bHidden flag whether to hide a field
 * @param {Boolean} args.bNew flag whether to not load in new form
 * @param {Boolean} args.bEdit flag whether to not load in edit form
 * @param {Boolean} args.bDisp flag whether to not load in view form
 */
// REF: rename sTitle to sDisplayName
// REF: think of merging with setLookup, setColumn and reanme method to update?
__.SP.list.field.display = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	var oField = oList.get_fields().getByInternalNameOrTitle( args.sField );
	var bDisp = ( typeof args.bDisp !== "undefined" ) ? args.bDisp : true;
	var bNew = ( typeof args.bNew !== "undefined" ) ? args.bNew : true;
	var bEdit = ( typeof args.bEdit !== "undefined" ) ? args.bEdit : true;
	var bHidden = ( typeof args.bHidden !== "undefined" ) ? args.bHidden : false;
	oField.setShowInDisplayForm( bDisp );
	oField.setShowInNewForm( bNew );
	oField.setShowInEditForm( bEdit );
	if( args.sTitle ) {
		oField.set_title( args.sTitle );
	}
	if( args.bRequired ) {
		oField.set_required( args.bRequired );
	}
	oField.set_hidden( bHidden );
	oField.update();
	ctx.load( oField );
	__.SP.exec( ctx, oField, function( oField ) {
		if( oField.sError ) {
			async.reject( oField.sError );
		}
		else {
			async.resolve();
		}
	} );
}


/**
 * <pre>
 * Adds columns to a list using a an array of {oFields}
 * @todo check possibility to merge with {__.SP.field.display}
 * @todo investigate error we get with "choice" fields
 * </pre>
 * @memberof __.SP.list.field
 * @method displays
 * @example
 * __.SP.list.displays( {
 *        sList : "test list"
 *      , loFields : loFields
 * } );
 * @param {Object} args a parameter object holding the following values
 * @param {String} args.sList name or guid of a list
 * @param {Array|of|oField} args.loFields array of oField objects
 */
__.SP.list.field.displays = function( args ) {
	var async = __.Async.promise( args );
	args.loFields.forEach( function( oField ) {
		if( oField.sCAMLType !== "choice" ) {
			async.then( __.SP.list.field, "display", {
				  sList : args.sList
				, sField : oField.sName
				, sTitle : oField.sDisplayName
				, bNew : oField.bNew
				, bEdit : oField.bEdit
				, bDisp : oField.bDisp
				, bHidden : oField.bHidden
				, bRequired : oField.bRequired
				, vDefault : oField.vDefault
			}, "update " + oField.sName )
		}
	} );
	async.resolve();
}

/**
 * <pre>
 * Reorders fields of a list by an array of field names.
 * </pre>
 * @memberof __.SP.list.field
 * @method reorder
 * @example
 * __.SP.list.field.reorder( {
 *        sList : "test list"
 *      , lsFields : [ "Email", "CustomField", "Title" ]
 * } );
 * @param {Object} args a parameter object holding the following values
 * @param {String} args.sList name or guid of a list
 * @param {Array} args.lsFields array of internal field names
 */
__.SP.list.field.reorder = function( args ) { 
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	var oCTs = oList.get_contentTypes();
	ctx.load( oCTs );
	__.SP.exec( ctx, oCTs, function( oCTs ) {
		if( oCTs.sError ) {
			async.reject( oCTs.sError );
		}
		else {
			var oCT = oCTs.getItemAtIndex( 0 );
			var oFields = oCT.get_fieldLinks();
			oFields.reorder( args.lsFields );
			oCT.update( false );
			__.SP.exec( ctx, oFields, function( oFields ) {
				if( oFields.sError ) {
					async.reject( oFields.sError );
				}
				else {
					async.resolve();
				}
			} );
		}
	} );
};

__.SP.list.field.setJsLink= function( args ) { // sList, [sField], urlJsLink
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	var sField = args.sField || "jsLink";
	var oField = oList.get_fields().getByInternalNameOrTitle( sField );
	oField.set_jsLink( args.urlJsLink );
	oField.update();
	ctx.load( oField );
	__.SP.exec( ctx, oField, function( oField ) {
		if( oField.sError ) {
			async.reject( oField.sError );
		}
		else {
			async.resolve();
		}
	} );
};
// ==ClosureCompiler==
// @compilation_level ADVANCED_OPTIMIZATIONS
// @js_externs var __; __.SP; __.SP.modal; __.SP.modal.alert; __.SP.modal.bExists; __.SP.modal.confirm; __.SP.modal.load; __.SP.modal.open; __.SP.modal.resize;
// ==/ClosureCompiler==


/**
 * @namespace __.SP.modal
 * @memberof __.SP
 */

__.SP.modal = {
	  dn : null
	/**
	 * Loads a page into a modal window
	 * @memberof __.SP.modal
	 * @method load
	 * @example __.SP.modal.load( {
	 *	  sTitle : "Manage taxonomies"
	 *	, url : "/link/to/taxonomy.aspx"
	 *	, fnLoad: function( dnModal ) {
	 *		var dnButton = dnModal.getElementById( "#add" );
	 * 		__.dn.del( dnButton );
	 *	}
	 * } );
	 * @param {Object} args a parameter object holding the following values
	 * @param {String} args.sTitle title of modal window
	 * @param {String} args.url Url to be loaded into the modal window
	 * @param {Function} [args.fnLoad] function to be called when the page was loaded.
	 * @param {Function} [args.fnClose] function to be called when the window gets closed (A number gets passed on indicating whether it was closed by cancelling (0) or clicking the "OK/Save" button (1)).
	 * @returns {Object} the modal object 
	 */
	, load : function( args ) {
		args.bClose = ( typeof args.bClose != "undefined" ) ? args.bClose : true;
		var kv = {
			  title : args.sTitle
			, showClose : args.bClose
			, autoSize : true
			, url : args.url
			, dialogReturnValueCallback : function( b ) {
				if( args.fnClose ) {
					args.fnClose( b );
				}
			}
		};
		var dnModal = SP.UI.ModalDialog.showModalDialog( kv );
		( new __.Async() )
		.wait( function() {
			if( dnModal && dnModal.$e_0 ) {
				if( args.fnLoad ) {
					args.fnLoad( dnModal.$e_0 );
				}
				return true;
			}
			return false;
		}, 50 )
		.start();
		return this;
	}
	/**
	 * Opens a modal window
	 * @memberof __.SP.modal
	 * @method open
	 * @example __.SP.modal.confirm( {
	 *	  sTitle : "Save a filter"
	 *	, hContent : "name: <input id='filter' type='text'></input>"
	 *	, fnact : function( oModal ) {
	 *		var sName = oModal.dn.getElementById( "#filter" ).value();
			// save filter with sName
	 *	}
         *	, sCancel : null
         *	, bClose : false
	 * } );
	 * @param {Object} args a parameter object holding the following values
	 * @param {String} args.sTitle title of modal window
	 * @param {String} args.hContent content of modal window in HTML format
	 * @param {String} [args.sOk] name of main action button (OK/Save), indicatng "null" will not render the button (default is "Save")
	 * @param {String} [args.sCancel] name of cancel button, indicating "null" will not render the button (default is "Cancel" )
	 * @param {Boolean} [args.bClose] flag wether a button to close the modal window is rendered (X in top right corner)
	 * @param {Function} [args.fnClose] function to be called when the window gets closed (A number gets passed on indicating whether it was closed by cancelling (0) or clicking the "OK/Save" button (1)).
	 * @param {Function} [args.fnact] function to be called when the main action button is clicked
	 * @param {String} [args.sLoading] message to be shown when {args.fnact} is called or when {args.bShowProcessing} is flagged true (default is "Processing your request.")
	 * @param {Boolean} [args.bShowProcessing] flag to show the "in progress" modus (spinning wheel + message).
	 * @returns {Object} the modal object 
	 */
	, open : function( args ) {
		args.sLoading = args.sLoading || "Processing your request.";
		args.sOk = ( args.hasOwnProperty( "sOk" ) ) ? args.sOk : "Save";
		args.sCancel = ( args.hasOwnProperty( "sCancel" ) ) ? args.sCancel : "Cancel";
		args.bClose = ( typeof args.bClose != "undefined" ) ? args.bClose : true;
		var h = "<div id='osce-modal'>";
		h += args.hContent;
		h += "<p class='separator'></p>";
		h += this.buttons( args );
		h += "</div>";
		this.dn = __.dn.append( h );
		this.behaviour( this.dn, args );
		var kv = {
			  title : args.sTitle
			, showClose : args.bClose
			, autoSize : true
			, html : this.dn
			, dialogReturnValueCallback : function( b ) {
				if( args.fnClose ) {
					args.fnClose( b );
				}
			}
		};
		if( args.bShowProcessing ) {
			this.processing();
		}
		if( args.bNoButtons ) {
			__.dn_( ".osce-buttons", this.dn ).style.display = "none";
		}
		SP.UI.ModalDialog.showModalDialog( kv );
		return this;
	}
	, behaviour : function( dn, args ) {
		var that = this;
		var dnOk = __.dn_( "input[value='" + args.sOk + "']", this.dn );
		if( dnOk && args.fnact ) {
			dnOk.addEventListener( "click", function() {
				that.processing();
				args.fnact( that );
			} );
		}
		var dnCancel = __.dn_( "input[value='" + args.sCancel + "']", this.dn );
		if( dnCancel ) {
			dnCancel.addEventListener( "click", function() {
				__.SP.modal.cancel();
			} );
		}
		// set focus on first input field
		setTimeout( function() {
			var dnInput = __.dn_( "input", that.dn );
			if( dnInput && dnInput[ 0 ] && dnInput[ 0 ].focus ) {
				dnInput[ 0 ].focus();
			}
		}, 1500 );
	}
	, message : function( s ) {
		var dnMessage = __.dn_( ".osce-message", this.dn );
		var dnLoading = __.dn_( ".osce-loading", this.dn );
		if( s ) {
			dnMessage.textContent = s;
			dnMessage.style.display = "block";
			dnLoading.style.display = "none";
		}
		else {
			dnMessage.textContent = "";
			dnMessage.style.display = "none";
		}
	}
	, buttons : function( args ) {
		var h = "<div class='osce-action-panel'>";
		h += "  <div class='osce-message'></div>";
		h += "  <div class='osce-loading'>";
		h += "   <img src='" + __.SP.icon.mp.loading + "' />";
		h += "   <span>" + args.sLoading + "</span></div>";
		h += "  <div class='osce-buttons'>";
		if( args.sOk ) {
		h += "  <input type='button' value='" + args.sOk + "'";
		h += "   accesskey='O' class='ms-ButtonHeightWidth'>";
		}
		if( args.sCancel ) {
		h += "  <input type='button' value='" + args.sCancel+ "'";
		h += "   accesskey='1' class='ms-ButtonHeightWidth'>";
		}
		h += "  </div>";
		h += "</div>";
		return h;
	}
	, stopProcessing : function() {
		var dnLoading = __.dn_( ".osce-loading", this.dn );
		dnLoading.style.display = "none";
		//__.dn._fade( dnLoading );
	}
	, processing : function() {
		var dnLoading = __.dn_( ".osce-loading", this.dn );
		dnLoading.style.display = "block";
		//__.dn._fade( dnLoading );
	}
	, progress : function( s ) {
		var dnMessage = __.dn_( ".osce-loading > span", this.dn );
		dnMessage.textContent = s;
	}
	, close : function() {
		SP.UI.ModalDialog.commonModalDialogClose( 1 );
	}
	, cancel : function() {
		var dnClose = __.dn_( ".ms-dlgCloseBtn" );
		if( dnClose && dnClose.click ) {
			dnClose.click();
		}
		else {
			this.closeAll();
		}
	}
	/**
	 * Opens a confirmation window with a question plus "Yes"/"No" buttons.<br>
	 * Invokes a passed on callback function with a boolean indicating the answer.
	 * @memberof __.SP.modal
	 * @method confirm 
	 * @example __.SP.modal.confirm( {
	 *	  sTitle : "Confirm this action"
	 *	, sQuestion : "Do you want to remove the item?"
	 *	, fnAnswer : function( a ) {
	 *		console.log( a );
	 *	}
	 * } );
	 * @param {Object} args a parameter object holding the following values
	 * @param {String} [args.sTitle] title of confirmation window (default is "Confirm this action..."
	 * @param {String} args.sQuestion question to ask the user (default is "Do you want to proceed?")
	 * @param {String} args.fnAnswer callback invoked with the answer as parameter
	 * @returns {Object} the modal object 
	 */
	, confirm : function( args ) {
		var s = ( args.sError ) ? args.sError : args;
		var hQuestion = ( args.sQuestion )
			? "<p>" + args.sQuestion + "</p>"
			: "<p>Do you want to proceed?</p>";
		return __.SP.modal.open( {
			  sTitle : args.sTitle || "Confirm this action..."
			, hContent : hQuestion
			, sOk : "Yes"
			, sCancel : "No"
			, fnact : function() {
				__.SP.modal.close();
			}
			, fnClose : args.fnAnswer || null
		} );
	}
	/**
	 * Opens a modal alert window with a message.
	 * @memberof __.SP.modal
	 * @method alert
	 * @example __.SP.modal.alert( {
	 *	  sMessage : "You cannot perform this action until you checkout"
	 * } );
	 * @param {Object} args a parameter object holding the following values
	 * @param {String} [args.sTitle] title of alert window (default is "System Message"
	 * @param {String} args.sMessage message of the alert.
	 * @returns {Object} the modal object 
	 */
	, alert : function( args ) {
		var sMessage = ( args.sMessage ) ? args.sMessage : "";
		var h = "<p>" + sMessage + "</p>";
		return __.SP.modal.open( {
			  sTitle : args.sTitle || "System Message"
			, hContent : h
			, sOk : null
			, sCancel : "Close"
		} );
	}
	, closeAll : function() {
		console.log( 'closeall' );
		__.dn_( ".ms-dlgContent", function( dnModal ) {
			__.dn.del( dnModal );
		} );
		__.dn_( ".ms-dlgOverlay", function( dnBlend ) {
			__.dn.del( dnBlend );
		} );
	}
	/**
	 * Checks if a modal window is currently displayed.
	 * @memberof __.SP.modal
	 * @method bExists
	 * @example var bModalOpen = __.SP.modal.bExists();
	 * @returns {Boolean} true if a modal window is currently displayed
	 */
	, bExists : function() {
		return __.dn_( ".ms-dlgContent" );
	}
	/**
	 * Resizes the current modal window to fit the content.
	 * @memberof __.SP.modal
	 * @method resize
	 * @example __.SP.modal.resize();
	 */
	, resize : function() {
		var oModal = SP.UI.ModalDialog.get_childDialog();
		oModal.$$d_autoSize();
	}
};

__.SP.permission = {};
__.SP.group = {};
__.SP.group.add = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oWeb = ctx.get_web();
	var oCreate = new SP.GroupCreationInformation();
	oCreate.set_title( args.sName );
	if( args.sDescription ) {
		oCreate.set_description( args.sDescription );
	}
	oGroup = oWeb.get_siteGroups().add( oCreate );
	ctx.load( oGroup );
	__.SP.exec( ctx, oGroup, function( oGroup ) {
		if( oGroup.sError ) {
			async.reject( oGroup );
		}
		else {
			async.resolve();
		}
	} );
}
__.SP.group.addUser = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oGroups = ctx.get_web().get_siteGroups();
	var oGroup = oGroups.getByName( args.sGroup );
	var oUserInfo = new SP.UserCreationInformation();
	//oUserInfo.set_loginName( args.sUser );
	oUserInfo.set_loginName( 'OSCE-test\\jriemer' );
	oUserInfo.set_title( 'jriemer' );
	oUserInfo.set_email('alias@somewhere.com');
	var oUser = oGroup.get_users().add( oUser );
	console.log(1)
	ctx.load( oUser );
	__.SP.exec( ctx, [ oGroup, oUser ], function( oUser ) {
		if( oUser.sError ) {
			async.reject( oUser );
		}
		else {
			async.resolve();
		}
	} );
}

__.SP.group.addUser = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oUser = ctx.get_web().ensureUser( args.sUser );
	var oGroup = ctx.get_web().get_siteGroups().getByName( args.sGroup );
	oGroup.get_users().addUser( oUser );
	ctx.load( oUser );
	ctx.load( oGroup );
	__.SP.exec( ctx, oUser, function( oUser ) {
		if( oUser.sError ) {
			async.reject( oUser );
		}
		else {
			async.resolve();
		}
	} );
}
__.SP.ribbon = {
	  reload : function() {
		try {
			SP.Ribbon.PageManager.get_instance().get_ribbon().refresh();
		} catch( e ) {
			self.location.reload();
		}
	}
	, addIcon : function( args ) { //sList, sRibbon, sSegment, sLabel, sDescription, sAction, sEnabled, urlIcon16, urlIcon32, sToolTipTitle, sToolTipDescription
		// sRibbon: https://msdn.microsoft.com/en-us/library/office/bb802730.aspx
		// sSegment: https://msdn.microsoft.com/en-us/library/ee537543(office.14).aspx
		// or: to get the segment use browser inspector and check the ID of the segement in UI
		var async = __.Async.promise( args );
		var ctx = __.SP.ctx();
		var oList = __.SP.list.get( ctx, args.sList );
		var oIcon = oList.get_userCustomActions().add();
		oIcon.set_location( args.sRibbon );
		var sCommand = args.sLabel.toLowerCase();
		sCommand = sCommand.replace( /\s/g, "_" );
		var xml = '<CommandUIExtension xmlns="http://schemas.microsoft.com/sharepoint/">';
		xml += '<CommandUIDefinitions>';
		xml += '<CommandUIDefinition Location="' + args.sSegment + '.Controls._children">';
		xml += '<Button Id="Ribbon.' + args.sRibbon + '.' + args.sSegment + '.' + sCommand + '" ';
		xml += 'Command="' + sCommand + '" ';
		xml += 'Sequence="' + ( args.nSequence || 0 ) + '" ';
		xml += 'Image16by16="' + args.urlIcon16 + '" ';
		xml += 'Image32by32="' + args.urlIcon32 + '" ';
		xml += 'Description="' + args.sDescription + '" ';
		xml += 'LabelText="' + args.sLabel + '" ';
		xml += 'ToolTipTitle="' + ( args.sToolTipTitle || "" ) + '" ';
		xml += 'ToolTipDescription="' + ( args.sToolTipDescription || "" ) + '" ';
		xml += 'TemplateAlias="o1"/>';
		xml += '</CommandUIDefinition>';
		xml += '</CommandUIDefinitions>';
		xml += '<CommandUIHandlers>';
		xml += '<CommandUIHandler Command="' + sCommand + '" ';
		xml += 'CommandAction="' + args.sAction + '" ';
		if( args.sEnabled ) {
			xml += 'EnabledScript="' + args.sEnabled + '" ';
		}
		xml += '/>';
		xml += '</CommandUIHandlers>';
		xml += '</CommandUIExtension>';
		console.log( xml );
		oIcon.set_commandUIExtension( xml );
		oIcon.update();
		ctx.load( oList, "UserCustomActions" );
		__.SP.exec( ctx, oList, function( oList ) {
			if( oList.sError ) {
				console.log( 'err' );
				async.reject( oList );
			}
			else {
				console.log( 'ok' );
				async.resolve();
			}
		} );
	}
	, dmiep : function( args ) {
		var async = __.Async.promise( args );
		var ctx = __.SP.ctx();
		var oList = __.SP.list.get( ctx, args.sList );
		var oIcon = oList.get_userCustomActions().add();
		console.log( oList.get_userCustomActions() )
		console.log( oList.get_userCustomActions().add() )
		oIcon.set_location( args.sRibbon );
		//oIcon.set_commandUIExtension( xml );
		oIcon.set_group( "hello" );
		oIcon.set_title( "hello" );
		ctx.load( oList, "UserCustomActions" );
		__.SP.exec( ctx, oList, function( oList ) {
			if( oList.sError ) {
				console.log( 'err' );
				async.reject( oList );
			}
			else {
				console.log( 'ok' );
				async.resolve();
			}
		} );
	}
};
__.SP.taxonomy = {
	  aTerms : {} // holds loaded taxonomies
	, oTermInfo : null // holds all used taxonomy terms
};

// __.SP.taxonomy.setTermInForm( { sField : "Country", sTerm : "Albania", guid : "40690fe5-fd6d-4c27-bb52-b0d60a9e7d78" } );
__.SP.taxonomy.setTermInForm = function( args ) { // sField, sTerm, guid
	var h;
	if( args.guid ) {
		var v = args.sTerm + "|" + args.guid;
		__.dn_( "#" + args.sField + "_\\$input" ).value = v;
		h = "<span class='valid-text'>" + args.sTerm + "</span>";
	}
	else {
		h  = '<span class="invalid-text" ';
		h += 'title="The term is not a valid term">' + args.sTerm + '</span>';
	}
	__.dn_( "#" + args.sField + "_\\$containereditableRegion" ).innerHTML = h;
	__.Async.promise( args ).resolve();
}


__.SP.taxonomy.getTermIds = function( args ) {
	var async = __.Async.promise( args );
	if( __.SP.taxonomy.oTermInfo ) {
		console.log( 'fresh from cache' );
		async.resolve();
		return;
	}
	console.log( "LOADDDDDDDDDDDDDDDDD" );
	async.then( __.SP.list, "read", {
		  sList : "TaxonomyHiddenList"
		, lsFields : [ "IdForTerm", "ID", "Title" ]
	}, "Read taxonomy term id list" )
	async.then( function( args ) {
		__.SP.taxonomy.oTermInfo = {};
		args.lkv.forEach( function( kv ) {
			__.SP.taxonomy.oTermInfo[ kv.ID ] = {
				  id : kv.ID
				, sName : kv.Title
				, guid : kv.IdForTerm
			};
		} );
		__.Async.promise( args ).resolve();
	}, "Extract term id data" )
	async.resolve();
}

// __.SP.taxonomy.getTerm( 1 ).sName;
__.SP.taxonomy.termInfo = function( x ) { // x can be either of the follow three: ID, GUID or TERM NAME
	// in case of index we return immediately for this is the
	// key of the term info object
	if( typeof x == "number" ) {
		return __.SP.taxonomy.oTermInfo[ x ] || null;
	}
	// now lets check if input is term name or its guid and
	// assign the proper key
	var k = ( __.SP.bGuid( x ) ) ? "guid" : "sName";
	// then iterate through the term object and look for the
	// machting entry
	for( var id in __.SP.taxonomy.oTermInfo ) {
		var aTermInfo = __.SP.taxonomy.oTermInfo[ id ];
		if( aTermInfo[ k ] === x ) {
			// and send back if found
			return aTermInfo;
		}
	}
	// otherwise we send back null
	return null;
}

// __.SP.taxonomy.load( { sTermSet : O$C3.Tax.guidTermSet.MainCategory } )
// cons it:  __.SP.taxonomy.aTerms[ O$C3.Tax.guidTermSet.MainCategory ] );
__.SP.taxonomy.load = function( args ) {
	var async = __.Async.promise( args );
	// first check if we already loaded the taxonomy
	var oTerms = __.SP.taxonomy.aTerms[ args.sTermSet ];
	if( oTerms ) {
		async.resolve( { oTerms : oTerms } );
		return;
	}
	var ctx = __.SP.ctx();
	var sTermStore = args.sTermStore || "Managed Metadata Service";
	var oTax = SP.Taxonomy.TaxonomySession.getTaxonomySession( ctx );
	var oStore = oTax.get_termStores().getByName( sTermStore );
	var oSet = oStore.getTermSet( args.sTermSet );
	var oTerms = oSet.getAllTerms();
	ctx.load( oTerms, 'Include(Parent,Id,Name)');
	__.SP.exec( ctx, oTerms, function( oTerms ) {
		if( oTerms.sError ) {
			async.reject( oTerms.sError );
		}
		else {
			var loTerms = oTerms.getEnumerator();
			var aTerms = {};
			var aGuids = {};
			var aLabels = {};
			var aChildren = {};
			var sLastTerm = "";
			while( loTerms.moveNext() ) {
				var oTerm = loTerms.get_current();
				var oParent = oTerm.get_parent();
				var sMain = oTerm.get_name();
				var sLastTerm = sMain;
				var guid = oTerm.get_id().toString();
				if( ! oParent.get_serverObjectIsNull() ) {
					idParent = oParent.get_id().toString();
					if( ! aChildren[ idParent ] ) {
						aChildren[ idParent ] = [];
					}
					aChildren[ idParent ].push( guid );
				}
				aTerms[ sMain ] = {
					  guid : guid
					, lsLabels : []
				};
				aGuids[ guid ] = sMain;
				var oLabels = oTerm.getAllLabels( 1033 );
				ctx.load( oLabels );
				__.SP.exec( ctx, oLabels, function( oLabels, sMain ) {
					var loLabels = oLabels.getEnumerator();
					var sTerm = "";
					var vLookup = {};
					while( loLabels.moveNext() ) {
						var oLabel = loLabels.get_current();
						var sLabel = oLabel.get_value();
						if( aTerms[ sLabel ] ) {
							sTerm = sLabel;
							vLookup = {
								  sTerm : sTerm
								, guid : aTerms[ sTerm ].guid
							};
							aLabels[ sLabel ] = vLookup;
							aLabels[ __.s.tokenize( sLabel ) ] = vLookup;
						}
						else {
							aTerms[ sTerm ].lsLabels.push( sLabel );
							aLabels[ sLabel ] = vLookup;
							aLabels[ __.s.tokenize( sLabel ) ] = vLookup;
						}
					}
					if( ( sLastTerm == sTerm ) ) {
						var aResult = {
							  aTerms : aTerms
							, aGuids : aGuids
							, aLabels : aLabels
							, aChildren : aChildren
						}
						console.log( "!!!!!!!!!!!!!!!! LOADED" );
						__.SP.taxonomy.aTerms[ args.sTermSet ] = aResult;
						async.resolve( { oTerms : aResult } );
					}
				} );
				// add the otherway around
			}
		}
	} );
};

// __.SP.taxonomy.children( { idTermSet : O$C3.Tax.guidTermSet.MainCategory, idParent : "13a5103e-ee20-44ce-a164-35943e9df08e" } )
__.SP.taxonomy.children = function( args ) { // idTermSet, idParent
	var oStore = __.SP.taxonomy.aTerms[ args.idTermSet ];
	var l = [];
	var add = function( id ) {
		if( id != args.idParent ) {
			l.push( id );
		}
		var lid = oStore.aChildren[ id ];
		if( lid ) {
			lid.forEach( function( id ) {
				add( id );
			} );
		}
		return l;
	}
	var lid = add( args.idParent );
	return lid;
};

//__.SP.taxonomy.addTerm( { lsTerms : [ "Neverland", "Oz" ] ,  sTermSet : O$C3.Tax.guidTermSet.Country } )
__.SP.taxonomy.addTerm = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var sTermStore = args.sTermStore || "Managed Metadata Service";
	var oTax = SP.Taxonomy.TaxonomySession.getTaxonomySession( ctx );
	var oStore = oTax.get_termStores().getByName( sTermStore );
	var oSet = oStore.getTermSet( args.sTermSet );
	args.lsTerms.forEach( function( sTerm ) {
		oSet.createTerm( sTerm, 1033, SP.Guid.newGuid().toString() );
	} );
	ctx.load( oSet );
	__.SP.exec( ctx, oSet, function( oSet ) {
		console.log( oSet );
		if( oSet.sError ) {
			async.reject( oSet.sError );
		}
		else {
			async.resolve();
		}
	} );
}

__.SP.taxonomy.search = function( args ) {
};

__.SP.taxonomy.search = function( args ) {
};

__.SP.user = {
	/**
	 * Stores user info for consequtive calls to current()
	 */
	  aInfo : null
	/** 
	 * Gets info from currently logged user
	 */
	, current : function( args ) {
		var that = this;
		var async = __.Async.promise( args );
		if( this.aInfo ) {
			async.resolve( { aUserInfo : this.aInfo } );
			return;
		}

SP.SOD.executeFunc('SP.js', 'SP.ClientContext', function() {
   SP.SOD.executeFunc('userprofile', 'SP.UserProfiles.PeopleManager', function() {
		var ctx = __.SP.ctx();
		var oUser = ctx.get_web().get_currentUser();
		var oGroups = oUser.get_groups();
		ctx.load( oUser );
		ctx.load( oGroups );
		__.SP.exec( ctx, [ oUser, oGroups ], function( lo ) {
			var oUser = lo[ 0 ];
			var oGroups = lo[ 1 ];
			if( oUser.sError ) {
				async.resolve( "Could not load user info", oUser );
			}
			else if( oGroups.sError ) {
				async.resolve( "Could not load users group info", oGroups );
			}
			else {
				that.aInfo = {
					  id : oUser.get_id()
					, sLogin : oUser.get_loginName()
					, mail : oUser.get_email()
					, bAdmin : oUser.get_isSiteAdmin()
					, lsGroups : []
				}
				var loGroups = oGroups.getEnumerator();
				while( loGroups.moveNext() ) {
					var oGroup= loGroups.get_current();
					that.aInfo.lsGroups.push( oGroup.get_title() );
				}
				async.resolve( { aUserInfo : that.aInfo } );
			}
		} );

	})
})
	}
};
__.SP.view = {};
// __.SP.view.list( { sList:"OSCE Contacts"} );
__.SP.view.list = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	var oViews = oList.get_views();
	ctx.load( oViews );
	__.SP.exec( ctx, oViews, function( oViews ) {
		if( oViews.sError ) {
			async.reject( oViews.sError );
		}
		else {
			var lsViews = [];
			var loView = oViews.getEnumerator();
			while( loView.moveNext() ) {
				var oView = loView.get_current();
				lsViews.push( oView.get_title() );
			}
			async.resolve( { lsViews : lsViews } );
		}
	} );
}

// __.SP.view.read( { sList : "OSCE Contacts", sView : "OSG Contacts" } );
// sends back guid, fields, url, rows, query
__.SP.view.read = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	var oView = oList.get_views().getByTitle( args.sView );
	var oFields = oView.get_viewFields();
	ctx.load( oView );
	ctx.load( oFields );
	__.SP.exec( ctx, oView, function( oView ) {
		if( oView.sError ) {
			async.reject( oView.sError );
		}
		else {
			var lsFields = [];
			var oFields = oView.get_viewFields();
			for( var ix=0; ix<oFields.get_count(); ix++ ) {
				var sField = oFields.getItemAtIndex( ix );
				lsFields.push( sField );
			}
			var sTotal = null;
			if( oView.get_aggregationsStatus() == "On" ) {
				var sAggregations = oView.get_aggregations();
				var lsParts = sAggregations.match( /Name="(.+?)"/ );
				if( lsParts && lsParts[ 1 ] ) {
					sTotal = lsParts[ 1 ];
				}
			}
			var kv = {
				  guid : oView.get_id().toString()
				, lsFields : lsFields
				, urlJSLink : oView.get_jsLink()
				, nRows : oView.get_rowLimit()
				, bPaging : oView.get_paged()
				, sTotal : sTotal
				, xmlQuery : oView.get_viewQuery()
			};
			console.log( kv );
			async.resolve( { kv : kv } );
		}
	} );
}

// __.SP.view.deleteFields( { sList : "OSCE Contacts", sView : "All contacts", lsFields : ["Company"] } );
__.SP.view.deleteFields = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	var oView = oList.get_views().getByTitle( args.sView );
	var oFields = oView.get_viewFields();
	ctx.load( oView );
	ctx.load( oFields );
	__.SP.exec( ctx, [ oView, oFields ], function( lo ) {
		var oView = lo[ 0 ];
		var oFields = lo[ 1 ];
		if( lo.sError ) {
			async.reject( lo.sError );
		}
		else {
			for( var ix=0; ix<oFields.get_count(); ix++ ) {
				var sField = oFields.getItemAtIndex( ix );
				var b = __.l.contains( args.lsFields, sField );
				if( b ) {
					oFields.remove( sField );
				}
			}
			oView.update();
			__.SP.exec( ctx, oView, function( o ) {
				if( o.sError ) {
					async.reject( o.sError );
				}
				else {
					async.resolve();
				}
			} );
		}
	} );
}
// __.SP.view.add( { sList:"OSCE Contacts",sView:"test_me",lsFields:["Title","Country","Company"],xmlQuery:'<OrderBy><FieldRef Name="Title" /></OrderBy><Where><Eq><FieldRef Name="FrontOffice" /><Value Type="Text">OCEEA</Value></Eq></Where>'} );
__.SP.view.add = function( args ) { // sList, sView, xmlQuery, bPublic, jsLink, lsFields
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	var oViews = oList.get_views();
	var bPersonal = ( args.bPublic ) ? false : true;
	ctx.load( oViews );
	__.SP.exec( ctx, oViews, function( oViews ) {
		if( oViews.sError ) {
			async.reject( oViews.sError );
		}
		else {
			var oView = new SP.ViewCreationInformation();
			oView.set_title( args.sView );
			oView.set_personalView( bPersonal );
			var oQuery = new SP.CamlQuery();
			oQuery.set_viewXml( args.xmlQuery );
			oView.set_query( oQuery );
			console.log( oView );
			if( args.bDefaultView ) {
				oView.set_setAsDefaultView( true );
			}
			if( args.lsFields ) {
				oView.set_viewFields( args.lsFields );
			}
			if( args.nRows ) {
				oView.set_rowLimit( args.nRows );
			}
			if( args.bPaging ) {
				oView.set_paged( true );
			}
			oViews.add( oView );
			ctx.load( oViews );
			__.SP.exec( ctx, oViews, function( oViews ) {
				if( oViews.sError ) {
					async.reject( oViews.sError );
				}
				else {
					// since we cannot add jsLink on creation (sic!) we
					// need to update after creation
					if( args.jsLink ) {
						var oView = oList.get_views().getByTitle( args.sView );
						oView.set_jsLink( args.jsLink );
						oView.update();
						ctx.load( oView );
						__.SP.exec( ctx, oView, function( oView ) {
							if( oView.sError ) {
								async.reject( oView.sError );
							}
							else {
								if( args.sTotal ) {
									var xmlAggregation = '<FieldRef Name="' + args.sTotal + '" Type="COUNT" />';
									oView.set_aggregations( xmlAggregation );
									oView.set_aggregationsStatus( "On" );
									oView.update();
									ctx.load( oView );
									__.SP.exec( ctx, oView, function( oView ) {
										if( oView.sError ) {
											async.reject( oView.sError );
										}
										else {
											async.resolve();
										}
									} );
								}
								else {
									async.resolve();
								}
							}
						} );
					}
					// otherwise we resolve
					else {
						async.resolve();
					}
				}
			} );
		}
	} );
};

// __.SP.view.del( { sList : "OSCE Contacts", sView : "test_me" } );
__.SP.view.del = function( args ) {
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	var oView = oList.get_views().getByTitle( args.sView );
	oView.deleteObject();
	ctx.load( oView );
	__.SP.exec( ctx, oView, function( oView ) {
		if( oView.sError ) {
			// REF: below error message is thrown eventhough all is deleted.. don't know why
			if( /^Cannot complete this action/.test( oView.sError ) ) {
				async.resolve();
			}
			else {
				async.reject( oView.sError );
			}
		}
		else {
			async.resolve();
		}
	} );
};

// __.SP.view.update({ sList:"OSCE Contacts", sView: "b", jsLink : "~sitecollection/SiteAssets/list_view.js?v=1" } )
__.SP.view.update = function( args ) { // sList, sView, [jsLink], xmlQuery, lsfields, sTotal
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	var oView = oList.get_views().getByTitle( args.sView );
	var oFields = oView.get_viewFields();
	if( args.xmlQuery ) {
		var oQuery = new SP.CamlQuery();
		oQuery.set_viewXml( args.xmlQuery );
		oView.set_viewQuery( oQuery );
	}
	if( args.jsLink ) {
		oView.set_jsLink( args.jsLink );
	}
	if( args.nRows ) {
		oView.set_rowLimit( args.nRows );
	}
	if( args.sTotal ) {
		var xmlAggregation = '<FieldRef Name="' + args.sTotal + '" Type="COUNT" />';
		oView.set_aggregations( xmlAggregation );
		oView.set_aggregationsStatus( "On" );
	}
	oView.update();
	ctx.load( oView );
	ctx.load( oFields );
	__.SP.exec( ctx, oView, function( oView ) {
		if( oView.sError ) {
			async.reject( oView );
		}
		else {
			if( args.lsFields ) {
				var loField = oFields.getEnumerator();
				var lsRemoveFields = [];
				while( loField.moveNext() ) {
					var sField = loField.get_current();
					lsRemoveFields.push( sField );
				}
				lsRemoveFields.forEach( function( s ) {
					oFields.remove( s );
				} );
				args.lsFields.forEach( function( s ) {
					oFields.add( s );
				} );
				oView.update();
				ctx.load( oFields );
				__.SP.exec( ctx, oFields, function( oFields ) {
					if( oView.sError ) {
						async.reject( oFields );
					}
					else {
						async.resolve( oFields );
					}
				} );
			}
			else {
				async.resolve( oView );
			}
		}
	} );
}

// __.SP.view.copy({ sList:"OSCE Contacts", sOldView: "OSG Contacts", sNewView : "xxx" } );
__.SP.view.copy = function( args ) { // sList, sOldView, sNewView
	var async = __.Async.promise( args );
	var ctx = __.SP.ctx();
	var oList = __.SP.list.get( ctx, args.sList );
	var oView = oList.get_views().getByTitle( args.sOldView );
	ctx.load( oView );
	__.SP.exec( ctx, oView, function( oView ) {
		if( oView.sError ) {
			async.reject( oView.sError );
		}
		else {
			var guid = oView.get_id().toString();
			oList.saveAsNewView( guid, args.sNewView, true, args.sNewView + ".aspx");
			var oView = oList.get_views().getByTitle( args.sNewView );
			ctx.load( oView );
			__.SP.exec( ctx, oView, function( oView ) {
				if( oView.sError ) {
					async.reject( oView );
				}
				else {
					async.resolve( oView );
				}
			} );
		}
	} );
}

__.SP.webpart = {
	/** 
	 */
	  settings : function( args ) { // path, ixWP, kv
		var async = __.Async.promise( args );
		var ctx = __.SP.ctx();
		var path = _spPageContextInfo.webServerRelativeUrl + args.path;
		var oFile = ctx.get_web().getFileByServerRelativeUrl( path );
		var oWPM = oFile.getLimitedWebPartManager( SP.WebParts.PersonalizationScope.shared );
		var loWP = oWPM.get_webParts();
		ctx.load( loWP );
		__.SP.exec( ctx, loWP, function( loWP ) {
			if( loWP.sError ) {
				async.reject( loWP.sError );
			}
			else {
				var oDef = null;
				oDef = loWP.get_item( args.ixWP || 0 );
				if( ! oDef ) {
					async.reject( { sError : "No webpart with index: " + args.ixWP } );
				}
				else {
					var oProp = oDef.get_webPart().get_properties();
					ctx.load( oProp );
					__.SP.exec( ctx, oProp, function( oProp ) {
						if( oProp.sError ) {
							async.reject( oProp.sError );
						}
						else {
							for( var k in args.kv ) {
								var v = args.kv[ k ];
								oProp.set_item( k, v );
							}
							oDef.saveWebPartChanges();
							ctx.load( oDef );
							__.SP.exec( ctx, oDef, function( o ) {
								if( o.sError ) {
									async.reject( o.sError );
								}
								else {
									//async.resolve( oProp.get_item( k ) );
									async.resolve();
								}
							} );
						}
					} );
				}
			}
		} );
	}
}
// ==ClosureCompiler==
// @compilation_level ADVANCED_OPTIMIZATIONS
// @js_externs var __; __.SP; __.SP.webservice; __.SP.webservice.call;
// ==/ClosureCompiler==


/**
 * @namespace __.SP.webservice
 * @memberof __.SP
 */

__.SP.webservice = {
	/**
	 * Calls a webservice and handles results
	 * @memberof __.SP.webservice
	 * @method call
	 * @example // standalone
	 * __.SP.webservice.call( {
	 * 	  sService : "midtier"
	 *	, sEndpoint : "MySiteReadList"
	 * 	, oPayload : {
	 *		sList : "MyBookmarks" 		
	 *	}
	 * } );
	 * @param {Object} args a parameter object holding the following values
	 * @param {String} args.sService name of the webservice which is looked up in the O$C3.Url mapping object.
	 * @param {String} args.sEndpoint name of the endpoint
	 * @param {String} [args.sMethod] HTTP method (default is "POST")
	 * @param {Object} [args.oPayload] Object holding parameters as key value pairs 
	 * @param {Object} [args.aHeaders] Object holding custom HTTP headers as key value pairs 
	 * @param {Number} [args.msTimeout] Timeout in millisecons (default is 20 seconds)
	 * @param {Boolean} [args.bIgnoreFailure] Flag to indicate we are not interested in error handling.
	 * @returns {Object} Resolved promise holding the following values 
	 * <pre class='return-object'>
	 * (resolved) oResponse | (Object) | XMLHTTP response object 
	 * (rejected) sError | (String) | error message
	 * (rejected) [sInfo] | (String) | additional information
	 * </pre>
	 */
	  call : function( args ) {
		var async = __.Async.promise( args );
		var that = this;
		var sPayload = __.o.s( args.oPayload );
		var sMethod = args.sMethod || "POST";
		var oAjax = window.XMLHttpRequest ?
			new XMLHttpRequest() :
			new ActiveXObject( 'Microsoft.XMLHTTP' );
		var url = O$C3.Urls.get( args.sService ) + args.sEndpoint + "?";
		oAjax.open( sMethod, url, true );
		oAjax.withCredentials = true;
		oAjax.onreadystatechange = function() {
			var fnerr = function( oAjax, sError ) {
				var sInfo = escape( oAjax.response );
				var sError = "Error reported: " + ( oAjax.statusText );
				var oResponse = __.s.o( oAjax.response );
				if( oResponse && oResponse.Message ) {
					sError = oResponse.Message;
				}
				if( args.bIgnoreFailure ) {
					async.stop();
				}
				else {
					async.reject( sError, sInfo );
				}
			};
			if( oAjax.readyState === 4 ) {
				// the error below is triggered by SharePoint in 				// case an internal Ajax request is cancelled,
				// e.g. by navigating away from a page before
				// a result was delivered. We can savely ignore.
				if( /Unexpected response from server. The status code of response is '0'/.test( oAjax.responseText ) ) {
					console.warn( "INFO: AJAX ABORTED" );
					async.stop();
				}
				else if( oAjax.status == 0 ) {
					fnerr( oAjax, "Could not connect to: " + ( args.sService.toUpperCase() ) );
				}
				else if( oAjax.status < 400  ) {
					async.resolve( { oResponse : oAjax } );
				}
				else if( oAjax.status == 401  ) {
					fnerr( oAjax, "Access denied to: " + ( args.sService.toUpperCase() ) );
				}
				else {
					fnerr( oAjax );
				}
			}
		}
		oAjax.setRequestHeader( "Accept", "application/json" );
		oAjax.setRequestHeader( "Content-Type", "application/json; charset=UTF-8;" );
		oAjax.setRequestHeader( "X-Requested-With", "XMLHttpRequest" );
		// apply custom headers
		if( args.aHeaders ) {
			for( var k in args.aHeaders ) {
				var v = this.aHeaders[ k ];
				oAjax.setRequestHeader( k, v );
			}
		}
		oAjax.timeout = args.msTimeout || 20000;
		oAjax.send( sPayload );
	}
};

