<html>
<script>
if( /\?min/.test( self.location.href ) ) {
	document.write( '<sc'+'ript src="__.async.min.js"></sc'+'ript>' );
}
else {
	document.write( '<sc'+'ript src="__.async.js"></sc'+'ript>' );
}
</script>


<body>
<h3>Unit tests for __.Async.js</h3>
<div id="output"></div>
<script>

// Async
window.name = "doing";
msw1 = 40;
msw2 = 20;
waiter = function( args ) {
	var async = __.Async.promise( args );
	var ms = Math.round( Math.random() * msw1 );
	setTimeout( function() {
		var aResult = args && args.aResult;
		if( ! aResult ) {
			aResult = []
		}
		var s = ( args && args.x ) ? args.x : "_";
		if( s == "error" ) {
			async.reject( { sError: "an error happend" } );
		}
		else {
			aResult.push( "w" + s );
			async.resolve( { aResult : aResult} );
		}
	}, ms );
}
waiter2 = function( args ) {
	var async = __.Async.promise( args );
	var ms = Math.round( Math.random() * msw2 );
	setTimeout( function() {
		var aResult = args && args.aResult;
		if( ! aResult ) {
			aResult = []
		}
		var s = ( args && args.x ) ? args.x : "_";
		aResult.push( "w2" + s );
		async.resolve( { aResult : aResult} );
	}, ms );
}
fnStatus=function( args ){}

assert = function( s, o1, o2 ) {
	var dn = document.getElementById( "output" );
	if( JSON.stringify( o1 ) == JSON.stringify( o2 ) ) {
		s = 'OK: ' + s;
	} else {
		s = 'ERR: ' + s + " (check console)";
		console.warn( 'ERR: ' + s );
		console.warn( o1 );
		console.warn( o2 );
	}
	dn.innerHTML += s + "<br>";
}

// error async
Error = new __.Async({
	fnerr : function( oError ) {
		assert( "error message", 'label:[Async1] file:[na] task:[error2] args:({"__guid_async__":"Async1","x":"error","aResult":["w1"]}) xError:({"sError":"an error happend"})', oError.sStack );
	}
})
.then( this, "waiter", { x : 1 }, "error1" )
.then( this, "waiter", { x : "error" }, "error2" )
.then( this, "waiter", { x : 1 }, "error3" )
.then( this, "waiter", { x : 1 }, "error4" )
.start();

// error async
Error = new __.Async({
	  sLabel : "test error"
	, sFile : "test.async.html:290"
	, fnerr : function( oError ) {
		assert( "error message 2", 'label:[test error] file:[test.async.html:290] task:[error2] args:({"sLabel":"test error","sFile":"test.async.html:290","__guid_async__":"Async2","x":"error","aResult":["w1"]}) xError:({"sError":"an error happend"})', oError.sStack );
	}
})
.then( this, "waiter", { x : 1 }, "error1" )
.then( this, "waiter", { x : "error" }, "error2" )
.then( this, "waiter", { x : 1 }, "error3" )
.then( this, "waiter", { x : 1 }, "error4" )
.start();
o = {
	do : function() {
		var that = this;
		( new __.Async() )
		.then( that, "getRecords", { idUser : 123 }, "Getting records" )
		.then( function( args ) {
			__.Async.promise( args ).resolve();
		}, "Printing records" )
		.start();
	}
	, getRecords : function( args ) {
		setTimeout( function() {
			var hResult = "<b>no records</b>";
			__.Async.promise( args ).resolve( { hResult: hResult } );
		}, 2000 ); 
	}
}
o.do()

var a1 = new __.Async( { fnstat : fnStatus } )
.then( this, "waiter", { x : 4 }, "a1.1" )
.then( this, "waiter", "a1.2" )
.wait( function() {
	return window.name == "done";
}, 800, "wait for window name" )
.wait( function() {
	return window.name == "done";
} )
.then( this, "waiter", { x : 6 }, "a1.3" )
.then( this, "waiter", { x : 2 }, "a1.4" )
.then( function( args ) {
	var async = __.Async.promise( args );
	[1,2,3].forEach( function( n ) {
		async.then( this, "waiter", { x : n }, "a1.5." + n )
	} );
	async.resolve();
}, "a1.5" )
.then( this, "waiter", { x : 6 }, "a1.6" )
.then( this, "waiter", { x : 2 }, "a1.7" )
.then( function( args ) {
	assert( "wait and creation in loop", ["w4","w4","w6","w2","w1","w2","w3","w6","w2"], args.aResult );
	__.Async.promise( args ).resolve();
}, "last msg" )
.start();


var a2 = new __.Async()
.then( this, "waiter2", "a2.1" )
.then( this, "waiter2", "a2.2" )
.then( this, "waiter2", { x : 20 }, "a2.3" )
.then( this, "waiter2", "a2.4" )
.then( this, "waiter2", "a2.4" )
.pause( 400 )
.then( function( args ) {
	window.name = "done";
	__.Async.promise( args ).resolve();
}, "set window name" )
.then( this, "waiter2", "a2.4" )
.then( function( args ) {
	assert( "simple with wait condition", ["w2_","w2_","w220","w220","w220","w220"], args.aResult );
	__.Async.promise( args ).resolve();
}, "first last statement" )
.clear()
.then( this, "waiter2", "a2.5" )
.then( function( args ) {
	assert( "anonymous function as last task", [ "w2_" ], args.aResult );
	__.Async.promise( args ).resolve();
}, "last statement" )
.start()

var mixed = new __.Async()
.then( this, "waiter", "mixed.1"  )
.clear()
.then( this, "waiter", "mixed.1"  )
.then( this, "waiter", "mixed.1"  )
.then( this, "waiter2", "mixed.2"  )
.then( function( args ) {
	var async = __.Async.promise( args );
	async.then( this, "waiter2", "mixed.3"  )
	async.resolve();
} )
.then( this, "waiter", "mixed.4"  )
.then( function( args ) {
	assert( "mixed functions", ["w_","w_","w2_","w2_","w_"], args.aResult );
	__.Async.promise( args ).resolve();
} )
.start()

//  test with objects
obj = {
	  owaiter : function( args ) {
		var async = __.Async.promise( args );
		var ms = Math.round( Math.random() * 300 );
		setTimeout( function() {
			var aResult = args && args.aResult;
			if( ! aResult ) {
				aResult = []
			}
			var s = ( args && args.x ) ? args.x : "_";
			aResult.push( "ow" + s );
			async.resolve( { aResult : aResult} );
		}, ms );
	}
	, owaiter2 : function( args ) {
		var async = __.Async.promise( args );
		var ms = Math.round( Math.random() * 10 );
		setTimeout( function() {
			var aResult = args && args.aResult;
			if( ! aResult ) {
				aResult = []
			}
			var s = ( args && args.x ) ? args.x : "_";
			aResult.push( "ow2" + s );
			async.resolve( { aResult : aResult} );
		}, ms );
	}
	, first : function( cbfn ) {
		var that = this;
		( new __.Async() )
		.then( this, "owaiter2", "ofirst.1"  )	
		.then( this, "owaiter2", "ofirst.2"  )	
		.then( function( args ) {
			var async = __.Async.promise( args );
			async.then( that, "owaiter2", "ofirst.3"  );
			async.resolve();
		} )
		.then( function( args ) {
			assert( "object nested", ["ow2_","ow2_","ow2_"], args.aResult );
			__.Async.promise( args ).resolve();
			cbfn();
		} )
		.start();
	}
	, init : function() {
		var that = this;
		this.first( function() {
			( new __.Async() )
			.then( that, "owaiter", "oinit.1"  )	
			.then( that, "owaiter", "oinit.2" )	
			.then( that, "owaiter", "oinit.3" )	
			.then( function( args ) {
				assert( "inner object nested", ["ow_","ow_","ow_"], args.aResult );
				__.Async.promise( args ).resolve();
			} )
			.start();
		} );	
	}
};
obj.init();

// deeply nested
var laster = function( args ) {
	var async = __.Async.promise( args );
	async.then( function( args ) {
		var async = __.Async.promise( args );
		async.then( self, "waiter", { x : 341 }, "LASTER1" )
		async.then( self, "waiter", { x : 342 }, "LASTER1" )
		async.then( self, "waiter", { x : 343 }, "LASTER1" )
		async.resolve();	
	}, "LASTER0" )
	async.then( self, "waiter", { x : 4 }, "LASTER1" )
	async.then( self, "waiter", { x : 5 }, "LASTER2" )
	async.resolve();
}
var taxer = function( args ) {
	var async = __.Async.promise( args );
	async.then( self, "waiter", { x : 3 }, "TAXER1" )
	async.then( self, "laster", "TAXER -> LAST" )
	async.then( self, "waiter", { x : 6 }, "TAXER2" )
	async.resolve();
}
var cache = function( args ) {
	var async = __.Async.promise( args );
	async.then( self, "waiter", { x : 2 }, "CACHE7" )
	async.then( self, "taxer", "CACHE -> TAX" )
	async.then( self, "waiter", { x : 7 }, "CACHE77" )
	async.then( self, "waiter", { x : 8 }, "CACHE777" )
	async.resolve();
};
Schacht = new __.Async();
Schacht.then( this, "waiter", { x : 1 } ,"schacht1" )
.then( this, "cache", "schacht3" )
.then( this, "waiter", { x : 9 }, "schacht4" )
.then( function( args ) {
	assert( "deeply nested", ["w1","w2","w3","w341","w342","w343","w4","w5","w6","w7","w8","w9"], args.aResult );
	__.Async.promise( args ).resolve();
} )
.start();

// last late arrival 
LastLate = new __.Async()
.then( this, "waiter", { x : 1 } ,"ll1" )
.then( this, "waiter", { x : 2 }, "ll2" )
.then( function( args ) {
	var async = __.Async.promise( args )
	async.then( self, "waiter", { x : 3 }, "ll3.1" )
	async.then( self, "waiter", { x : 4 }, "ll3.2" )
	async.then( self, "waiter", { x : 5 }, "ll3.3" )
	async.then( self, "waiter", { x : 6 }, "ll3.4" )
	async.resolve();
}, "ll3" )
.then( this, "waiter", { x : 7 } ,"ll3" )
.then( this, "waiter", { x : 8 }, "ll4" )
.then( function( args ) {
	assert( "late arrivals", ["w1", "w2", "w3", "w4", "w5", "w6", "w7", "w8"], args.aResult );
	__.Async.promise( args ).resolve();
} )
.start();

// stop async
Stop = new __.Async()
.then( this, "waiter", { x : 1 } ,"stop1" )
.then( function( args ) {
	__.Async.promise( args ).stop();
	setTimeout( function() {
		assert( "stop tasks", [ "w1" ], args.aResult );
		
	}, 1000 );
}, "stop2" )
.then( this, "waiter", { x : 1 } ,"stop3" )
.then( this, "waiter", { x : 1 } ,"stop4" )
.start();

// async call w/o promise

var noprom = function( args ) {
	var async = __.Async.promise( args );
	async.then( function( args ) {
		var async = __.Async.promise( args );
		async.then( self, "waiter", { x : 341 }, "LASTER1" )
		async.then( self, "waiter", { x : 342 }, "LASTER2" )
		async.then( self, "waiter", { x : 343 }, "LASTER3" )
		async.resolve();	
	}, "LASTER0" )
	async.then( self, "waiter", { x : 4 }, "LASTER4" )
	async.then( self, "waiter", { x : 5 }, "LASTER2" )
	async.then( function( args ) {
		__.Async.promise( args ).resolve();
		assert( "no promise object", ["w341","w342","w343","w4","w5"], args.aResult );
	} );
	async.resolve();
}
noprom();

( new __.Async() )
.then( "noprom" )
.then( function( args ) {
	__.Async.promise( args ).resolve();
	assert( "no promise object with promise", ["w341","w342","w343","w4","w5"], args.aResult );
} )
.start();
// test pass on args
var argstest = function( args ) {
	var async = __.Async.promise( args );
	console.log( args );
	args.aResult.push( "|" + args.y + "|" );
	if( ! args.laTest ) {
		args.laTest = [];
	}
	args.laTest.push( { "a" : [ args.y, "@" + args.y ] } )
	async.resolve()
};
( new __.Async() )
.then( self, "waiter", { x : 1}, "args1" )
.then( self, "waiter", { x : 2 }, "args2" )
.then( self, "waiter", { x : 3 }, "args3" )
.then( function( args ) {
	__.Async.promise( args ).resolve();

}, "args4" )
.then( self, "argstest", { y : { arg : "x" } }, "args5!!" )
.then( self, "waiter", { x : 4}, "args6" )
.then( self, "waiter", { x : 5 }, "args7" )
.then( self, "argstest", { y : { arg : "laTest.0.a.1" } }, "args8!!" )
.then( function( args ) {
	__.Async.promise( args ).resolve();
	assert( "late come args 1", ["w1","w2","w3","|3|","w4","w5","|@3|"], args.aResult );
	assert( "late come args 2", [ {"a":[3, "@3"]},{"a":["@3","@@3"]}], args.laTest );
} )
.start();

// then arguments handling
func = function( args ) {
	var async = __.Async.promise( args );
	var sMsg = args.sMsg || "na";
	async.resolve( args );
};
( new __.Async() )
.then( self, "func", { sMsg : "one" }, "args2_1" )
.then( self, "func", "args2_2" )
.then( self, "func", { sMsg : "three" }, "args2_3" )
.then( function( args ) {
	__.Async.promise( args ).resolve();
	assert( "log message", {__guid_async__: "Async14", sMsg: "three"}, args );
}, "args2_4" )
.start();

// test standalone
getKey = function( args ) {
	var async = __.Async.promise( args );
	setTimeout( function() {
		var async = __.Async.promise( args );
		async.resolve( { "key" : "$ecretke!" + args.salt } );
	}, 100 );
	//async.resolve();
};

( new __.Async() )
.then( self, "getKey", { salt : "X" }, "key_1" )
.then( function( args ) {
	__.Async.promise( args ).resolve();
	assert( "standalone_in_async", "$ecretke!X", args.key );
}, "key_result" )
.start();

getKey( { salt : "Y"
	, cb : function( args ) {
		assert( "standalone", "$ecretke!Y", args.key );
	}
} );
getKey( { salt : "Z" } );

</script>

</body>
</html>
