"undefined"==typeof __&&(__={});__.Async=function(a){var b="Async"+ ++__.Async.ix;a=a||{};a.__guid_async__=b;return __.Async.store[b]=new __.Async.Promise(a)};__.Async.ix=0;__.Async.store={};__.Async.fnerr=function(a,b){console.log("[error]",a,b)};__.Async.fnstat=function(){};__.Async.promise=function(a){var b=null;"object"==typeof a&&a.__guid_async__?b=__.Async.store[a.__guid_async__]:(b=new __.Async,b.j=a&&a.cb?a.cb:function(a){console.log(a)});b.i=!0;return b};
__.Async.Promise=function(a){this.__guid_async__=a.__guid_async__;this._args={__guid_async__:this.__guid_async__};this.a=[];this.h=!1;this.ctx=a&&a.ctx?a.ctx:window;this.id=a&&a.id?a.id:this.__guid_async__;this.sdftError=a&&a.sdftError?a.sdftError:"";this.fnerr=a&&a.fnerr?a.fnerr:__.Async.fnerr;this.fnstat=a&&a.fnstat?a.fnstat:__.Async.fnstat;return this};
__.Async.Promise.prototype={g:0,ix:0,i:!1,debug:function(){this.h=!0;return this},clear:function(){var a=this;f(this,{ctx:this.ctx,c:function(){a._args={__guid_async__:a.__guid_async__};a.resolve()},f:{}});return this},pause:function(a,b){var c=this;f(this,{ctx:this.ctx,c:function(){setTimeout(function(){c.resolve()},a)},f:{},b:b||"pause"});return this},wait:function(a,b,c){var d=this,e="number"==typeof b?b:25;f(this,{ctx:this.ctx,c:function(){function b(){a()?d.resolve():setTimeout(b,e)}b()},f:{},
b:"string"==typeof b?b:c?c:"wait"});return this},parallel:function(a,b){var c=this._args;this.then(function(){var b=__.Async.promise(c),e=a.length;a.forEach(function(a){a.then(function(d){delete d.__guid_async__;for(var g in d)c[g]=d[g];0==--e&&b.resolve();a.resolve()},"done");a.start()})},b||"");return this},then:function(a,b,c,d){f(this,{ctx:"object"==typeof a?a:this.ctx,c:"object"==typeof a?b:a,f:"string"==typeof b?"object"==typeof c?c:{}:b?b:{},b:"object"==typeof c?d:"string"==typeof c?c:"string"==
typeof b?b:""});return this},_next:function(){var a=this.a.shift();this.m=a.b;this.ix++;h(this,a.b);for(var b in a.f){var c=a.f[b];if("object"==typeof c&&c&&c.arg){var d=c.arg.split(".");c=this._args;d.forEach(function(a){c=c[a]})}this._args[b]=c}if("string"==typeof a.c)a.ctx[a.c](this._args);else a.c.call(a.ctx,this._args)},start:function(){this._next();return this},resolve:function(a){this.i=!1;this.a.forEach(function(a){a.l=!1});for(var b in a)this._args[b]=a[b];0<this.a.length?this._next():(this.h||
delete __.Async.store[this.__guid_async__],this.j&&this.j(a))},stop:function(){this.h||delete __.Async.store[this.__guid_async__]},reject:function(a){function b(a){try{return a?JSON.stringify(a):"na"}catch(e){return"could not stringify"}}a="string"==typeof a?a:"object"==typeof a?a.sError?a.sError:"A task was rejected":"A task was rejected";var c="id:("+this.id+") ";c+="task:("+this.m+") ";c+="args:("+b(this._args)+") ";c+="sdftError:("+this.sdftError+") ";c+="sError:("+b(a)+") ";a={ix:this.ix,id:this.id,
sErrorTask:this.m,args:this._args,sdftError:this.sdftError,sError:a,sStack:c};this.fnerr&&this.fnerr(a)}};function h(a,b){var c=a.fnstat;a.h&&(c=function(a){console.log(a.__guid_async__+" ("+a.ix+"/"+a.g+") -> "+a.b)});c&&c({__guid_async__:a.__guid_async__,b:b||"",g:a.g,ix:a.ix,o:100*a.ix/a.g})}
function f(a,b){a.g++;b.__guid_async__=a.__guid_async__;if(a.i){b.l=!0;var c=a.a.length;if(c){for(var d=0;d<c;d++){var e=!1;if(!a.a[d].l){e=!0;a.a.splice(d,0,b);break}}e||a.a.push(b)}else a.a.push(b)}else a.a.push(b)};
