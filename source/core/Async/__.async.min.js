"undefined"==typeof __&&(__={});__.Async=function(a){var b="Async"+ ++__.Async.ix;a=a||{};a.__guid_async__=b;return __.Async.store[b]=new __.Async.Promise(a)};__.Async.ix=0;__.Async.store={};__.Async.fnerr=function(a,b){console.log("[error]",a,b)};__.Async.fnstat=function(){};__.Async.promise=function(a){var b=null;"object"==typeof a&&a.__guid_async__?b=__.Async.store[a.__guid_async__]:(b=new __.Async,b.__cb__=a&&a.cb?a.cb:function(a){console.log(a)});b.bLateArrivals=!0;return b};
__.Async.Promise=function(a){this.__guid_async__=a.__guid_async__;this._sStatus="idle";this._args={__guid_async__:this.__guid_async__};this._loTasks=[];this._bDebug=!1;this.ctx=a&&a.ctx?a.ctx:window;this.id=a&&a.id?a.id:this.__guid_async__;this.sdftError=a&&a.sdftError?a.sdftError:"";this.fnerr=a&&a.fnerr?a.fnerr:__.Async.fnerr;this.fnstat=a&&a.fnstat?a.fnstat:__.Async.fnstat;return this};
__.Async.Promise.prototype={c:0,ix:0,bLateArrivals:!1,debug:function(){this._bDebug=!0;return this},clear:function(){var a=this;this._add({ctx:this.ctx,sfn:function(){a._args={__guid_async__:a.__guid_async__};a.resolve()},args:{}});return this},pause:function(a,b){var c=this;this._add({ctx:this.ctx,sfn:function(){setTimeout(function(){c.resolve()},a)},args:{},sMsg:b||"pause"});return this},wait:function(a,b,c){var d=this,e="number"==typeof b?b:25;this._add({ctx:this.ctx,sfn:function(){var b=function(){a()?
d.resolve():setTimeout(b,e)};b()},args:{},sMsg:"string"==typeof b?b:c?c:"wait"});return this},parallel:function(a,b){var c=this._args;this.then(function(){var b=__.Async.promise(c),e=a.length;a.forEach(function(a){a.then(function(d){delete d.__guid_async__;for(var f in d)c[f]=d[f];0==--e&&b.resolve();a.resolve()},"done");a.start()})},b||"");return this},then:function(a,b,c,d){this._add({ctx:"object"==typeof a?a:this.ctx,sfn:"object"==typeof a?b:a,args:"string"==typeof b?"object"==typeof c?c:{}:b?
b:{},sMsg:"object"==typeof c?d:"string"==typeof c?c:"string"==typeof b?b:""});return this},_add:function(a){this.c++;a.__guid_async__=this.__guid_async__;if(this.bLateArrivals){a.bLateArrival=!0;var b=this._loTasks.length;if(b){for(var c=0;c<b;c++){var d=!1;if(!this._loTasks[c].bLateArrival){d=!0;this._loTasks.splice(c,0,a);break}}d||this._loTasks.push(a)}else this._loTasks.push(a)}else this._loTasks.push(a)},_stats:function(a){var b=this.fnstat;this._bDebug&&(b=function(a){console.log(a.__guid_async__+
" ("+a.ix+"/"+a.c+") -> "+a.sMsg)});b&&b({__guid_async__:this.__guid_async__,sMsg:a||"",c:this.c,ix:this.ix,pct:100*this.ix/this.c})},_next:function(){var a=this._loTasks.shift();this.scurMsg=a.sMsg;this.ix++;this._stats(a.sMsg);for(var b in a.args){var c=a.args[b];if("object"==typeof c&&c&&c.arg){var d=c.arg.split(".");c=this._args;d.forEach(function(a){c=c[a]})}this._args[b]=c}if("string"==typeof a.sfn)a.ctx[a.sfn](this._args);else a.sfn.call(a.ctx,this._args)},start:function(){this._sStatus="pending";
this._next();return this},resolve:function(a){this.bLateArrivals=!1;this._loTasks.forEach(function(a){a.bLateArrival=!1});for(var b in a)this._args[b]=a[b];0<this._loTasks.length?this._next():(this._sStatus="idle",this._cleanUp(),this.__cb__&&this.__cb__(a))},stop:function(){this._cleanUp()},reject:function(a){var b=function(a){try{return a?JSON.stringify(a):"na"}catch(e){return"could not stringify"}};this._sStatus="error";a="string"==typeof a?a:"object"==typeof a?a.sError?a.sError:"A task was rejected":
"A task was rejected";var c="id:("+this.id+") ";c+="task:("+this.scurMsg+") ";c+="args:("+b(this._args)+") ";c+="sdftError:("+this.sdftError+") ";c+="sError:("+b(a)+") ";b={ix:this.ix,id:this.id,sErrorTask:this.scurMsg,args:this._args,sdftError:this.sdftError,sError:a,sStack:c};this.fnerr&&this.fnerr(b)},_cleanUp:function(){this._bDebug||delete __.Async.store[this.__guid_async__]}};
