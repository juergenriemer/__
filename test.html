<html>
<!--script src="D:\jriemer\GitHub\__\__.js"></script-->
<script src="__.js"></script>
<body>
<style>
.-pb
	{
	border:			1px solid steelblue;
	background-color:	#b6cee2;
	height:			20px;
	position:		relative;
	z-index:		777;
	}

.-pb p
	{
	background:		transparent;
	z-index:		888;
	line-height:		20px;
	margin:0;
	text-align : center;
	color:			white;
	position:		relative;
	}

.-pb div
	{
	z-index:		777;
	background:		steelblue;
	height:			100%;
	position:		absolute;
	top:			0;
	}
</style>
<div class='-pb'>
	<p></p>
	<div></div>
</div>
<div id="menu">
	<ul>
		<li><a href="#one">one</a></li>
		<li><a href="#two">two</a></li>
		<li><a href="#three">three</a></li>
		<li><a href="#four">four</a></li>
	</ul>
	<div id="footer">
		<a class="footer" href="#red">red</a> | 
		<a class="footer" href="#green">green</a> | 
		<a class="footer" href="#blue">blue</a>
	</div>
</div>
<div id="feedback">
	<div class="the-heading">
		<h3>Feedback</h3>
	</div>
	<div class="the-form">
		<form>
			<input type="text" name="login" />
			<br />
			<input type="text" name="email" />
			<br />
			<textarea name="comment"></textarea>
			<br />
			<button>Send</button>
		</form>
	</div>
</div>
<div id="one">one</div>
<div id="two">two</div>
<img id="js" src="file:///Users/juergenriemer/Documents/GitHub/__2/__.js"></img>
</body>
</html>
<script>

var url = "file:///Users/juergenriemer/Documents/GitHub/__2/__.js"
__.dn.add( "<iframe id='xxx' src='" + url + "'></iframe>" );
setTimeout( function() {
var dnFrame = __.dn_( "#xxx" );
var dnFrameDoc = dnFrame.contentDocument || dnFrame.contentWindow.document;
console.log( 'xxx' );
console.log( dnFrameDoc );
console.log( dnFrameDoc.innerHTML );
}, 2000 );
loadLib = function() {
	var url = "file:///Users/juergenriemer/Documents/GitHub/__2/__.js"
	var oAjax = window.XMLHttpRequest ?
		new XMLHttpRequest() :
		new ActiveXObject( 'Microsoft.XMLHTTP' );
	oAjax.open( 'GET', url );
	oAjax.onreadystatechange = function() {
		if( oAjax.readyState === 4 ) {
			console.log( oAjax );	
		}
	}
	oAjax.send();
}
//loadLib();

var dnMenu = __.dn_( "#menu" );
var ldnLinks = __.dn_( "a.footer", dnMenu );
__.dn_( "a.footer", dnMenu, function( dn, ix ) {
      dn.style.color = "red";
      dn.style.border = ix + "px solid green";
 } );
__.dn_( "[href]", function( dn ) {
      dn.setAttribute( "title", dn.getAttribute( "href" ) );
 } );

var dnInput = __.dn_( "[name='email']" );
var dnForm = __._dn( "form", dnInput );
__._dn( "div.the-form", dnInput, function( dn ) {
    dn.style.border = "1px solid red";
    dn.style.padding = "1em";
} );

var ls = [ "one", "two", "three" ];
__.each( ls, function( s, ix ) {
    console.log( ix + ". " + s ); 
} );
var dn1 = __.dn_( "[href='#one']" );
var dn2 = __.dn_( "[href='#two']" );
var dn3 = __.dn_( "[href='#three']" );
var ldn = [ dn1, dn2, dn3 ];
__.each( ldn, function( dn ) {
    dn.style.color = "red";
} );
__.each( dn1, function( dn ) {
    dn.style.color = "pink";
} );

var dn1 = __.dn_( "#one" );
var dn2 = __.dn_( "#two" );
__.dn._move( dn2, dn1 );


var dnUL = __.dn_( "ul" );
var dnLI = __.dn_( "li:nth-child(1)" );
__.dn.move( dnLI, dnUL );


var dnLI4 = __.dn_( "li:nth-child( 4 )" );
var dnLI1 = __.dn_( "li:nth-child( 1 )" );
__.dn.move_( dnLI1, dnLI4 );

var dnUL = __.dn.add( "<ul class='colors'></ul>" );
var h = "<li>red</li>";
var lnLI = __.dn.add( h, dnUL );
var h = "<li>red</li>";
var lnLI = __.dn.add( h, dnUL, function( dn, ix ) {
    dn.style.color = dn.textContent;
    dn.textContent = ix + ". " + dn.textContent;
} );

var dnLogin = __.dn_( "[name='login']" );
var h = "<div>At least 8 characters</div>";
var dnRule = __.dn._add( h, dnLogin );

var dnComment = __.dn_( "[name='comment']" );
var h = "<a href='#clear'>clear</a>";
var dnRule = __.dn.add_( h, dnComment );

var dnForm = __.dn_( "form" );
__.dn.del( dnForm );

__.dn_( "[name='comment']" )

__.dn.move(
	  __.dn_( "a" )
	, __._dn( "div", __.dn_( ".the-form") )
	, function( dn, ix ) {
		console.log( ix );
		dn.textContent = "[" + ix + " " + dn.textContent + "]";
		dn.style.background = "#efefef";
	}
)
__.dn.add(
	"<span>x</span><span>x</span><span>x</span><span>x</span>"
	, __._dn( "div", __.dn_( ".the-form") )
	, function( dn, ix ) {
		dn.textContent = "[" + ix + " " + dn.textContent + "]";
		dn.style.background = "#c0c0c0";
	}
)
assert = function( a, b, sfn ) {
	if( __.o.s( a ) == __.o.s( b ) ) {
		console.log( sfn + " OK" );
	}
	else {
		console.log( sfn + " ERR", a, b  );
	}
}
// __.l
var lo = [ { v : 5 }, { v : 11 }, { v : 1 } ];
var loE = [ { v : 1 }, { v : 5 }, { v : 11 } ];
lo = __.l.kSort( lo, "v" );
assert( lo, loE, "__.l.kSort" );


// __.s.tokenize
var s = __.s.tokenize( "Hi 'Mom',\nHi xDad" ); // himom,hidad
var es = "himom,hidad";
assert( s, es, "__.s.tokenize" );

// Async
__.dn.add( "<div id='output' style='border:1px solid red'>output</div>" );
window.name = "doing";

waiter = function( args ) {
	var async = __.async( args );
	var ms = Math.round( Math.random() * 100 );
//ms = 1000
	setTimeout( function() {
		var aResult = args && args.aResult;
		if( ! aResult ) {
			aResult = []
		}
		var s = ( args && args.x ) ? args.x : "_";
		aResult.push( "w" + s );
		async.resolve( { aResult : aResult} );
	}, ms );
}
//waiter();
//waiter( { arg1 : 1 } );
waiter2 = function( args ) {
	var async = __.async( args );
	var ms = Math.round( Math.random() * 200 );
	setTimeout( function() {
		var aResult = args && args.aResult;
		if( ! aResult ) {
			aResult = []
		}
		var s = ( args && args.x ) ? args.x : "_";
		aResult.push( "w2" + s );
		async.resolve( { aResult : aResult} );
	}, ms );
}
fnStatus=function( args ){
	__.dn_( "#output" ).innerHTML += "<br>" + args.guid + " - " + args.sMsg;
	var pct = Math.round( args.ix / args.c * 100 );
	var dnProgress = __.dn_( ".-pb" );
	var dnBar = __.dn_( "div", dnProgress );
	var dnText = __.dn_( "p", dnProgress );
	var dx = __.dn.dx( dnProgress );
	dnText.textContent = args.sMsg || "";
	dnBar.style.width = ( dx / 100 * pct );
}
assert = function( s, o1, o2 ) {
	if( __.l.equal( o1, o2 ) ) {
		console.log( s + ': OK' );
	} else {
		console.log( s + ': ERR' );
		console.log( o1, o2 );
	}
}
o = {
	do : function() {
		var that = this;
		( new __.Async() )
		.then( that, "getRecords", { idUser : 123 }, "Getting records" )
		.then( function( args ) {
			__.dn_( "#output" ).innerHTML = args.hResult;
			__.async( args ).resolve();
		}, "Printing records" )
		.start();
	}
	, getRecords : function( args ) {
		setTimeout( function() {
			var hResult = "<b>no records</b>";
			__.async( args ).resolve( hResult );
		}, 2000 ); 
	}
}
o.do()
var a1 = new __.Async( { fnstat : fnStatus } )
.then( this, "waiter", { x : 4 }, "a1.1" )
.then( this, "waiter", "a1.2" )
.wait( 800, function() {
	return window.name == "done";
}, "wait for window name" )
.then( this, "waiter", { x : 6 }, "a1.3" )
.then( this, "waiter", { x : 2 }, "a1.4" )
.then( function( args ) {
	var async = __.async( args );
	[1,2,3].forEach( function( n ) {
		async.then( this, "waiter", { x : n }, "a1.5." + n )
	} );
	async.resolve();
}, "a1.5" )
.then( this, "waiter", { x : 6 }, "a1.6" )
.then( this, "waiter", { x : 2 }, "a1.7" )
.then( function( args ) {
	assert( "one", ["w4","w4","w6","w2","w1","w2","w3","w6","w2"], args.aResult );
	__.async( args ).resolve();
}, "last msg" )
.start();

// ************

var a2 = new __.Async()
//.debug()
.then( this, "waiter2", "a2.1" )
.then( this, "waiter2", "a2.2" )
.then( this, "waiter2", { x : 20 }, "a2.3" )
.then( this, "waiter2", "a2.4" )
.then( this, "waiter2", "a2.4" )
.wait( 400 )
.then( function( args ) {
	window.name = "done";
	__.async( args ).resolve();
}, "set window name" )
.then( this, "waiter2", "a2.4" )
.then( function( args ) {
	assert( "two", ["w2_","w2_","w220","w220","w220","w220"], args.aResult );
	__.async( args ).resolve();
}, "first last statement" )
.clear()
.then( this, "waiter2", "a2.5" )
.then( function( args ) {
	assert( "two", [ "w2_" ], args.aResult );
	__.async( args ).resolve();
}, "last statement" )
.start()

var mixed = new __.Async()
.then( this, "waiter", "mixed.1"  )
.clear()
.then( this, "waiter", "mixed.1"  )
.then( this, "waiter", "mixed.1"  )
.then( this, "waiter2", "mixed.2"  )
.then( function( args ) {
	var async = __.async( args );
	async.then( this, "waiter2", "mixed.3"  )
	async.resolve();
} )
.then( this, "waiter", "mixed.4"  )
.then( function( args ) {
	assert( "mix", ["w_","w_","w2_","w2_","w_"], args.aResult );
	__.async( args ).resolve();
} )
.start()

// ******** test with objects
obj = {
	  owaiter : function( args ) {
		var async = __.async( args );
		var ms = Math.round( Math.random() * 300 );
		setTimeout( function() {
			var aResult = args && args.aResult;
			if( ! aResult ) {
				aResult = []
			}
			var s = ( args && args.x ) ? args.x : "_";
			aResult.push( "ow" + s );
			async.resolve( { aResult : aResult} );
		}, ms );
	}
	, owaiter2 : function( args ) {
		var async = __.async( args );
		var ms = Math.round( Math.random() * 10 );
		setTimeout( function() {
			var aResult = args && args.aResult;
			if( ! aResult ) {
				aResult = []
			}
			var s = ( args && args.x ) ? args.x : "_";
			aResult.push( "ow2" + s );
			async.resolve( { aResult : aResult} );
		}, ms );
	}
	, first : function( cbfn ) {
		var that = this;
		( new __.Async() )
		.then( this, "owaiter2", "ofirst.1"  )	
		.then( this, "owaiter2", "ofirst.2"  )	
		.then( function( args ) {
			var async = __.async( args );
			async.then( that, "owaiter2", "ofirst.3"  );
			async.resolve();
		} )
		.then( function( args ) {
			assert( "oinner", ["ow2_","ow2_","ow2_"], args.aResult );
			__.async( args ).resolve();
			cbfn();
		} )
		.start();
	}
	, init : function() {
		var that = this;
		this.first( function() {
			( new __.Async() )
			.then( that, "owaiter", "oinit.1"  )	
			.then( that, "owaiter", "oinit.2" )	
			.then( that, "owaiter", "oinit.3" )	
			.then( function( args ) {
				assert( "oinit", ["ow_","ow_","ow_"], args.aResult );
				__.async( args ).resolve();
			} )
			.start();
		} );	
	}
};
obj.init();
// schachtel schacht 
var laster = function( args ) {
	var async = __.async( args );
	async.then( function( args ) {
		var async = __.async( args );
		async.then( self, "waiter", { x : 341 }, "LASTER1" )
		async.then( self, "waiter", { x : 342 }, "LASTER1" )
		async.then( self, "waiter", { x : 343 }, "LASTER1" )
		async.resolve();	
	}, "LASTER0" )
	async.then( self, "waiter", { x : 4 }, "LASTER1" )
	async.then( self, "waiter", { x : 5 }, "LASTER2" )
	async.resolve();
}
var taxer = function( args ) {
	var async = __.async( args );
	async.then( self, "waiter", { x : 3 }, "TAXER1" )
	async.then( self, "laster", "TAXER -> LAST" )
	async.then( self, "waiter", { x : 6 }, "TAXER2" )
	async.resolve();
}
var cache = function( args ) {
	var async = __.async( args );
	async.then( self, "waiter", { x : 2 }, "CACHE7" )
	async.then( self, "taxer", "CACHE -> TAX" )
	async.then( self, "waiter", { x : 7 }, "CACHE77" )
	async.then( self, "waiter", { x : 8 }, "CACHE777" )
	async.resolve();
};
Schacht = new __.Async();
Schacht.then( this, "waiter", { x : 1 } ,"schacht1" )
.then( this, "cache", "schacht3" )
.then( this, "waiter", { x : 9 }, "schacht4" )
.then( function( args ) {
	assert( "schacht", ["w1","w2","w3","w341","w342","w343","w4","w5","w6","w7","w8","w9"], args.aResult );
	__.async( args ).resolve();
} )
.start();

// last late arrival 
LastLate = new __.Async()
LastLate.debug()
.then( this, "waiter", { x : 1 } ,"ll1" )
.then( this, "waiter", { x : 2 }, "ll2" )
.then( function( args ) {
	var async = __.async( args )
	async.then( self, "waiter", { x : 3 }, "ll3.1" )
	async.then( self, "waiter", { x : 4 }, "ll3.2" )
	async.then( self, "waiter", { x : 5 }, "ll3.3" )
	async.then( self, "waiter", { x : 6 }, "ll3.4" )
	async.resolve();
}, "ll3" )
.start();
</script>
